{
  "version": 3,
  "sources": [
    "../../../usr/local/lib/node_modules/ksana-cli/node_modules/browserify/node_modules/browser-pack/_prelude.js",
    "moedict-yu/index.js",
    "moedict-yu/src/api.js",
    "moedict-yu/src/defbox.jsx",
    "moedict-yu/src/main.jsx",
    "moedict-yu/src/overview.jsx",
    "moedict-yu/src/searchbar.jsx",
    "moedict-yu/src/searchhistory.jsx",
    "moedict-yu/src/showtext.jsx",
    "node_modules/ksana-analyzer/configs.js",
    "node_modules/ksana-analyzer/index.js",
    "node_modules/ksana-analyzer/tokenizers.js",
    "node_modules/ksana-database/bsearch.js",
    "node_modules/ksana-database/index.js",
    "node_modules/ksana-database/kde.js",
    "node_modules/ksana-database/listkdb.js",
    "node_modules/ksana-database/platform.js",
    "node_modules/ksana-jsonrom/html5read.js",
    "node_modules/ksana-jsonrom/index.js",
    "node_modules/ksana-jsonrom/kdb.js",
    "node_modules/ksana-jsonrom/kdbfs.js",
    "node_modules/ksana-jsonrom/kdbfs_android.js",
    "node_modules/ksana-jsonrom/kdbfs_ios.js",
    "node_modules/ksana-jsonrom/kdbw.js",
    "node_modules/ksana-search/boolsearch.js",
    "node_modules/ksana-search/bsearch.js",
    "node_modules/ksana-search/excerpt.js",
    "node_modules/ksana-search/index.js",
    "node_modules/ksana-search/plist.js",
    "node_modules/ksana-search/search.js",
    "node_modules/ksana2015-webruntime/checkbrowser.js",
    "node_modules/ksana2015-webruntime/downloader.js",
    "node_modules/ksana2015-webruntime/fileinstaller.js",
    "node_modules/ksana2015-webruntime/html5fs.js",
    "node_modules/ksana2015-webruntime/htmlfs.js",
    "node_modules/ksana2015-webruntime/index.js",
    "node_modules/ksana2015-webruntime/installkdb.js",
    "node_modules/ksana2015-webruntime/kfs.js",
    "node_modules/ksana2015-webruntime/kfs_html5.js",
    "node_modules/ksana2015-webruntime/ksanagap.js",
    "node_modules/ksana2015-webruntime/livereload.js",
    "node_modules/ksana2015-webruntime/liveupdate.js",
    "node_modules/ksana2015-webruntime/mkdirp.js"
  ],
  "names": [],
  "mappings": "AAAA;ACAA;AACA;AACA;AACA;AACA;;ACJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC7CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC5EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC3HA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACxCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AChEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC1CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC/BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACvDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACxJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AClCA;AACA;AACA;AACA;;ACHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC5YA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC9DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC1FA;AACA;AACA;AACA;AACA;;ACJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACvfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACrTA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACjHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACnHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACtcA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC7FA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACjCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACnbA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACtGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACxaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACnkBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC7EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC3GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC5SA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC/GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC/DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACrCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACnDA;AACA;AACA;AACA;AACA;AACA;AACA;;ACNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC9EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACrBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACxJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA",
  "file": "generated.js",
  "sourceRoot": "",
  "sourcesContent": [
    "(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})",
    "var runtime=require(\"ksana2015-webruntime\");\nruntime.boot(\"moedict-yu\",function(){\n\tvar Main=React.createElement(require(\"./src/main.jsx\"));\n\tksana.mainComponent=React.render(Main,document.getElementById(\"main\"));\n});",
    "var indexOfSorted = function (array, obj) { \n    var low = 0,\n    high = array.length-1;\n    while (low < high) {\n      var mid = (low + high) >> 1;\n      array[mid] < obj ? low = mid + 1 : high = mid;\n    }\n    //if(array[low] != obj) return null;\n    return low;\n }\n\nvar search_start = function(array,tofind) {\n    var out=[];\n    var index=indexOfSorted(array,tofind);\n    var i=0;\n    while(array[index+i].indexOf(tofind)==0){\n      out.push([array[index+i],parseInt(index)+i]);\n      i++;\n    }\n    return out;\n}\nvar search_end = function(array,tofind) {\n    var out=[];\n    var i=0;\n    for(var i=0; i<array.length; i++){\n      if(array[i].indexOf(tofind)==array[i].length-1){\n        out.push([array[i],i]);\n      }\n    }\n    return out;\n}\nvar search_middle = function(array,tofind) {\n    var out=[];\n    var i=0;\n    for(var i=0; i<array.length; i++){\n      var ent=array[i];\n      if(ent.indexOf(tofind) >-1 && ent.indexOf(tofind)!=0 && ent.indexOf(tofind)!=ent.length-1){\n        out.push([array[i],i]);\n      }\n    }\n    return out;\n}\n\n var api={search_end:search_end,search_middle:search_middle,search_start:search_start,indexOfSorted:indexOfSorted};\n\nmodule.exports=api;",
    "var debug=true;\nvar Defbox=React.createClass({displayName: \"Defbox\",\n  getInitialState: function() {\n  \treturn {searchResult:[],tofinds:[]};\n  },\n  shouldComponentUpdate: function(nextProps) {\n    if(nextProps.defs != this.props.defs) return true;\n    else return false;\n  },\n  componentWillReceiveProps: function() {\n    $('html, body').scrollTop(0);\n  },\n  dosearch_history: function(e) {\n    var entryIndex=e.target.parentElement.dataset.entry;\n    var vpos=e.target.attributes[0].value;\n    var tofind=e.target.textContent;\n    var next=e.target.nextSibling;\n    var tf=this.state.tofinds;\n    this.setState({vpos:vpos});\n    for(var i=0; i<10; i++){\n      //if(!next || next.textContent.match(/[。，、「」：]/g)) break;  \n      if(!next.textContent) break;  \n      tofind+=next.textContent;\n      next=next.nextSibling;\n    }\n    if(tf.length==0) tf.push(this.state.searchResult[0][0]);\n    tf.push(tofind);\n    if(entryIndex) {\n      this.state.searchResult.map(function(item){\n        item.push(tf[tf.length-2]);\n        item.push(vpos);\n      });\n      this.props.pushHistory(this.state.searchResult,entryIndex);\n    }\n    this.props.dosearch(tofind);\n  },\n  reverseDef: function(d) {\n    if(debug) console.log(\"renderDef:\",new Date());\n    var defs=[];\n    for(var i=0; i<d.length; i++){\n      defs[d.length-i-1]=d[i];\n    }\n    return defs;\n  },\n  tohighlight: function(def) {\n    var out=[];\n    var coloredDef=this.props.highlight(def[0][0],this.props.tofind,def[0][1]);\n    console.log(out);\n    out.push([coloredDef.text,coloredDef.seg]);\n    return out;\n  },\n  render: function() {\n    if(debug) console.log(\"render:\",new Date());\n    var d=this.reverseDef(this.props.defs);//d=[def,entry]\n    if(this.props.searchfield==\"fulltext\") d=this.tohighlight(d);\n    var defs=[];\n    this.state.searchResult=[];\n    if(d.length!=0) {\n      for(var i=0; i<d.length; i++) {\n        var t=d[i][0].split(\"\\n\");\n        var title='<div data-entry=\"'+d[i][1]+'\"><div class=\"title\">'+t[0]+'</div>';\n        defs.push(title);\n        this.state.searchResult.push([t[0],d[i][1]]);\n        for(var j=1; j<t.length; j++) {\n          defs.push(t[j]);\n        }\n        defs.push(\"</div>\")\n      }\n    }\n    if(debug) console.log(\"Finish Def render:\",new Date());\n    return(\n    React.createElement(\"div\", {className: \"defbox\", dangerouslySetInnerHTML: {__html: defs.join(\"<br>\")}, onClick: this.dosearch_history})\n    ); \n\n  }\n});\nmodule.exports=Defbox;",
    "var kse=require(\"ksana-search\");\nvar kde=require(\"ksana-database\");\nvar api=require(\"./api\");\nvar Showtext=require(\"./showtext.jsx\");\nvar Searchbar=require(\"./searchbar.jsx\");\nvar Overview=require(\"./overview.jsx\");\nvar debug=false;\nvar maincomponent = React.createClass({displayName: \"maincomponent\",\n  getInitialState: function() {\n    if(debug) console.log(\"getInitialState:\",new Date());\n    var that=this;\n    kde.open(\"moedict\",function(err,db){\n      var entries=db.get(\"segnames\");\n      that.setState({entries:entries,db:db});\n    });    \n  \treturn {entries:[],result:[\"搜尋結果列表\"],searchfield:\"start\",defs:[],entryIndex:[]};\n  },\n  // componentDidUpdate: function(){\n  //   setTimeout(function(){\n  //       this.setState({renderSplash:true})\n  //     },3000);\n  // },\n  dosearch: function(tofind,field) {\n    var out=[];\n    if(debug) console.log(\"dosearch:\",new Date());\n    this.setState({tofind:tofind,searchfield:field});\n    if(tofind != \"\"){\n      if(field==\"start\"){\n        if(this.state.entries.length != 0) out=api.search_start(this.state.entries,tofind);\n        this.setState({result:out});\n      }\n      if(field==\"end\"){\n        out=api.search_end(this.state.entries,tofind);       \n        this.setState({result:out});\n      }\n      if(field==\"middle\"){\n        out=api.search_middle(this.state.entries,tofind);\n        this.setState({result:out});\n      }\n      if(field==\"fulltext\"){\n        this.search_fulltext(tofind);\n      }\n    }\n  },\n  search_fulltext: function(tofind) {\n    var that=this;\n    var out=[];\n    kse.search(\"moedict\",tofind,{range:{start:0,maxseg:500}},function(err,data){\n      out=data.excerpt.map(function(item){return [item.segname,item.seg];});\n      that.setState({result:out});\n    }) \n  },\n  getEntryIndexByTofind: function(tofind,entries) {\n    var entriesIndex=[];\n    for(var i=1; i<tofind.length+1; i++){\n      var t=tofind.substr(0,i);\n      var index=api.indexOfSorted(entries,t);\n      if(entries[index]==t) {\n        entriesIndex.push(index);\n      }\n    }\n    return entriesIndex;\n  },\n  defSearch: function(tofind) {//點選def做搜尋就是用defSearch\n    var eIdx=this.getEntryIndexByTofind(tofind,this.state.entries);\n    var out=[], defs=[];\n    var that=this;\n    // for(var i=0;i<eIdx.length;i++){\n    //   kse.highlightSeg(this.state.db,0,eIdx[i],{q:this.state.entries[eIdx[i]]},function(data){\n    //     defs.push([data.text,eIdx[i]]);\n    //     if(defs.length==eIdx.length)that.setState({defs:defs});\n    //   });      \n    // }\n    for(var i=0;i<eIdx.length;i++){\n      (function(idx) {  //用參數idx 保存 eIdx[i]的值\n        kse.highlightSeg(that.state.db,0,idx,{span:true},function(data){//that.state.entries[idx]\n                  //debugger;//強迫停在這裡觀察\n          defs.push([data.text,idx]);\n          if(defs.length==eIdx.length)that.setState({defs:defs}); //eIdx.length 可以用，因為這個值不變\n        });      \n      } )(eIdx[i]);\n    }\n\n  },\n  gotoEntry: function(index) {// 從下拉選單點選的項目or 點searchhistory會用gotoEntry 來顯示def\n    if(debug) console.log(\"gotoEntry:\",new Date());\n    var that=this;\n    var defs=[];\n    this.setState({entryIndex:index});\n    // kde.open(\"moedict\",function(err,db){\n    //   var def=db.get([\"filecontents\",0,index],function(data){\n    //     defs.push([data,index]);\n    //     that.setState({defs:defs});\n    //   });\n    // }); \n    kse.highlightSeg(this.state.db,0,index,{span:true},function(data){//q:this.state.tofind\n      //debugger;\n      defs.push([data.text,index]);\n      that.setState({defs:defs});\n    });\n    \n  },\n  highlight: function(def,tofind,segid) {\n    var out=[];\n    kse.highlightSeg(this.state.db,0,segid,{q:tofind,span:true},function(data){\n      out=data;\n    });\n    console.log(out.text);\n    return out;\n  },\n  render: function() {\n    return(\n    React.createElement(\"div\", {className: \"entriearea\"}, \n    React.createElement(\"span\", null, \"1/19-11\"), \n      React.createElement(\"div\", {className: \"space\"}), \n\n        React.createElement(Searchbar, {searchfield: this.state.searchfield, dosearch: this.dosearch}), \n        React.createElement(Overview, {searchfield: this.state.searchfield, result: this.state.result, gotoEntry: this.gotoEntry}), \n        React.createElement(Showtext, {highlight: this.highlight, searchfield: this.state.searchfield, gotoEntry: this.gotoEntry, dosearch: this.dosearch, defSearch: this.defSearch, defs: this.state.defs, tofind: this.state.tofind, result: this.state.result})\n    )\n    );\n  }\n});\nmodule.exports=maincomponent;",
    "var Overview=React.createClass({displayName: \"Overview\",\n  getInitialState: function() {\n  \treturn {};\n  },\n  getDefFromEntryId: function(e) {\n    var entryIndex=e.target.value;\n    this.props.gotoEntry(entryIndex);\n  },\n  shouldComponentUpdate: function(nextProps,nextState) {\n    if(nextProps.result==this.props.result) return false;\n    else return true;\n  },\n  componentDidUpdate: function() {\n    var that=this;\n    if(this.props.result.length!=0){\n      setTimeout(function(){\n        that.refs.entryList.getDOMNode().selectedIndex=0;\n       that.props.gotoEntry(that.props.result[0][1]); \n      },500);\n     }\n    //if(defaultIndex) this.autogetEntry(defaultIndex);\n  },\n  renderResult: function(item,index) {\n    if(item!=\"搜尋結果列表\") return (React.createElement(\"option\", {value: item[1]}, item[0]));\n    else return (React.createElement(\"option\", null, item));\n  },\n  render: function() {\n    var resCounter=0;\n  \tvar res=this.props.result || \"\";\n    if(res!=\"搜尋結果列表\") resCounter=res.length;\n    return(\n\tReact.createElement(\"div\", null, \n\t\tReact.createElement(\"select\", {className: \"resultlist\", ref: \"entryList\", onChange: this.getDefFromEntryId}, \n    this.props.result.map(this.renderResult)\n\t\t), \n    React.createElement(\"span\", {className: \"counter\"}, resCounter)\n\t)\t\n    ); \n  }\n});\nmodule.exports=Overview;",
    "var Searchbar=React.createClass({displayName: \"Searchbar\",\n  getInitialState: function() {\n  \treturn {field:[],tofind:[],ckeckRadio:false};\n  },\n  // componentDidMount: function() {\n  //   var that=this;\n  // \tvar tofind=this.refs.tofind.getDOMNode().value;\n  //   setTimeout(function(){\n  //    that.props.dosearch(tofind,\"start\");//this.props.searchfield\n  //   },500);\n  // },\n  componentWillUpdate: function() {\n  \t//$(\"label[data-type='\"+this.state.field+\"']\").\n\t$(\"label[data-type='\"+this.state.field+\"']\").attr('id', 'checkedfield');\n  },\n  dosearch_radio: function(e) {\n  \t$(\"label\").removeAttr('id');\n  \tvar tofind=this.refs.tofind.getDOMNode().value;\n    //var field=$(this.refs.searchtype.getDOMNode()).find(\"label\")[0].dataset.type;\n    var field=e.target.dataset.type;\n    if(field) {\n\t    if (this.state.field != field || this.state.tofind != tofind ) {\n\t    \tthis.setState({field:field,tofind:tofind})\n\t   \t\tif(!field) field=this.props.searchfield;\n\t  \t\tthis.props.dosearch(tofind,field);   \t\n\t    }\n\t}\n  },\n  dosearch_input: function(e) {\n  \tvar tofind=this.refs.tofind.getDOMNode().value;\n    //var field=$(this.refs.searchtype.getDOMNode()).find(\"label\")[0].dataset.type;\n\n    if (this.state.tofind != tofind) {\n    \tthis.setState({tofind:tofind});\n  \t\tthis.props.dosearch(tofind,this.props.searchfield);   \t\n\t}\n  },\n  render: function() {\n    return(\n  React.createElement(\"div\", null, \n  \tReact.createElement(\"div\", null, \n  \t  React.createElement(\"div\", {className: \"inline\"}, \n  \t    React.createElement(\"input\", {className: \"maininput\", type: \"text\", ref: \"tofind\", placeholder: \"請輸入字詞\", defaultValue: \"點\", onChange: this.dosearch_input})\n  \t  ), \n  \t  React.createElement(\"div\", {className: \"radio-toolbar inline vertical_middle\", ref: \"searchtype\", onClick: this.dosearch_radio}, \n        \" \", React.createElement(\"label\", {\"data-type\": \"start\", id: \"checkedfield\"}, \n  \t      React.createElement(\"input\", {type: \"radio\", name: \"field\", defaultChecked: true}, \"頭\")\n  \t    ), \" \", \n  \t    React.createElement(\"label\", {\"data-type\": \"end\"}, \n  \t      React.createElement(\"input\", {type: \"radio\", name: \"field\"}, \"尾\")\n  \t    ), \" \", \n  \t    React.createElement(\"label\", {\"data-type\": \"middle\"}, \n  \t      React.createElement(\"input\", {type: \"radio\", name: \"field\"}, \"中\")\n  \t    ), \" \", \n  \t    React.createElement(\"label\", {\"data-type\": \"fulltext\"}, \n  \t      React.createElement(\"input\", {type: \"radio\", name: \"field\"}, \"全\")\n  \t    )\n  \t  )\n\t  )\n  )\n    \t\n    ); \n  }\n});\nmodule.exports=Searchbar;",
    "var Searchhistory=React.createClass({displayName: \"Searchhistory\",\n  getInitialState: function() {\n  \treturn {vpos:[]};\n  },\n  componentDidUpdate: function() {\n    var vpos=this.state.vpos;\n    $('span[vpos=]').removeClass(\"highlight\");\n    $('span[vpos=\"'+vpos+'\"]').addClass(\"highlight\");\n  },\n  goEntry: function(e) {\n  \tvar entryIndex=e.target.parentElement.dataset.entry\n  \tvar that=this;\n    //$('html, body').scrollTop($(\"div[class='title']\").position().top);\n  \tthis.props.entryHistory.map(function(item,index){\n  \t\tif(item[1]==entryIndex) {\n  \t\t\tif(index==0) {\n  \t\t\t\tvar text=item[0].replace(/[<>=\"a-z0-9\\/ ]/g,\"\");\n  \t\t\t\tthat.props.defSearch(text);\n          that.setState({vpos:item[3]});\n  \t\t\t} else {\n          that.props.defSearch(item[2]);\n          that.setState({vpos:item[3]});\n        }\n  \t\t\tthat.props.popHistory(index);\n  \t\t}\n  \t})\n  },\n  renderHistory: function(item) {\n  \treturn '<a data-entry='+item[1]+'>'+item[0]+'</a>';\n  },\n  render: function() {\n  \tvar s=this.props.entryHistory;\n  \tvar res=s.map(this.renderHistory);\n  \tvar searchhistory=res.join(\" > \");\n    return(\n\tReact.createElement(\"div\", {onClick: this.goEntry}, \n\t\tReact.createElement(\"div\", {className: \"history\", dangerouslySetInnerHTML: {__html: searchhistory}})\n\t)\n    \t\n    ); \n  }\n});\nmodule.exports=Searchhistory;",
    "var Searchhistory=require(\"./searchhistory.jsx\");\nvar Defbox=require(\"./defbox.jsx\");\nvar Showtext=React.createClass({displayName: \"Showtext\",\n  getInitialState: function() {\n  \treturn {entryHistory:[],tofind:\"\",vpos:[]};\n  },\n  popHistory: function(index) {\n    var h=this.state.entryHistory;\n    for(var i=0; i<h.length-index+1; i++){\n      this.state.entryHistory.pop();\n      console.log(h);\n    }\n  },\n  pushHistory: function(searchResult,clickedIndex) {//searchResult [title,titleIndex,tofind]\n    var that=this;\n    searchResult.map(function(item){\n      if(item[1]==clickedIndex) that.state.entryHistory.push(item);\n    });\n  },\n  dosearch: function(tofind) {\n      this.props.defSearch(tofind);\n  },\n  render: function() {\n    return (\n    React.createElement(\"div\", null, \n    \tReact.createElement(Searchhistory, {popHistory: this.popHistory, defSearch: this.props.defSearch, dosearch: this.dosearch, gotoEntry: this.props.gotoEntry, entryHistory: this.state.entryHistory, result: this.props.result}), \n    \tReact.createElement(Defbox, {vpos: this.state.vpos, highlight: this.props.highlight, tofind: this.props.tofind, searchfield: this.props.searchfield, dosearch: this.dosearch, pushHistory: this.pushHistory, defs: this.props.defs, result: this.props.result})\t\n    )\n    );\n  }\n});\nmodule.exports=Showtext;",
    "var tokenizers=require('./tokenizers');\nvar normalizeTbl=null;\nvar setNormalizeTable=function(tbl,obj) {\n\tif (!obj) {\n\t\tobj={};\n\t\tfor (var i=0;i<tbl.length;i++) {\n\t\t\tvar arr=tbl[i].split(\"=\");\n\t\t\tobj[arr[0]]=arr[1];\n\t\t}\n\t}\n\tnormalizeTbl=obj;\n\treturn obj;\n}\nvar normalize1=function(token) {\n\tif (!token) return \"\";\n\ttoken=token.replace(/[ \\n\\.,，。！．「」：；、]/g,'').trim();\n\tif (!normalizeTbl) return token;\n\tif (token.length==1) {\n\t\treturn normalizeTbl[token] || token;\n\t} else {\n\t\tfor (var i=0;i<token.length;i++) {\n\t\t\ttoken[i]=normalizeTbl[token[i]] || token[i];\n\t\t}\n\t\treturn token;\n\t}\n}\nvar isSkip1=function(token) {\n\tvar t=token.trim();\n\treturn (t==\"\" || t==\"　\" || t==\"※\" || t==\"\\n\");\n}\nvar normalize_tibetan=function(token) {\n\treturn token.replace(/[།་ ]/g,'').trim();\n}\n\nvar isSkip_tibetan=function(token) {\n\tvar t=token.trim();\n\treturn (t==\"\" || t==\"　\" ||  t==\"\\n\");\t\n}\nvar simple1={\n\tfunc:{\n\t\ttokenize:tokenizers.simple\n\t\t,setNormalizeTable:setNormalizeTable\n\t\t,normalize: normalize1\n\t\t,isSkip:\tisSkip1\n\t}\n\t\n}\nvar tibetan1={\n\tfunc:{\n\t\ttokenize:tokenizers.tibetan\n\t\t,setNormalizeTable:setNormalizeTable\n\t\t,normalize:normalize_tibetan\n\t\t,isSkip:isSkip_tibetan\n\t}\n}\nmodule.exports={\"simple1\":simple1,\"tibetan1\":tibetan1}",
    "/* \n  custom func for building and searching ydb\n\n  keep all version\n  \n  getAPI(version); //return hash of functions , if ver is omit , return lastest\n\t\n  postings2Tree      // if version is not supply, get lastest\n  tokenize(text,api) // convert a string into tokens(depends on other api)\n  normalizeToken     // stemming and etc\n  isSpaceChar        // not a searchable token\n  isSkipChar         // 0 vpos\n\n  for client and server side\n  \n*/\nvar configs=require(\"./configs\");\nvar config_simple=\"simple1\";\nvar optimize=function(json,config) {\n\tconfig=config||config_simple;\n\treturn json;\n}\n\nvar getAPI=function(config) {\n\tconfig=config||config_simple;\n\tvar func=configs[config].func;\n\tfunc.optimize=optimize;\n\tif (config==\"simple1\") {\n\t\t//add common custom function here\n\t} else if (config==\"tibetan1\") {\n\n\t} else throw \"config \"+config +\"not supported\";\n\n\treturn func;\n}\n\nmodule.exports={getAPI:getAPI};",
    "var tibetan =function(s) {\n\t//continuous tsheg grouped into same token\n\t//shad and space grouped into same token\n\tvar offset=0;\n\tvar tokens=[],offsets=[];\n\ts=s.replace(/\\r\\n/g,'\\n').replace(/\\r/g,'\\n');\n\tvar arr=s.split('\\n');\n\n\tfor (var i=0;i<arr.length;i++) {\n\t\tvar last=0;\n\t\tvar str=arr[i];\n\t\tstr.replace(/[།་ ]+/g,function(m,m1){\n\t\t\ttokens.push(str.substring(last,m1)+m);\n\t\t\toffsets.push(offset+last);\n\t\t\tlast=m1+m.length;\n\t\t});\n\t\tif (last<str.length) {\n\t\t\ttokens.push(str.substring(last));\n\t\t\toffsets.push(last);\n\t\t}\n\t\tif (i===arr.length-1) break;\n\t\ttokens.push('\\n');\n\t\toffsets.push(offset+last);\n\t\toffset+=str.length+1;\n\t}\n\n\treturn {tokens:tokens,offsets:offsets};\n};\nvar isSpace=function(c) {\n\treturn (c==\" \") ;//|| (c==\",\") || (c==\".\");\n}\nvar isCJK =function(c) {return ((c>=0x3000 && c<=0x9FFF) \n|| (c>=0xD800 && c<0xDC00) || (c>=0xFF00) ) ;}\nvar simple1=function(s) {\n\tvar offset=0;\n\tvar tokens=[],offsets=[];\n\ts=s.replace(/\\r\\n/g,'\\n').replace(/\\r/g,'\\n');\n\tarr=s.split('\\n');\n\n\tvar pushtoken=function(t,off) {\n\t\tvar i=0;\n\t\tif (t.charCodeAt(0)>255) {\n\t\t\twhile (i<t.length) {\n\t\t\t\tvar c=t.charCodeAt(i);\n\t\t\t\toffsets.push(off+i);\n\t\t\t\ttokens.push(t[i]);\n\t\t\t\tif (c>=0xD800 && c<=0xDFFF) {\n\t\t\t\t\ttokens[tokens.length-1]+=t[i]; //extension B,C,D\n\t\t\t\t}\n\t\t\t\ti++;\n\t\t\t}\n\t\t} else {\n\t\t\ttokens.push(t);\n\t\t\toffsets.push(off);\t\n\t\t}\n\t}\n\tfor (var i=0;i<arr.length;i++) {\n\t\tvar last=0,sp=\"\";\n\t\tstr=arr[i];\n\t\tstr.replace(/[_0-9A-Za-z]+/g,function(m,m1){\n\t\t\twhile (isSpace(sp=str[last]) && last<str.length) {\n\t\t\t\ttokens[tokens.length-1]+=sp;\n\t\t\t\tlast++;\n\t\t\t}\n\t\t\tpushtoken(str.substring(last,m1)+m , offset+last);\n\t\t\toffsets.push(offset+last);\n\t\t\tlast=m1+m.length;\n\t\t});\n\n\t\tif (last<str.length) {\n\t\t\twhile (isSpace(sp=str[last]) && last<str.length) {\n\t\t\t\ttokens[tokens.length-1]+=sp;\n\t\t\t\tlast++;\n\t\t\t}\n\t\t\tpushtoken(str.substring(last), offset+last);\n\t\t\t\n\t\t}\t\t\n\t\toffsets.push(offset+last);\n\t\toffset+=str.length+1;\n\t\tif (i===arr.length-1) break;\n\t\ttokens.push('\\n');\n\t}\n\n\treturn {tokens:tokens,offsets:offsets};\n\n};\n\nvar simple=function(s) {\n\tvar token='';\n\tvar tokens=[], offsets=[] ;\n\tvar i=0; \n\tvar lastspace=false;\n\tvar addtoken=function() {\n\t\tif (!token) return;\n\t\ttokens.push(token);\n\t\toffsets.push(i);\n\t\ttoken='';\n\t}\n\twhile (i<s.length) {\n\t\tvar c=s.charAt(i);\n\t\tvar code=s.charCodeAt(i);\n\t\tif (isCJK(code)) {\n\t\t\taddtoken();\n\t\t\ttoken=c;\n\t\t\tif (code>=0xD800 && code<0xDC00) { //high sorragate\n\t\t\t\ttoken+=s.charAt(i+1);i++;\n\t\t\t}\n\t\t\taddtoken();\n\t\t} else {\n\t\t\tif (c=='&' || c=='<' || c=='?' || c==\",\" || c==\".\"\n\t\t\t|| c=='|' || c=='~' || c=='`' || c==';' \n\t\t\t|| c=='>' || c==':' \n\t\t\t|| c=='=' || c=='@'  || c==\"-\" \n\t\t\t|| c==']' || c=='}'  || c==\")\" \n\t\t\t//|| c=='{' || c=='}'|| c=='[' || c==']' || c=='(' || c==')'\n\t\t\t|| code==0xf0b || code==0xf0d // tibetan space\n\t\t\t|| (code>=0x2000 && code<=0x206f)) {\n\t\t\t\taddtoken();\n\t\t\t\tif (c=='&' || c=='<'){ // || c=='{'|| c=='('|| c=='[') {\n\t\t\t\t\tvar endchar='>';\n\t\t\t\t\tif (c=='&') endchar=';'\n\t\t\t\t\t//else if (c=='{') endchar='}';\n\t\t\t\t\t//else if (c=='[') endchar=']';\n\t\t\t\t\t//else if (c=='(') endchar=')';\n\n\t\t\t\t\twhile (i<s.length && s.charAt(i)!=endchar) {\n\t\t\t\t\t\ttoken+=s.charAt(i);\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\ttoken+=endchar;\n\t\t\t\t\taddtoken();\n\t\t\t\t} else {\n\t\t\t\t\ttoken=c;\n\t\t\t\t\taddtoken();\n\t\t\t\t}\n\t\t\t\ttoken='';\n\t\t\t} else {\n\t\t\t\tif (c==\" \") {\n\t\t\t\t\ttoken+=c;\n\t\t\t\t\tlastspace=true;\n\t\t\t\t} else {\n\t\t\t\t\tif (lastspace) addtoken();\n\t\t\t\t\tlastspace=false;\n\t\t\t\t\ttoken+=c;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\ti++;\n\t}\n\taddtoken();\n\treturn {tokens:tokens,offsets:offsets};\n}\nmodule.exports={simple:simple,tibetan:tibetan};",
    "var indexOfSorted = function (array, obj, near) { \n  var low = 0,\n  high = array.length;\n  while (low < high) {\n    var mid = (low + high) >> 1;\n    if (array[mid]==obj) return mid;\n    array[mid] < obj ? low = mid + 1 : high = mid;\n  }\n  if (near) return low;\n  else if (array[low]==obj) return low;else return -1;\n};\nvar indexOfSorted_str = function (array, obj, near) { \n  var low = 0,\n  high = array.length;\n  while (low < high) {\n    var mid = (low + high) >> 1;\n    if (array[mid]==obj) return mid;\n    //(array[mid].localeCompare(obj)<0) ? low = mid + 1 : high = mid;\n    array[mid]<obj ? low=mid+1 : high=mid;\n  }\n  if (near) return low;\n  else if (array[low]==obj) return low;else return -1;\n};\n\n\nvar bsearch=function(array,value,near) {\n\tvar func=indexOfSorted;\n\tif (typeof array[0]==\"string\") func=indexOfSorted_str;\n\treturn func(array,value,near);\n}\nvar bsearchNear=function(array,value) {\n\treturn bsearch(array,value,true);\n}\n\nmodule.exports=bsearch;//{bsearchNear:bsearchNear,bsearch:bsearch};",
    "var KDE=require(\"./kde\");\n//currently only support node.js fs, ksanagap native fs, html5 file system\n//use socket.io to read kdb from remote server in future\nmodule.exports=KDE;",
    "/* Ksana Database Engine\n\n   2015/1/2 , \n   move to ksana-database\n   simplified by removing document support and socket.io support\n\n\n*/\nvar pool={},localPool={};\nvar apppath=\"\";\nvar bsearch=require(\"./bsearch\");\nvar Kdb=require('ksana-jsonrom');\nvar kdbs=[]; //available kdb , id and absolute path\nvar strsep=\"\\uffff\";\nvar kdblisted=false;\n/*\nvar _getSync=function(paths,opts) {\n\tvar out=[];\n\tfor (var i in paths) {\n\t\tout.push(this.getSync(paths[i],opts));\t\n\t}\n\treturn out;\n}\n*/\nvar _gets=function(paths,opts,cb) { //get many data with one call\n\n\tif (!paths) return ;\n\tif (typeof paths=='string') {\n\t\tpaths=[paths];\n\t}\n\tvar engine=this, output=[];\n\n\tvar makecb=function(path){\n\t\treturn function(data){\n\t\t\t\tif (!(data && typeof data =='object' && data.__empty)) output.push(data);\n\t\t\t\tengine.get(path,opts,taskqueue.shift());\n\t\t};\n\t};\n\n\tvar taskqueue=[];\n\tfor (var i=0;i<paths.length;i++) {\n\t\tif (typeof paths[i]==\"null\") { //this is only a place holder for key data already in client cache\n\t\t\toutput.push(null);\n\t\t} else {\n\t\t\ttaskqueue.push(makecb(paths[i]));\n\t\t}\n\t};\n\n\ttaskqueue.push(function(data){\n\t\toutput.push(data);\n\t\tcb.apply(engine.context||engine,[output,paths]); //return to caller\n\t});\n\n\ttaskqueue.shift()({__empty:true}); //run the task\n}\n\nvar getFileRange=function(i) {\n\tvar engine=this;\n\n\tvar filesegcount=engine.get([\"filesegcount\"]);\n\tif (filesegcount) {\n\t\tif (i==0) {\n\t\t\treturn {start:0,end:filesegcount[0]-1};\n\t\t} else {\n\t\t\treturn {start:filesegcount[i-1],end:filesegcount[i]-1};\n\t\t}\n\t}\n\t//old buggy code\n\tvar filenames=engine.get([\"filenames\"]);\n\tvar fileoffsets=engine.get([\"fileoffsets\"]);\n\tvar segoffsets=engine.get([\"segoffsets\"]);\n\tvar segnames=engine.get([\"segnames\"]);\n\tvar filestart=fileoffsets[i], fileend=fileoffsets[i+1]-1;\n\n\tvar start=bsearch(segoffsets,filestart,true);\n\t//if (segOffsets[start]==fileStart) start--;\n\t\n\t//work around for jiangkangyur\n\twhile (segNames[start+1]==\"_\") start++;\n\n  //if (i==0) start=0; //work around for first file\n\tvar end=bsearch(segoffsets,fileend,true);\n\treturn {start:start,end:end};\n}\n\nvar absSegToFileSeg=function(absoluteseg) {\n\tvar filesegcount=this.get(\"filesegcount\");\n\tvar s=absoluteseg;\n\tvar file=0;\n\twhile (s>filesegcount[file]) {\n\t\ts-=filesegcount[file];\n\t\tfile++;\n\t}\n\treturn {file:file,seg:s};\n}\n\nvar fileSegToAbsSeg=function(file,seg) {\n\tif (file==0)return seg;\n\treturn this.get(\"filesegcount\")[file-1]+seg;\n}\n/*\nvar vposToFileSeg=function(engine,vpos) {\n    var segoffsets=engine.get(\"segoffsets\");\n    var fileoffsets=engine.get([\"fileoffsets\"]);\n    var segnames=engine.get(\"segnames\");\n    var fileid=bsearch(fileoffsets,vpos+1,true);\n    fileid--;\n    var segid=bsearch(segoffsets,vpos+1,true);\n\tvar range=engine.getFileRange(fileid);\n\tsegid-=range.start;\n    return {file:fileid,seg:segid};\n}\n*/\n//return array of object of nfile nseg given segname\nvar findSeg=function(segname) {\n\tvar segnames=this.get(\"segnames\");\n\tvar out=[];\n\tfor (var i=0;i<segnames.length;i++) {\n\t\tif (segnames[i]==segname) {\n\t\t\tvar fileseg=absSegToFileSeg.apply(this,[i]);\n\t\t\tout.push({file:fileseg.file,seg:fileseg.seg,absseg:i});\n\t\t}\n\t}\n\treturn out;\n}\nvar getFileSegOffsets=function(i) {\n\tvar segoffsets=this.get(\"segoffsets\");\n\tvar range=getFileRange.apply(this,[i]);\n\treturn segoffsets.slice(range.start,range.end+1);\n}\nvar fileSegFromVpos=function(vpos) {\n\tvar segoffsets=this.get([\"segoffsets\"]);\n\tvar i=bsearch(segoffsets,vpos,true);\n\treturn absSegToFileSeg.apply(this,[i]);\n}\nvar fileSegToVpos=function(f,s) {\n\tvar segoffsets=this.get([\"segoffsets\"]);\n\tvar seg=fileSegToAbsSeg(f,s);\n\treturn segoffsets[seg];\n}\n\nvar getFileSegNames=function(i) {\n\tvar range=getFileRange.apply(this,[i]);\n\tvar segnames=this.get(\"segnames\");\n\treturn segnames.slice(range.start,range.end+1);\n}\nvar localengine_get=function(path,opts,cb,context) {\n\tvar engine=this;\n\tif (typeof opts==\"function\") {\n\t\tcontext=cb;\n\t\tcb=opts;\n\t\topts={recursive:false};\n\t}\n\tif (!path) {\n\t\tif (cb) cb.apply(context,[null]);\n\t\treturn null;\n\t}\n\n\tif (typeof cb!=\"function\") {\n\t\treturn engine.kdb.get(path,opts);\n\t}\n\n\tif (typeof path==\"string\") {\n\t\treturn engine.kdb.get([path],opts,cb,context);\n\t} else if (typeof path[0] ==\"string\") {\n\t\treturn engine.kdb.get(path,opts,cb,context);\n\t} else if (typeof path[0] ==\"object\") {\n\t\treturn _gets.apply(engine,[path,opts,cb,context]);\n\t} else {\n\t\tengine.kdb.get([],opts,function(data){\n\t\t\tcb.apply(context,[data]);//return top level keys\n\t\t},context);\n\t}\n};\t\n\nvar getPreloadField=function(user) {\n\tvar preload=[[\"meta\"],[\"filenames\"],[\"fileoffsets\"],[\"segnames\"],[\"segoffsets\"],[\"filesegcount\"]];\n\t//[\"tokens\"],[\"postingslen\"] kse will load it\n\tif (user && user.length) { //user supply preload\n\t\tfor (var i=0;i<user.length;i++) {\n\t\t\tif (preload.indexOf(user[i])==-1) {\n\t\t\t\tpreload.push(user[i]);\n\t\t\t}\n\t\t}\n\t}\n\treturn preload;\n}\nvar createLocalEngine=function(kdb,opts,cb,context) {\n\tvar engine={kdb:kdb, queryCache:{}, postingCache:{}, cache:{}};\n\n\tif (typeof context==\"object\") engine.context=context;\n\tengine.get=localengine_get;\n\n\tengine.segOffset=segOffset;\n\tengine.fileOffset=fileOffset;\n\tengine.getFileSegNames=getFileSegNames;\n\tengine.getFileSegOffsets=getFileSegOffsets;\n\tengine.getFileRange=getFileRange;\n\tengine.findSeg=findSeg;\n\tengine.absSegToFileSeg=absSegToFileSeg;\n\tengine.fileSegToAbsSeg=fileSegToAbsSeg;\n\tengine.fileSegFromVpos=fileSegFromVpos;\n\tengine.fileSegToVpos=fileSegToVpos;\n\t\n\t//engine.fileSegToVpos=fileSegToVpos;\n\t//engine.vposToFileSeg=vposToFileSeg;\n\t//only local engine allow getSync\n\t//if (kdb.fs.getSync) engine.getSync=engine.kdb.getSync;\n\t\n\t//speedy native functions\n\tif (kdb.fs.mergePostings) {\n\t\tengine.mergePostings=kdb.fs.mergePostings.bind(kdb.fs);\n\t}\n\t\n\tvar setPreload=function(res) {\n\t\tengine.dbname=res[0].name;\n\t\t//engine.customfunc=customfunc.getAPI(res[0].config);\n\t\tengine.ready=true;\n\t}\n\n\tvar preload=getPreloadField(opts.preload);\n\tvar opts={recursive:true};\n\t//if (typeof cb==\"function\") {\n\t\t_gets.apply(engine,[ preload, opts,function(res){\n\t\t\tsetPreload(res);\n\t\t\tcb.apply(engine.context,[engine]);\n\t\t}]);\n\t//} else {\n\t//\tsetPreload(_getSync.apply(engine,[preload,opts]));\n\t//}\n\treturn engine;\n}\n\nvar segOffset=function(segname) {\n\tvar engine=this;\n\tif (arguments.length>1) throw \"argument : segname \";\n\n\tvar segNames=engine.get(\"segnames\");\n\tvar segOffsets=engine.get(\"segoffsets\");\n\n\tvar i=segNames.indexOf(segname);\n\treturn (i>-1)?segOffsets[i]:0;\n}\nvar fileOffset=function(fn) {\n\tvar engine=this;\n\tvar filenames=engine.get(\"filenames\");\n\tvar offsets=engine.get(\"fileoffsets\");\n\tvar i=filenames.indexOf(fn);\n\tif (i==-1) return null;\n\treturn {start: offsets[i], end:offsets[i+1]};\n}\n\nvar folderOffset=function(folder) {\n\tvar engine=this;\n\tvar start=0,end=0;\n\tvar filenames=engine.get(\"filenames\");\n\tvar offsets=engine.get(\"fileoffsets\");\n\tfor (var i=0;i<filenames.length;i++) {\n\t\tif (filenames[i].substring(0,folder.length)==folder) {\n\t\t\tif (!start) start=offsets[i];\n\t\t\tend=offsets[i];\n\t\t} else if (start) break;\n\t}\n\treturn {start:start,end:end};\n}\n\n //TODO delete directly from kdb instance\n //kdb.free();\nvar closeLocal=function(kdbid) {\n\tvar engine=localPool[kdbid];\n\tif (engine) {\n\t\tengine.kdb.free();\n\t\tdelete localPool[kdbid];\n\t}\n}\nvar close=function(kdbid) {\n\tvar engine=pool[kdbid];\n\tif (engine) {\n\t\tengine.kdb.free();\n\t\tdelete pool[kdbid];\n\t}\n}\n\nvar getLocalTries=function(kdbfn) {\n\tif (!kdblisted) {\n\t\tkdbs=require(\"./listkdb\")();\n\t\tkdblisted=true;\n\t}\n\n\tvar kdbid=kdbfn.replace('.kdb','');\n\tvar tries= [\"./\"+kdbid+\".kdb\"\n\t           ,\"../\"+kdbid+\".kdb\"\n\t];\n\n\tfor (var i=0;i<kdbs.length;i++) {\n\t\tif (kdbs[i][0]==kdbid) {\n\t\t\ttries.push(kdbs[i][1]);\n\t\t}\n\t}\n\treturn tries;\n}\nvar openLocalKsanagap=function(kdbid,opts,cb,context) {\n\tvar kdbfn=kdbid;\n\tvar tries=getLocalTries(kdbfn);\n\n\tfor (var i=0;i<tries.length;i++) {\n\t\tif (fs.existsSync(tries[i])) {\n\t\t\t//console.log(\"kdb path: \"+nodeRequire('path').resolve(tries[i]));\n\t\t\tvar kdb=new Kdb.open(tries[i],function(err,kdb){\n\t\t\t\tif (err) {\n\t\t\t\t\tcb.apply(context,[err]);\n\t\t\t\t} else {\n\t\t\t\t\tcreateLocalEngine(kdb,opts,function(engine){\n\t\t\t\t\t\tlocalPool[kdbid]=engine;\n\t\t\t\t\t\tcb.apply(context||engine.context,[0,engine]);\n\t\t\t\t\t},context);\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn null;\n\t\t}\n\t}\n\tif (cb) cb.apply(context,[kdbid+\" not found\"]);\n\treturn null;\n\n}\nvar openLocalNode=function(kdbid,opts,cb,context) {\n\tvar fs=require('fs');\n\tvar tries=getLocalTries(kdbid);\n\n\tfor (var i=0;i<tries.length;i++) {\n\t\tif (fs.existsSync(tries[i])) {\n\n\t\t\tnew Kdb.open(tries[i],function(err,kdb){\n\t\t\t\tif (err) {\n\t\t\t\t\tcb.apply(context||engine.content,[err]);\n\t\t\t\t} else {\n\t\t\t\t\tcreateLocalEngine(kdb,opts,function(engine){\n\t\t\t\t\t\t\tlocalPool[kdbid]=engine;\n\t\t\t\t\t\t\tcb.apply(context||engine.context,[0,engine]);\n\t\t\t\t\t},context);\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn null;\n\t\t}\n\t}\n\tif (cb) cb.apply(context,[kdbid+\" not found\"]);\n\treturn null;\n}\n\nvar openLocalHtml5=function(kdbid,opts,cb,context) {\t\n\tvar engine=localPool[kdbid];\n\tvar kdbfn=kdbid;\n\tif (kdbfn.indexOf(\".kdb\")==-1) kdbfn+=\".kdb\";\n\tnew Kdb.open(kdbfn,function(err,handle){\n\t\tif (err) {\n\t\t\tcb.apply(context,[err]);\n\t\t} else {\n\t\t\tcreateLocalEngine(handle,opts,function(engine){\n\t\t\t\tlocalPool[kdbid]=engine;\n\t\t\t\tcb.apply(context||engine.context,[0,engine]);\n\t\t\t},context);\n\t\t}\n\t});\n}\n//omit cb for syncronize open\nvar openLocal=function(kdbid,opts,cb,context)  {\n\tif (typeof opts==\"function\") { //no opts\n\t\tif (typeof cb==\"object\") context=cb;\n\t\tcb=opts;\n\t\topts={};\n\t}\n\n\tvar engine=localPool[kdbid];\n\tif (engine) {\n\t\tif (cb) cb.apply(context||engine.context,[0,engine]);\n\t\treturn engine;\n\t}\n\n\tvar platform=require(\"./platform\").getPlatform();\n\tif (platform==\"node-webkit\" || platform==\"node\") {\n\t\topenLocalNode(kdbid,opts,cb,context);\n\t} else if (platform==\"html5\" || platform==\"chrome\"){\n\t\topenLocalHtml5(kdbid,opts,cb,context);\t\t\n\t} else {\n\t\topenLocalKsanagap(kdbid,opts,cb,context);\t\n\t}\n}\nvar setPath=function(path) {\n\tapppath=path;\n\tconsole.log(\"set path\",path)\n}\n\nvar enumKdb=function(cb,context){\n\treturn kdbs.map(function(k){return k[0]});\n}\n\nmodule.exports={open:openLocal,setPath:setPath, close:closeLocal, enumKdb:enumKdb, bsearch:bsearch};",
    "/* return array of dbid and absolute path*/\nvar listkdb_html5=function() {\n\tthrow \"not implement yet\";\n\trequire(\"ksana-jsonrom\").html5fs.readdir(function(kdbs){\n\t\t\tcb.apply(this,[kdbs]);\n\t},context||this);\t\t\n\n}\n\nvar listkdb_node=function(){\n\tvar fs=require(\"fs\");\n\tvar path=require(\"path\")\n\tvar parent=path.resolve(process.cwd(),\"..\");\n\tvar files=fs.readdirSync(parent);\n\tvar output=[];\n\tfiles.map(function(f){\n\t\tvar subdir=parent+path.sep+f;\n\t\tvar stat=fs.statSync(subdir );\n\t\tif (stat.isDirectory()) {\n\t\t\tvar subfiles=fs.readdirSync(subdir);\n\t\t\tfor (var i=0;i<subfiles.length;i++) {\n\t\t\t\tvar file=subfiles[i];\n\t\t\t\tvar idx=file.indexOf(\".kdb\");\n\t\t\t\tif (idx>-1&&idx==file.length-4) {\n\t\t\t\t\toutput.push([ file.substr(0,file.length-4), subdir+path.sep+file]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t})\n\treturn output;\n}\nvar fileNameOnly=function(fn) {\n\tvar at=fn.lastIndexOf(\"/\");\n\tif (at>-1) return fn.substr(at+1);\n\treturn fn;\n}\nvar listkdb_ksanagap=function() {\n\tvar output=[];\n\tvar apps=JSON.parse(kfs.listApps());\n\tfor (var i=0;i<apps.length;i++) {\n\t\tvar app=apps[i];\n\t\tif (app.files) for (var j=0;j<app.files.length;j++) {\n\t\t\tvar file=app.files[j];\n\t\t\tif (file.substr(file.length-4)==\".kdb\") {\n\t\t\t\toutput.push([app.dbid,fileNameOnly(file)]);\n\t\t\t}\n\t\t}\n\t};\n\treturn output;\n}\nvar listkdb=function() {\n\tvar platform=require(\"./platform\").getPlatform();\n\tvar files=[];\n\tif (platform==\"node\" || platform==\"node-webkit\") {\n\t\tfiles=listkdb_node();\n\t} else if (typeof kfs!=\"undefined\") {\n\t\tfiles=listkdb_ksanagap();\n\t} else {\n\t\tthrow \"not implement yet\";\n\t}\n\treturn files;\n}\nmodule.exports=listkdb;",
    "var getPlatform=function() {\n\tif (typeof ksanagap==\"undefined\") {\n\t\tplatform=\"node\";\n\t} else {\n\t\tplatform=ksanagap.platform;\n\t}\n\treturn platform;\n}\nmodule.exports={getPlatform:getPlatform};",
    "\n/* emulate filesystem on html5 browser */\n/* emulate filesystem on html5 browser */\nvar read=function(handle,buffer,offset,length,position,cb) {//buffer and offset is not used\n\tvar xhr = new XMLHttpRequest();\n\txhr.open('GET', handle.url , true);\n\tvar range=[position,length+position-1];\n\txhr.setRequestHeader('Range', 'bytes='+range[0]+'-'+range[1]);\n\txhr.responseType = 'arraybuffer';\n\txhr.send();\n\txhr.onload = function(e) {\n\t\tvar that=this;\n\t\tsetTimeout(function(){\n\t\t\tcb(0,that.response.byteLength,that.response);\n\t\t},0);\n\t}; \n}\nvar close=function(handle) {}\nvar fstatSync=function(handle) {\n\tthrow \"not implement yet\";\n}\nvar fstat=function(handle,cb) {\n\tthrow \"not implement yet\";\n}\nvar _open=function(fn_url,cb) {\n\t\tvar handle={};\n\t\tif (fn_url.indexOf(\"filesystem:\")==0){\n\t\t\thandle.url=fn_url;\n\t\t\thandle.fn=fn_url.substr( fn_url.lastIndexOf(\"/\")+1);\n\t\t} else {\n\t\t\thandle.fn=fn_url;\n\t\t\tvar url=API.files.filter(function(f){ return (f[0]==fn_url)});\n\t\t\tif (url.length) handle.url=url[0][1];\n\t\t\telse cb(null);\n\t\t}\n\t\tcb(handle);\n}\nvar open=function(fn_url,cb) {\n\t\tif (!API.initialized) {init(1024*1024,function(){\n\t\t\t_open.apply(this,[fn_url,cb]);\n\t\t},this)} else _open.apply(this,[fn_url,cb]);\n}\nvar load=function(filename,mode,cb) {\n\topen(filename,mode,cb,true);\n}\nfunction errorHandler(e) {\n\tconsole.error('Error: ' +e.name+ \" \"+e.message);\n}\nvar readdir=function(cb,context) {\n\t var dirReader = API.fs.root.createReader();\n\t var out=[],that=this;\n\t\tdirReader.readEntries(function(entries) {\n\t\t\tif (entries.length) {\n\t\t\t\tfor (var i = 0, entry; entry = entries[i]; ++i) {\n\t\t\t\t\tif (entry.isFile) {\n\t\t\t\t\t\tout.push([entry.name,entry.toURL ? entry.toURL() : entry.toURI()]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tAPI.files=out;\n\t\t\tif (cb) cb.apply(context,[out]);\n\t\t}, function(){\n\t\t\tif (cb) cb.apply(context,[null]);\n\t\t});\n}\nvar initfs=function(grantedBytes,cb,context) {\n\twebkitRequestFileSystem(PERSISTENT, grantedBytes,  function(fs) {\n\t\tAPI.fs=fs;\n\t\tAPI.quota=grantedBytes;\n\t\treaddir(function(){\n\t\t\tAPI.initialized=true;\n\t\t\tcb.apply(context,[grantedBytes,fs]);\n\t\t},context);\n\t}, errorHandler);\n}\nvar init=function(quota,cb,context) {\n\tnavigator.webkitPersistentStorage.requestQuota(quota, \n\t\t\tfunction(grantedBytes) {\n\t\t\t\tinitfs(grantedBytes,cb,context);\n\t\t}, errorHandler \n\t);\n}\nvar API={\n\tread:read\n\t,readdir:readdir\n\t,open:open\n\t,close:close\n\t,fstatSync:fstatSync\n\t,fstat:fstat\n}\nmodule.exports=API;",
    "module.exports={\n\topen:require(\"./kdb\")\n\t,create:require(\"./kdbw\")\n}\n",
    "/*\n\tKDB version 3.0 GPL\n\tyapcheahshen@gmail.com\n\t2013/12/28\n\tasyncronize version of yadb\n\n  remove dependency of Q, thanks to\n  http://stackoverflow.com/questions/4234619/how-to-avoid-long-nesting-of-asynchronous-functions-in-node-js\n\n  2015/1/2\n  moved to ksanaforge/ksana-jsonrom\n  add err in callback for node.js compliant\n*/\nvar Kfs=null;\n\nif (typeof ksanagap==\"undefined\") {\n\tKfs=require('./kdbfs');\t\t\t\n} else {\n\tif (ksanagap.platform==\"ios\") {\n\t\tKfs=require(\"./kdbfs_ios\");\n\t} else if (ksanagap.platform==\"node-webkit\") {\n\t\tKfs=require(\"./kdbfs\");\n\t} else if (ksanagap.platform==\"chrome\") {\n\t\tKfs=require(\"./kdbfs\");\n\t} else {\n\t\tKfs=require(\"./kdbfs_android\");\n\t}\n\t\t\n}\n\n\nvar DT={\n\tuint8:'1', //unsigned 1 byte integer\n\tint32:'4', // signed 4 bytes integer\n\tutf8:'8',  \n\tucs2:'2',\n\tbool:'^', \n\tblob:'&',\n\tutf8arr:'*', //shift of 8\n\tucs2arr:'@', //shift of 2\n\tuint8arr:'!', //shift of 1\n\tint32arr:'$', //shift of 4\n\tvint:'`',\n\tpint:'~',\t\n\n\tarray:'\\u001b',\n\tobject:'\\u001a' \n\t//ydb start with object signature,\n\t//type a ydb in command prompt shows nothing\n}\nvar verbose=0, readLog=function(){};\nvar _readLog=function(readtype,bytes) {\n\tconsole.log(readtype,bytes,\"bytes\");\n}\nif (verbose) readLog=_readLog;\nvar strsep=\"\\uffff\";\nvar Create=function(path,opts,cb) {\n\t/* loadxxx functions move file pointer */\n\t// load variable length int\n\tif (typeof opts==\"function\") {\n\t\tcb=opts;\n\t\topts={};\n\t}\n\n\t\n\tvar loadVInt =function(opts,blocksize,count,cb) {\n\t\t//if (count==0) return [];\n\t\tvar that=this;\n\n\t\tthis.fs.readBuf_packedint(opts.cur,blocksize,count,true,function(o){\n\t\t\t//console.log(\"vint\");\n\t\t\topts.cur+=o.adv;\n\t\t\tcb.apply(that,[o.data]);\n\t\t});\n\t}\n\tvar loadVInt1=function(opts,cb) {\n\t\tvar that=this;\n\t\tloadVInt.apply(this,[opts,6,1,function(data){\n\t\t\t//console.log(\"vint1\");\n\t\t\tcb.apply(that,[data[0]]);\n\t\t}])\n\t}\n\t//for postings\n\tvar loadPInt =function(opts,blocksize,count,cb) {\n\t\tvar that=this;\n\t\tthis.fs.readBuf_packedint(opts.cur,blocksize,count,false,function(o){\n\t\t\t//console.log(\"pint\");\n\t\t\topts.cur+=o.adv;\n\t\t\tcb.apply(that,[o.data]);\n\t\t});\n\t}\n\t// item can be any type (variable length)\n\t// maximum size of array is 1TB 2^40\n\t// structure:\n\t// signature,5 bytes offset, payload, itemlengths\n\tvar getArrayLength=function(opts,cb) {\n\t\tvar that=this;\n\t\tvar dataoffset=0;\n\n\t\tthis.fs.readUI8(opts.cur,function(len){\n\t\t\tvar lengthoffset=len*4294967296;\n\t\t\topts.cur++;\n\t\t\tthat.fs.readUI32(opts.cur,function(len){\n\t\t\t\topts.cur+=4;\n\t\t\t\tdataoffset=opts.cur; //keep this\n\t\t\t\tlengthoffset+=len;\n\t\t\t\topts.cur+=lengthoffset;\n\n\t\t\t\tloadVInt1.apply(that,[opts,function(count){\n\t\t\t\t\tloadVInt.apply(that,[opts,count*6,count,function(sz){\t\t\t\t\t\t\n\t\t\t\t\t\tcb({count:count,sz:sz,offset:dataoffset});\n\t\t\t\t\t}]);\n\t\t\t\t}]);\n\t\t\t\t\n\t\t\t});\n\t\t});\n\t}\n\n\tvar loadArray = function(opts,blocksize,cb) {\n\t\tvar that=this;\n\t\tgetArrayLength.apply(this,[opts,function(L){\n\t\t\t\tvar o=[];\n\t\t\t\tvar endcur=opts.cur;\n\t\t\t\topts.cur=L.offset;\n\n\t\t\t\tif (opts.lazy) { \n\t\t\t\t\t\tvar offset=L.offset;\n\t\t\t\t\t\tL.sz.map(function(sz){\n\t\t\t\t\t\t\to[o.length]=strsep+offset.toString(16)\n\t\t\t\t\t\t\t\t   +strsep+sz.toString(16);\n\t\t\t\t\t\t\toffset+=sz;\n\t\t\t\t\t\t})\n\t\t\t\t} else {\n\t\t\t\t\tvar taskqueue=[];\n\t\t\t\t\tfor (var i=0;i<L.count;i++) {\n\t\t\t\t\t\ttaskqueue.push(\n\t\t\t\t\t\t\t(function(sz){\n\t\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t\tfunction(data){\n\t\t\t\t\t\t\t\t\t\tif (typeof data=='object' && data.__empty) {\n\t\t\t\t\t\t\t\t\t\t\t //not pushing the first call\n\t\t\t\t\t\t\t\t\t\t}\telse o.push(data);\n\t\t\t\t\t\t\t\t\t\topts.blocksize=sz;\n\t\t\t\t\t\t\t\t\t\tload.apply(that,[opts, taskqueue.shift()]);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t})(L.sz[i])\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\t//last call to child load\n\t\t\t\t\ttaskqueue.push(function(data){\n\t\t\t\t\t\to.push(data);\n\t\t\t\t\t\topts.cur=endcur;\n\t\t\t\t\t\tcb.apply(that,[o]);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (opts.lazy) cb.apply(that,[o]);\n\t\t\t\telse {\n\t\t\t\t\ttaskqueue.shift()({__empty:true});\n\t\t\t\t}\n\t\t\t}\n\t\t])\n\t}\t\t\n\t// item can be any type (variable length)\n\t// support lazy load\n\t// structure:\n\t// signature,5 bytes offset, payload, itemlengths, \n\t//                    stringarray_signature, keys\n\tvar loadObject = function(opts,blocksize,cb) {\n\t\tvar that=this;\n\t\tvar start=opts.cur;\n\t\tgetArrayLength.apply(this,[opts,function(L) {\n\t\t\topts.blocksize=blocksize-opts.cur+start;\n\t\t\tload.apply(that,[opts,function(keys){ //load the keys\n\t\t\t\tif (opts.keys) { //caller ask for keys\n\t\t\t\t\tkeys.map(function(k) { opts.keys.push(k)});\n\t\t\t\t}\n\n\t\t\t\tvar o={};\n\t\t\t\tvar endcur=opts.cur;\n\t\t\t\topts.cur=L.offset;\n\t\t\t\tif (opts.lazy) { \n\t\t\t\t\tvar offset=L.offset;\n\t\t\t\t\tfor (var i=0;i<L.sz.length;i++) {\n\t\t\t\t\t\t//prefix with a \\0, impossible for normal string\n\t\t\t\t\t\to[keys[i]]=strsep+offset.toString(16)\n\t\t\t\t\t\t\t   +strsep+L.sz[i].toString(16);\n\t\t\t\t\t\toffset+=L.sz[i];\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tvar taskqueue=[];\n\t\t\t\t\tfor (var i=0;i<L.count;i++) {\n\t\t\t\t\t\ttaskqueue.push(\n\t\t\t\t\t\t\t(function(sz,key){\n\t\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t\tfunction(data){\n\t\t\t\t\t\t\t\t\t\tif (typeof data=='object' && data.__empty) {\n\t\t\t\t\t\t\t\t\t\t\t//not saving the first call;\n\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\to[key]=data; \n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\topts.blocksize=sz;\n\t\t\t\t\t\t\t\t\t\tif (verbose) readLog(\"key\",key);\n\t\t\t\t\t\t\t\t\t\tload.apply(that,[opts, taskqueue.shift()]);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t})(L.sz[i],keys[i-1])\n\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\t//last call to child load\n\t\t\t\t\ttaskqueue.push(function(data){\n\t\t\t\t\t\to[keys[keys.length-1]]=data;\n\t\t\t\t\t\topts.cur=endcur;\n\t\t\t\t\t\tcb.apply(that,[o]);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tif (opts.lazy) cb.apply(that,[o]);\n\t\t\t\telse {\n\t\t\t\t\ttaskqueue.shift()({__empty:true});\n\t\t\t\t}\n\t\t\t}]);\n\t\t}]);\n\t}\n\n\t//item is same known type\n\tvar loadStringArray=function(opts,blocksize,encoding,cb) {\n\t\tvar that=this;\n\t\tthis.fs.readStringArray(opts.cur,blocksize,encoding,function(o){\n\t\t\topts.cur+=blocksize;\n\t\t\tcb.apply(that,[o]);\n\t\t});\n\t}\n\tvar loadIntegerArray=function(opts,blocksize,unitsize,cb) {\n\t\tvar that=this;\n\t\tloadVInt1.apply(this,[opts,function(count){\n\t\t\tvar o=that.fs.readFixedArray(opts.cur,count,unitsize,function(o){\n\t\t\t\topts.cur+=count*unitsize;\n\t\t\t\tcb.apply(that,[o]);\n\t\t\t});\n\t\t}]);\n\t}\n\tvar loadBlob=function(blocksize,cb) {\n\t\tvar o=this.fs.readBuf(this.cur,blocksize);\n\t\tthis.cur+=blocksize;\n\t\treturn o;\n\t}\t\n\tvar loadbysignature=function(opts,signature,cb) {\n\t\t  var blocksize=opts.blocksize||this.fs.size; \n\t\t\topts.cur+=this.fs.signature_size;\n\t\t\tvar datasize=blocksize-this.fs.signature_size;\n\t\t\t//basic types\n\t\t\tif (signature===DT.int32) {\n\t\t\t\topts.cur+=4;\n\t\t\t\tthis.fs.readI32(opts.cur-4,cb);\n\t\t\t} else if (signature===DT.uint8) {\n\t\t\t\topts.cur++;\n\t\t\t\tthis.fs.readUI8(opts.cur-1,cb);\n\t\t\t} else if (signature===DT.utf8) {\n\t\t\t\tvar c=opts.cur;opts.cur+=datasize;\n\t\t\t\tthis.fs.readString(c,datasize,'utf8',cb);\n\t\t\t} else if (signature===DT.ucs2) {\n\t\t\t\tvar c=opts.cur;opts.cur+=datasize;\n\t\t\t\tthis.fs.readString(c,datasize,'ucs2',cb);\t\n\t\t\t} else if (signature===DT.bool) {\n\t\t\t\topts.cur++;\n\t\t\t\tthis.fs.readUI8(opts.cur-1,function(data){cb(!!data)});\n\t\t\t} else if (signature===DT.blob) {\n\t\t\t\tloadBlob(datasize,cb);\n\t\t\t}\n\t\t\t//variable length integers\n\t\t\telse if (signature===DT.vint) {\n\t\t\t\tloadVInt.apply(this,[opts,datasize,datasize,cb]);\n\t\t\t}\n\t\t\telse if (signature===DT.pint) {\n\t\t\t\tloadPInt.apply(this,[opts,datasize,datasize,cb]);\n\t\t\t}\n\t\t\t//simple array\n\t\t\telse if (signature===DT.utf8arr) {\n\t\t\t\tloadStringArray.apply(this,[opts,datasize,'utf8',cb]);\n\t\t\t}\n\t\t\telse if (signature===DT.ucs2arr) {\n\t\t\t\tloadStringArray.apply(this,[opts,datasize,'ucs2',cb]);\n\t\t\t}\n\t\t\telse if (signature===DT.uint8arr) {\n\t\t\t\tloadIntegerArray.apply(this,[opts,datasize,1,cb]);\n\t\t\t}\n\t\t\telse if (signature===DT.int32arr) {\n\t\t\t\tloadIntegerArray.apply(this,[opts,datasize,4,cb]);\n\t\t\t}\n\t\t\t//nested structure\n\t\t\telse if (signature===DT.array) {\n\t\t\t\tloadArray.apply(this,[opts,datasize,cb]);\n\t\t\t}\n\t\t\telse if (signature===DT.object) {\n\t\t\t\tloadObject.apply(this,[opts,datasize,cb]);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tconsole.error('unsupported type',signature,opts)\n\t\t\t\tcb.apply(this,[null]);//make sure it return\n\t\t\t\t//throw 'unsupported type '+signature;\n\t\t\t}\n\t}\n\n\tvar load=function(opts,cb) {\n\t\topts=opts||{}; // this will served as context for entire load procedure\n\t\topts.cur=opts.cur||0;\n\t\tvar that=this;\n\t\tthis.fs.readSignature(opts.cur, function(signature){\n\t\t\tloadbysignature.apply(that,[opts,signature,cb])\n\t\t});\n\t\treturn this;\n\t}\n\tvar CACHE=null;\n\tvar KEY={};\n\tvar ADDRESS={};\n\tvar reset=function(cb) {\n\t\tif (!CACHE) {\n\t\t\tload.apply(this,[{cur:0,lazy:true},function(data){\n\t\t\t\tCACHE=data;\n\t\t\t\tcb.call(this);\n\t\t\t}]);\t\n\t\t} else {\n\t\t\tcb.call(this);\n\t\t}\n\t}\n\n\tvar exists=function(path,cb) {\n\t\tif (path.length==0) return true;\n\t\tvar key=path.pop();\n\t\tvar that=this;\n\t\tget.apply(this,[path,false,function(data){\n\t\t\tif (!path.join(strsep)) return (!!KEY[key]);\n\t\t\tvar keys=KEY[path.join(strsep)];\n\t\t\tpath.push(key);//put it back\n\t\t\tif (keys) cb.apply(that,[keys.indexOf(key)>-1]);\n\t\t\telse cb.apply(that,[false]);\n\t\t}]);\n\t}\n\n\tvar getSync=function(path) {\n\t\tif (!CACHE) return undefined;\t\n\t\tvar o=CACHE;\n\t\tfor (var i=0;i<path.length;i++) {\n\t\t\tvar r=o[path[i]];\n\t\t\tif (typeof r==\"undefined\") return null;\n\t\t\to=r;\n\t\t}\n\t\treturn o;\n\t}\n\tvar get=function(path,opts,cb) {\n\t\tif (typeof path=='undefined') path=[];\n\t\tif (typeof path==\"string\") path=[path];\n\t\t//opts.recursive=!!opts.recursive;\n\t\tif (typeof opts==\"function\") {\n\t\t\tcb=opts;node\n\t\t\topts={};\n\t\t}\n\t\tvar that=this;\n\t\tif (typeof cb!='function') return getSync(path);\n\n\t\treset.apply(this,[function(){\n\t\t\tvar o=CACHE;\n\t\t\tif (path.length==0) {\n\t\t\t\tif (opts.address) {\n\t\t\t\t\tcb([0,that.fs.size]);\n\t\t\t\t} else {\n\t\t\t\t\tcb(Object.keys(CACHE));\t\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t} \n\t\t\t\n\t\t\tvar pathnow=\"\",taskqueue=[],newopts={},r=null;\n\t\t\tvar lastkey=\"\";\n\n\t\t\tfor (var i=0;i<path.length;i++) {\n\t\t\t\tvar task=(function(key,k){\n\n\t\t\t\t\treturn (function(data){\n\t\t\t\t\t\tif (!(typeof data=='object' && data.__empty)) {\n\t\t\t\t\t\t\tif (typeof o[lastkey]=='string' && o[lastkey][0]==strsep) o[lastkey]={};\n\t\t\t\t\t\t\to[lastkey]=data; \n\t\t\t\t\t\t\to=o[lastkey];\n\t\t\t\t\t\t\tr=data[key];\n\t\t\t\t\t\t\tKEY[pathnow]=opts.keys;\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tdata=o[key];\n\t\t\t\t\t\t\tr=data;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (typeof r===\"undefined\") {\n\t\t\t\t\t\t\ttaskqueue=null;\n\t\t\t\t\t\t\tcb.apply(that,[r]); //return empty value\n\t\t\t\t\t\t} else {\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif (parseInt(k)) pathnow+=strsep;\n\t\t\t\t\t\t\tpathnow+=key;\n\t\t\t\t\t\t\tif (typeof r=='string' && r[0]==strsep) { //offset of data to be loaded\n\t\t\t\t\t\t\t\tvar p=r.substring(1).split(strsep).map(function(item){return parseInt(item,16)});\n\t\t\t\t\t\t\t\tvar cur=p[0],sz=p[1];\n\t\t\t\t\t\t\t\tnewopts.lazy=!opts.recursive || (k<path.length-1) ;\n\t\t\t\t\t\t\t\tnewopts.blocksize=sz;newopts.cur=cur,newopts.keys=[];\n\t\t\t\t\t\t\t\tlastkey=key; //load is sync in android\n\t\t\t\t\t\t\t\tif (opts.address && taskqueue.length==1) {\n\t\t\t\t\t\t\t\t\tADDRESS[pathnow]=[cur,sz];\n\t\t\t\t\t\t\t\t\ttaskqueue.shift()(null,ADDRESS[pathnow]);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tload.apply(that,[newopts, taskqueue.shift()]);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tif (opts.address && taskqueue.length==1) {\n\t\t\t\t\t\t\t\t\ttaskqueue.shift()(null,ADDRESS[pathnow]);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\ttaskqueue.shift().apply(that,[r]);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\t\t(path[i],i);\n\t\t\t\t\n\t\t\t\ttaskqueue.push(task);\n\t\t\t}\n\n\t\t\tif (taskqueue.length==0) {\n\t\t\t\tcb.apply(that,[o]);\n\t\t\t} else {\n\t\t\t\t//last call to child load\n\t\t\t\ttaskqueue.push(function(data,cursz){\n\t\t\t\t\tif (opts.address) {\n\t\t\t\t\t\tcb.apply(that,[cursz]);\n\t\t\t\t\t} else{\n\t\t\t\t\t\tvar key=path[path.length-1];\n\t\t\t\t\t\to[key]=data; KEY[pathnow]=opts.keys;\n\t\t\t\t\t\tcb.apply(that,[data]);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\ttaskqueue.shift()({__empty:true});\t\t\t\n\t\t\t}\n\n\t\t}]); //reset\n\t}\n\t// get all keys in given path\n\tvar getkeys=function(path,cb) {\n\t\tif (!path) path=[]\n\t\tvar that=this;\n\t\tget.apply(this,[path,false,function(){\n\t\t\tif (path && path.length) {\n\t\t\t\tcb.apply(that,[KEY[path.join(strsep)]]);\n\t\t\t} else {\n\t\t\t\tcb.apply(that,[Object.keys(CACHE)]); \n\t\t\t\t//top level, normally it is very small\n\t\t\t}\n\t\t}]);\n\t}\n\n\tvar setupapi=function() {\n\t\tthis.load=load;\n//\t\tthis.cur=0;\n\t\tthis.cache=function() {return CACHE};\n\t\tthis.key=function() {return KEY};\n\t\tthis.free=function() {\n\t\t\tCACHE=null;\n\t\t\tKEY=null;\n\t\t\tthis.fs.free();\n\t\t}\n\t\tthis.setCache=function(c) {CACHE=c};\n\t\tthis.keys=getkeys;\n\t\tthis.get=get;   // get a field, load if needed\n\t\tthis.exists=exists;\n\t\tthis.DT=DT;\n\t\t\n\t\t//install the sync version for node\n\t\t//if (typeof process!=\"undefined\") require(\"./kdb_sync\")(this);\n\t\t//if (cb) setTimeout(cb.bind(this),0);\n\t\tvar that=this;\n\t\tvar err=0;\n\t\tif (cb) {\n\t\t\tsetTimeout(function(){\n\t\t\t\tcb(err,that);\t\n\t\t\t},0);\n\t\t}\n\t}\n\tvar that=this;\n\tvar kfs=new Kfs(path,opts,function(err){\n\t\tif (err) {\n\t\t\tsetTimeout(function(){\n\t\t\t\tcb(err,0);\n\t\t\t},0);\n\t\t\treturn null;\n\t\t} else {\n\t\t\tthat.size=this.size;\n\t\t\tsetupapi.call(that);\t\t\t\n\t\t}\n\t});\n\tthis.fs=kfs;\n\treturn this;\n}\n\nCreate.datatypes=DT;\n\nif (module) module.exports=Create;\n//return Create;\n",
    "/* node.js and html5 file system abstraction layer*/\ntry {\n\tvar fs=require(\"fs\");\n\tvar Buffer=require(\"buffer\").Buffer;\n} catch (e) {\n\tvar fs=require('./html5read');\n\tvar Buffer=function(){ return \"\"};\n\tvar html5fs=true; \t\n}\nvar signature_size=1;\nvar verbose=0, readLog=function(){};\nvar _readLog=function(readtype,bytes) {\n\tconsole.log(readtype,bytes,\"bytes\");\n}\nif (verbose) readLog=_readLog;\n\nvar unpack_int = function (ar, count , reset) {\n   count=count||ar.length;\n  var r = [], i = 0, v = 0;\n  do {\n\tvar shift = 0;\n\tdo {\n\t  v += ((ar[i] & 0x7F) << shift);\n\t  shift += 7;\t  \n\t} while (ar[++i] & 0x80);\n\tr.push(v); if (reset) v=0;\n\tcount--;\n  } while (i<ar.length && count);\n  return {data:r, adv:i };\n}\nvar Open=function(path,opts,cb) {\n\topts=opts||{};\n\n\tvar readSignature=function(pos,cb) {\n\t\tvar buf=new Buffer(signature_size);\n\t\tvar that=this;\n\t\tfs.read(this.handle,buf,0,signature_size,pos,function(err,len,buffer){\n\t\t\tif (html5fs) var signature=String.fromCharCode((new Uint8Array(buffer))[0])\n\t\t\telse var signature=buffer.toString('utf8',0,signature_size);\n\t\t\tcb.apply(that,[signature]);\n\t\t});\n\t}\n\n\t//this is quite slow\n\t//wait for StringView +ArrayBuffer to solve the problem\n\t//https://groups.google.com/a/chromium.org/forum/#!topic/blink-dev/ylgiNY_ZSV0\n\t//if the string is always ucs2\n\t//can use Uint16 to read it.\n\t//http://updates.html5rocks.com/2012/06/How-to-convert-ArrayBuffer-to-and-from-String\n\tvar decodeutf8 = function (utftext) {\n\t\tvar string = \"\";\n\t\tvar i = 0;\n\t\tvar c=0,c1 = 0, c2 = 0 , c3=0;\n\t\tfor (var i=0;i<utftext.length;i++) {\n\t\t\tif (utftext.charCodeAt(i)>127) break;\n\t\t}\n\t\tif (i>=utftext.length) return utftext;\n\n\t\twhile ( i < utftext.length ) {\n\t\t\tc = utftext.charCodeAt(i);\n\t\t\tif (c < 128) {\n\t\t\t\tstring += utftext[i];\n\t\t\t\ti++;\n\t\t\t} else if((c > 191) && (c < 224)) {\n\t\t\t\tc2 = utftext.charCodeAt(i+1);\n\t\t\t\tstring += String.fromCharCode(((c & 31) << 6) | (c2 & 63));\n\t\t\t\ti += 2;\n\t\t\t} else {\n\t\t\t\tc2 = utftext.charCodeAt(i+1);\n\t\t\t\tc3 = utftext.charCodeAt(i+2);\n\t\t\t\tstring += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));\n\t\t\t\ti += 3;\n\t\t\t}\n\t\t}\n\t\treturn string;\n\t}\n\n\tvar readString= function(pos,blocksize,encoding,cb) {\n\t\tencoding=encoding||'utf8';\n\t\tvar buffer=new Buffer(blocksize);\n\t\tvar that=this;\n\t\tfs.read(this.handle,buffer,0,blocksize,pos,function(err,len,buffer){\n\t\t\treadLog(\"string\",len);\n\t\t\tif (html5fs) {\n\t\t\t\tif (encoding=='utf8') {\n\t\t\t\t\tvar str=decodeutf8(String.fromCharCode.apply(null, new Uint8Array(buffer)))\n\t\t\t\t} else { //ucs2 is 3 times faster\n\t\t\t\t\tvar str=String.fromCharCode.apply(null, new Uint16Array(buffer))\t\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tcb.apply(that,[str]);\n\t\t\t} \n\t\t\telse cb.apply(that,[buffer.toString(encoding)]);\t\n\t\t});\n\t}\n\n\t//work around for chrome fromCharCode cannot accept huge array\n\t//https://code.google.com/p/chromium/issues/detail?id=56588\n\tvar buf2stringarr=function(buf,enc) {\n\t\tif (enc==\"utf8\") \tvar arr=new Uint8Array(buf);\n\t\telse var arr=new Uint16Array(buf);\n\t\tvar i=0,codes=[],out=[],s=\"\";\n\t\twhile (i<arr.length) {\n\t\t\tif (arr[i]) {\n\t\t\t\tcodes[codes.length]=arr[i];\n\t\t\t} else {\n\t\t\t\ts=String.fromCharCode.apply(null,codes);\n\t\t\t\tif (enc==\"utf8\") out[out.length]=decodeutf8(s);\n\t\t\t\telse out[out.length]=s;\n\t\t\t\tcodes=[];\t\t\t\t\n\t\t\t}\n\t\t\ti++;\n\t\t}\n\t\t\n\t\ts=String.fromCharCode.apply(null,codes);\n\t\tif (enc==\"utf8\") out[out.length]=decodeutf8(s);\n\t\telse out[out.length]=s;\n\n\t\treturn out;\n\t}\n\tvar readStringArray = function(pos,blocksize,encoding,cb) {\n\t\tvar that=this,out=null;\n\t\tif (blocksize==0) return [];\n\t\tencoding=encoding||'utf8';\n\t\tvar buffer=new Buffer(blocksize);\n\t\tfs.read(this.handle,buffer,0,blocksize,pos,function(err,len,buffer){\n\t\t\tif (html5fs) {\n\t\t\t\treadLog(\"stringArray\",buffer.byteLength);\n\n\t\t\t\tif (encoding=='utf8') {\n\t\t\t\t\tout=buf2stringarr(buffer,\"utf8\");\n\t\t\t\t} else { //ucs2 is 3 times faster\n\t\t\t\t\tout=buf2stringarr(buffer,\"ucs2\");\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treadLog(\"stringArray\",buffer.length);\n\t\t\t\tout=buffer.toString(encoding).split('\\0');\n\t\t\t} \t\n\t\t\tcb.apply(that,[out]);\n\t\t});\n\t}\n\tvar readUI32=function(pos,cb) {\n\t\tvar buffer=new Buffer(4);\n\t\tvar that=this;\n\t\tfs.read(this.handle,buffer,0,4,pos,function(err,len,buffer){\n\t\t\treadLog(\"ui32\",len);\n\t\t\tif (html5fs){\n\t\t\t\t//v=(new Uint32Array(buffer))[0];\n\t\t\t\tvar v=new DataView(buffer).getUint32(0, false)\n\t\t\t\tcb(v);\n\t\t\t}\n\t\t\telse cb.apply(that,[buffer.readInt32BE(0)]);\t\n\t\t});\t\t\n\t}\n\n\tvar readI32=function(pos,cb) {\n\t\tvar buffer=new Buffer(4);\n\t\tvar that=this;\n\t\tfs.read(this.handle,buffer,0,4,pos,function(err,len,buffer){\n\t\t\treadLog(\"i32\",len);\n\t\t\tif (html5fs){\n\t\t\t\tvar v=new DataView(buffer).getInt32(0, false)\n\t\t\t\tcb(v);\n\t\t\t}\n\t\t\telse  \tcb.apply(that,[buffer.readInt32BE(0)]);\t\n\t\t});\n\t}\n\tvar readUI8=function(pos,cb) {\n\t\tvar buffer=new Buffer(1);\n\t\tvar that=this;\n\n\t\tfs.read(this.handle,buffer,0,1,pos,function(err,len,buffer){\n\t\t\treadLog(\"ui8\",len);\n\t\t\tif (html5fs)cb( (new Uint8Array(buffer))[0]) ;\n\t\t\telse  \t\t\tcb.apply(that,[buffer.readUInt8(0)]);\t\n\t\t\t\n\t\t});\n\t}\n\tvar readBuf=function(pos,blocksize,cb) {\n\t\tvar that=this;\n\t\tvar buf=new Buffer(blocksize);\n\t\tfs.read(this.handle,buf,0,blocksize,pos,function(err,len,buffer){\n\t\t\treadLog(\"buf\",len);\n\t\t\tvar buff=new Uint8Array(buffer)\n\t\t\tcb.apply(that,[buff]);\n\t\t});\n\t}\n\tvar readBuf_packedint=function(pos,blocksize,count,reset,cb) {\n\t\tvar that=this;\n\t\treadBuf.apply(this,[pos,blocksize,function(buffer){\n\t\t\tcb.apply(that,[unpack_int(buffer,count,reset)]);\t\n\t\t}]);\n\t\t\n\t}\n\tvar readFixedArray_html5fs=function(pos,count,unitsize,cb) {\n\t\tvar func=null;\n\t\tif (unitsize===1) {\n\t\t\tfunc='getUint8';//Uint8Array;\n\t\t} else if (unitsize===2) {\n\t\t\tfunc='getUint16';//Uint16Array;\n\t\t} else if (unitsize===4) {\n\t\t\tfunc='getUint32';//Uint32Array;\n\t\t} else throw 'unsupported integer size';\n\n\t\tfs.read(this.handle,null,0,unitsize*count,pos,function(err,len,buffer){\n\t\t\treadLog(\"fix array\",len);\n\t\t\tvar out=[];\n\t\t\tif (unitsize==1) {\n\t\t\t\tout=new Uint8Array(buffer);\n\t\t\t} else {\n\t\t\t\tfor (var i = 0; i < len / unitsize; i++) { //endian problem\n\t\t\t\t//\tout.push( func(buffer,i*unitsize));\n\t\t\t\t\tout.push( v=new DataView(buffer)[func](i,false) );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tcb.apply(that,[out]);\n\t\t});\n\t}\n\t// signature, itemcount, payload\n\tvar readFixedArray = function(pos ,count, unitsize,cb) {\n\t\tvar func=null;\n\t\tvar that=this;\n\t\t\n\t\tif (unitsize* count>this.size && this.size)  {\n\t\t\tconsole.log(\"array size exceed file size\",this.size)\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tif (html5fs) return readFixedArray_html5fs.apply(this,[pos,count,unitsize,cb]);\n\n\t\tvar items=new Buffer( unitsize* count);\n\t\tif (unitsize===1) {\n\t\t\tfunc=items.readUInt8;\n\t\t} else if (unitsize===2) {\n\t\t\tfunc=items.readUInt16BE;\n\t\t} else if (unitsize===4) {\n\t\t\tfunc=items.readUInt32BE;\n\t\t} else throw 'unsupported integer size';\n\t\t//console.log('itemcount',itemcount,'buffer',buffer);\n\n\t\tfs.read(this.handle,items,0,unitsize*count,pos,function(err,len,buffer){\n\t\t\treadLog(\"fix array\",len);\n\t\t\tvar out=[];\n\t\t\tfor (var i = 0; i < items.length / unitsize; i++) {\n\t\t\t\tout.push( func.apply(items,[i*unitsize]));\n\t\t\t}\n\t\t\tcb.apply(that,[out]);\n\t\t});\n\t}\n\n\tvar free=function() {\n\t\t//console.log('closing ',handle);\n\t\tfs.closeSync(this.handle);\n\t}\n\tvar setupapi=function() {\n\t\tvar that=this;\n\t\tthis.readSignature=readSignature;\n\t\tthis.readI32=readI32;\n\t\tthis.readUI32=readUI32;\n\t\tthis.readUI8=readUI8;\n\t\tthis.readBuf=readBuf;\n\t\tthis.readBuf_packedint=readBuf_packedint;\n\t\tthis.readFixedArray=readFixedArray;\n\t\tthis.readString=readString;\n\t\tthis.readStringArray=readStringArray;\n\t\tthis.signature_size=signature_size;\n\t\tthis.free=free;\n\t\tif (html5fs) {\n\t\t\tvar fn=path;\n\t\t\tif (path.indexOf(\"filesystem:\")==0) fn=path.substr(path.lastIndexOf(\"/\"));\n\t\t\tfs.fs.root.getFile(fn,{},function(entry){\n\t\t\t  entry.getMetadata(function(metadata) { \n\t\t\t\tthat.size=metadata.size;\n\t\t\t\tif (cb) setTimeout(cb.bind(that),0);\n\t\t\t\t});\n\t\t\t});\n\t\t} else {\n\t\t\tvar stat=fs.fstatSync(this.handle);\n\t\t\tthis.stat=stat;\n\t\t\tthis.size=stat.size;\t\t\n\t\t\tif (cb)\tsetTimeout(cb.bind(this,0),0);\t\n\t\t}\n\t}\n\n\tvar that=this;\n\tif (html5fs) {\n\t\tfs.open(path,function(h){\n\t\t\tif (!h) {\n\t\t\t\tif (cb)\tsetTimeout(cb.bind(null,\"file not found:\"+path),0);\t\n\t\t\t} else {\n\t\t\t\tthat.handle=h;\n\t\t\t\tthat.html5fs=true;\n\t\t\t\tsetupapi.call(that);\n\t\t\t\tthat.opened=true;\t\t\t\t\n\t\t\t}\n\t\t})\n\t} else {\n\t\tif (fs.existsSync(path)){\n\t\t\tthis.handle=fs.openSync(path,'r');//,function(err,handle){\n\t\t\tthis.opened=true;\n\t\t\tsetupapi.call(this);\n\t\t} else {\n\t\t\tif (cb)\tsetTimeout(cb.bind(null,\"file not found:\"+path),0);\t\n\t\t\treturn null;\n\t\t}\n\t}\n\treturn this;\n}\nmodule.exports=Open;",
    "/*\n  JAVA can only return Number and String\n\tarray and buffer return in string format\n\tneed JSON.parse\n*/\nvar verbose=0;\n\nvar readSignature=function(pos,cb) {\n\tif (verbose) console.debug(\"read signature\");\n\tvar signature=kfs.readUTF8String(this.handle,pos,1);\n\tif (verbose) console.debug(signature,signature.charCodeAt(0));\n\tcb.apply(this,[signature]);\n}\nvar readI32=function(pos,cb) {\n\tif (verbose) console.debug(\"read i32 at \"+pos);\n\tvar i32=kfs.readInt32(this.handle,pos);\n\tif (verbose) console.debug(i32);\n\tcb.apply(this,[i32]);\t\n}\nvar readUI32=function(pos,cb) {\n\tif (verbose) console.debug(\"read ui32 at \"+pos);\n\tvar ui32=kfs.readUInt32(this.handle,pos);\n\tif (verbose) console.debug(ui32);\n\tcb.apply(this,[ui32]);\n}\nvar readUI8=function(pos,cb) {\n\tif (verbose) console.debug(\"read ui8 at \"+pos); \n\tvar ui8=kfs.readUInt8(this.handle,pos);\n\tif (verbose) console.debug(ui8);\n\tcb.apply(this,[ui8]);\n}\nvar readBuf=function(pos,blocksize,cb) {\n\tif (verbose) console.debug(\"read buffer at \"+pos+ \" blocksize \"+blocksize);\n\tvar buf=kfs.readBuf(this.handle,pos,blocksize);\n\tvar buff=JSON.parse(buf);\n\tif (verbose) console.debug(\"buffer length\"+buff.length);\n\tcb.apply(this,[buff]);\t\n}\nvar readBuf_packedint=function(pos,blocksize,count,reset,cb) {\n\tif (verbose) console.debug(\"read packed int at \"+pos+\" blocksize \"+blocksize+\" count \"+count);\n\tvar buf=kfs.readBuf_packedint(this.handle,pos,blocksize,count,reset);\n\tvar adv=parseInt(buf);\n\tvar buff=JSON.parse(buf.substr(buf.indexOf(\"[\")));\n\tif (verbose) console.debug(\"packedInt length \"+buff.length+\" first item=\"+buff[0]);\n\tcb.apply(this,[{data:buff,adv:adv}]);\t\n}\n\n\nvar readString= function(pos,blocksize,encoding,cb) {\n\tif (verbose) console.debug(\"readstring at \"+pos+\" blocksize \" +blocksize+\" enc:\"+encoding);\n\tif (encoding==\"ucs2\") {\n\t\tvar str=kfs.readULE16String(this.handle,pos,blocksize);\n\t} else {\n\t\tvar str=kfs.readUTF8String(this.handle,pos,blocksize);\t\n\t}\t \n\tif (verbose) console.debug(str);\n\tcb.apply(this,[str]);\t\n}\n\nvar readFixedArray = function(pos ,count, unitsize,cb) {\n\tif (verbose) console.debug(\"read fixed array at \"+pos+\" count \"+count+\" unitsize \"+unitsize); \n\tvar buf=kfs.readFixedArray(this.handle,pos,count,unitsize);\n\tvar buff=JSON.parse(buf);\n\tif (verbose) console.debug(\"array length\"+buff.length);\n\tcb.apply(this,[buff]);\t\n}\nvar readStringArray = function(pos,blocksize,encoding,cb) {\n\tif (verbose) console.log(\"read String array at \"+pos+\" blocksize \"+blocksize +\" enc \"+encoding); \n\tencoding = encoding||\"utf8\";\n\tvar buf=kfs.readStringArray(this.handle,pos,blocksize,encoding);\n\t//var buff=JSON.parse(buf);\n\tif (verbose) console.debug(\"read string array\");\n\tvar buff=buf.split(\"\\uffff\"); //cannot return string with 0\n\tif (verbose) console.debug(\"array length\"+buff.length);\n\tcb.apply(this,[buff]);\t\n}\nvar mergePostings=function(positions,cb) {\n\tvar buf=kfs.mergePostings(this.handle,JSON.stringify(positions));\n\tif (!buf || buf.length==0) return [];\n\telse return JSON.parse(buf);\n}\n\nvar free=function() {\n\t//console.log('closing ',handle);\n\tkfs.close(this.handle);\n}\nvar Open=function(path,opts,cb) {\n\topts=opts||{};\n\tvar signature_size=1;\n\tvar setupapi=function() { \n\t\tthis.readSignature=readSignature;\n\t\tthis.readI32=readI32;\n\t\tthis.readUI32=readUI32;\n\t\tthis.readUI8=readUI8;\n\t\tthis.readBuf=readBuf;\n\t\tthis.readBuf_packedint=readBuf_packedint;\n\t\tthis.readFixedArray=readFixedArray;\n\t\tthis.readString=readString;\n\t\tthis.readStringArray=readStringArray;\n\t\tthis.signature_size=signature_size;\n\t\tthis.mergePostings=mergePostings;\n\t\tthis.free=free;\n\t\tthis.size=kfs.getFileSize(this.handle);\n\t\tif (verbose) console.log(\"filesize  \"+this.size);\n\t\tif (cb)\tcb.call(this);\n\t}\n\n\tthis.handle=kfs.open(path);\n\tthis.opened=true;\n\tsetupapi.call(this);\n\treturn this;\n}\n\nmodule.exports=Open;",
    "/*\n  JSContext can return all Javascript types.\n*/\nvar verbose=1;\n\nvar readSignature=function(pos,cb) {\n\tif (verbose)  ksanagap.log(\"read signature at \"+pos);\n\tvar signature=kfs.readUTF8String(this.handle,pos,1);\n\tif (verbose)  ksanagap.log(signature+\" \"+signature.charCodeAt(0));\n\tcb.apply(this,[signature]);\n}\nvar readI32=function(pos,cb) {\n\tif (verbose)  ksanagap.log(\"read i32 at \"+pos);\n\tvar i32=kfs.readInt32(this.handle,pos);\n\tif (verbose)  ksanagap.log(i32);\n\tcb.apply(this,[i32]);\t\n}\nvar readUI32=function(pos,cb) {\n\tif (verbose)  ksanagap.log(\"read ui32 at \"+pos);\n\tvar ui32=kfs.readUInt32(this.handle,pos);\n\tif (verbose)  ksanagap.log(ui32);\n\tcb.apply(this,[ui32]);\n}\nvar readUI8=function(pos,cb) {\n\tif (verbose)  ksanagap.log(\"read ui8 at \"+pos); \n\tvar ui8=kfs.readUInt8(this.handle,pos);\n\tif (verbose)  ksanagap.log(ui8);\n\tcb.apply(this,[ui8]);\n}\nvar readBuf=function(pos,blocksize,cb) {\n\tif (verbose)  ksanagap.log(\"read buffer at \"+pos);\n\tvar buf=kfs.readBuf(this.handle,pos,blocksize);\n\tif (verbose)  ksanagap.log(\"buffer length\"+buf.length);\n\tcb.apply(this,[buf]);\t\n}\nvar readBuf_packedint=function(pos,blocksize,count,reset,cb) {\n\tif (verbose)  ksanagap.log(\"read packed int fast, blocksize \"+blocksize+\" at \"+pos);var t=new Date();\n\tvar buf=kfs.readBuf_packedint(this.handle,pos,blocksize,count,reset);\n\tif (verbose)  ksanagap.log(\"return from packedint, time\" + (new Date()-t));\n\tif (typeof buf.data==\"string\") {\n\t\tbuf.data=eval(\"[\"+buf.data.substr(0,buf.data.length-1)+\"]\");\n\t}\n\tif (verbose)  ksanagap.log(\"unpacked length\"+buf.data.length+\" time\" + (new Date()-t) );\n\tcb.apply(this,[buf]);\n}\n\n\nvar readString= function(pos,blocksize,encoding,cb) {\n\n\tif (verbose)  ksanagap.log(\"readstring at \"+pos+\" blocksize \"+blocksize+\" \"+encoding);var t=new Date();\n\tif (encoding==\"ucs2\") {\n\t\tvar str=kfs.readULE16String(this.handle,pos,blocksize);\n\t} else {\n\t\tvar str=kfs.readUTF8String(this.handle,pos,blocksize);\t\n\t}\n\tif (verbose)  ksanagap.log(str+\" time\"+(new Date()-t));\n\tcb.apply(this,[str]);\t\n}\n\nvar readFixedArray = function(pos ,count, unitsize,cb) {\n\tif (verbose)  ksanagap.log(\"read fixed array at \"+pos); var t=new Date();\n\tvar buf=kfs.readFixedArray(this.handle,pos,count,unitsize);\n\tif (verbose)  ksanagap.log(\"array length \"+buf.length+\" time\"+(new Date()-t));\n\tcb.apply(this,[buf]);\t\n}\nvar readStringArray = function(pos,blocksize,encoding,cb) {\n\t//if (verbose)  ksanagap.log(\"read String array \"+blocksize +\" \"+encoding); \n\tencoding = encoding||\"utf8\";\n\tif (verbose)  ksanagap.log(\"read string array at \"+pos);var t=new Date();\n\tvar buf=kfs.readStringArray(this.handle,pos,blocksize,encoding);\n\tif (typeof buf==\"string\") buf=buf.split(\"\\0\");\n\t//var buff=JSON.parse(buf);\n\t//var buff=buf.split(\"\\uffff\"); //cannot return string with 0\n\tif (verbose)  ksanagap.log(\"string array length\"+buf.length+\" time\"+(new Date()-t));\n\tcb.apply(this,[buf]);\n}\n\nvar mergePostings=function(positions) {\n\tvar buf=kfs.mergePostings(this.handle,positions);\n\tif (typeof buf==\"string\") {\n\t\tbuf=eval(\"[\"+buf.substr(0,buf.length-1)+\"]\");\n\t}\n\treturn buf;\n}\nvar free=function() {\n\t////if (verbose)  ksanagap.log('closing ',handle);\n\tkfs.close(this.handle);\n}\nvar Open=function(path,opts,cb) {\n\topts=opts||{};\n\tvar signature_size=1;\n\tvar setupapi=function() { \n\t\tthis.readSignature=readSignature;\n\t\tthis.readI32=readI32;\n\t\tthis.readUI32=readUI32;\n\t\tthis.readUI8=readUI8;\n\t\tthis.readBuf=readBuf;\n\t\tthis.readBuf_packedint=readBuf_packedint;\n\t\tthis.readFixedArray=readFixedArray;\n\t\tthis.readString=readString;\n\t\tthis.readStringArray=readStringArray;\n\t\tthis.signature_size=signature_size;\n\t\tthis.mergePostings=mergePostings;\n\t\tthis.free=free;\n\t\tthis.size=kfs.getFileSize(this.handle);\n\t\tif (verbose)  ksanagap.log(\"filesize  \"+this.size);\n\t\tif (cb)\tcb.call(this);\n\t}\n\n\tthis.handle=kfs.open(path);\n\tthis.opened=true;\n\tsetupapi.call(this);\n\treturn this;\n}\n\nmodule.exports=Open;",
    "/*\n  convert any json into a binary buffer\n  the buffer can be saved with a single line of fs.writeFile\n*/\n\nvar DT={\n\tuint8:'1', //unsigned 1 byte integer\n\tint32:'4', // signed 4 bytes integer\n\tutf8:'8',  \n\tucs2:'2',\n\tbool:'^', \n\tblob:'&',\n\tutf8arr:'*', //shift of 8\n\tucs2arr:'@', //shift of 2\n\tuint8arr:'!', //shift of 1\n\tint32arr:'$', //shift of 4\n\tvint:'`',\n\tpint:'~',\t\n\n\tarray:'\\u001b',\n\tobject:'\\u001a' \n\t//ydb start with object signature,\n\t//type a ydb in command prompt shows nothing\n}\nvar key_writing=\"\";//for debugging\nvar pack_int = function (ar, savedelta) { // pack ar into\n  if (!ar || ar.length === 0) return []; // empty array\n  var r = [],\n  i = 0,\n  j = 0,\n  delta = 0,\n  prev = 0;\n  \n  do {\n\tdelta = ar[i];\n\tif (savedelta) {\n\t\tdelta -= prev;\n\t}\n\tif (delta < 0) {\n\t  console.trace('negative',prev,ar[i])\n\t  throw 'negetive';\n\t  break;\n\t}\n\t\n\tr[j++] = delta & 0x7f;\n\tdelta >>= 7;\n\twhile (delta > 0) {\n\t  r[j++] = (delta & 0x7f) | 0x80;\n\t  delta >>= 7;\n\t}\n\tprev = ar[i];\n\ti++;\n  } while (i < ar.length);\n  return r;\n}\nvar Kfs=function(path,opts) {\n\t\n\tvar handle=null;\n\topts=opts||{};\n\topts.size=opts.size||65536*2048; \n\tconsole.log('kdb estimate size:',opts.size);\n\tvar dbuf=new Buffer(opts.size);\n\tvar cur=0;//dbuf cursor\n\t\n\tvar writeSignature=function(value,pos) {\n\t\tdbuf.write(value,pos,value.length,'utf8');\n\t\tif (pos+value.length>cur) cur=pos+value.length;\n\t\treturn value.length;\n\t}\n\tvar writeOffset=function(value,pos) {\n\t\tdbuf.writeUInt8(Math.floor(value / (65536*65536)),pos);\n\t\tdbuf.writeUInt32BE( value & 0xFFFFFFFF,pos+1);\n\t\tif (pos+5>cur) cur=pos+5;\n\t\treturn 5;\n\t}\n\tvar writeString= function(value,pos,encoding) {\n\t\tencoding=encoding||'ucs2';\n\t\tif (value==\"\") throw \"cannot write null string\";\n\t\tif (encoding==='utf8')dbuf.write(DT.utf8,pos,1,'utf8');\n\t\telse if (encoding==='ucs2')dbuf.write(DT.ucs2,pos,1,'utf8');\n\t\telse throw 'unsupported encoding '+encoding;\n\t\t\t\n\t\tvar len=Buffer.byteLength(value, encoding);\n\t\tdbuf.write(value,pos+1,len,encoding);\n\t\t\n\t\tif (pos+len+1>cur) cur=pos+len+1;\n\t\treturn len+1; // signature\n\t}\n\tvar writeStringArray = function(value,pos,encoding) {\n\t\tencoding=encoding||'ucs2';\n\t\tif (encoding==='utf8') dbuf.write(DT.utf8arr,pos,1,'utf8');\n\t\telse if (encoding==='ucs2')dbuf.write(DT.ucs2arr,pos,1,'utf8');\n\t\telse throw 'unsupported encoding '+encoding;\n\t\t\n\t\tvar v=value.join('\\0');\n\t\tvar len=Buffer.byteLength(v, encoding);\n\t\tif (0===len) {\n\t\t\tthrow \"empty string array \" + key_writing;\n\t\t}\n\t\tdbuf.write(v,pos+1,len,encoding);\n\t\tif (pos+len+1>cur) cur=pos+len+1;\n\t\treturn len+1;\n\t}\n\tvar writeI32=function(value,pos) {\n\t\tdbuf.write(DT.int32,pos,1,'utf8');\n\t\tdbuf.writeInt32BE(value,pos+1);\n\t\tif (pos+5>cur) cur=pos+5;\n\t\treturn 5;\n\t}\n\tvar writeUI8=function(value,pos) {\n\t\tdbuf.write(DT.uint8,pos,1,'utf8');\n\t\tdbuf.writeUInt8(value,pos+1);\n\t\tif (pos+2>cur) cur=pos+2;\n\t\treturn 2;\n\t}\n\tvar writeBool=function(value,pos) {\n\t\tdbuf.write(DT.bool,pos,1,'utf8');\n\t\tdbuf.writeUInt8(Number(value),pos+1);\n\t\tif (pos+2>cur) cur=pos+2;\n\t\treturn 2;\n\t}\t\t\n\tvar writeBlob=function(value,pos) {\n\t\tdbuf.write(DT.blob,pos,1,'utf8');\n\t\tvalue.copy(dbuf, pos+1);\n\t\tvar written=value.length+1;\n\t\tif (pos+written>cur) cur=pos+written;\n\t\treturn written;\n\t}\t\t\n\t/* no signature */\n\tvar writeFixedArray = function(value,pos,unitsize) {\n\t\t//console.log('v.len',value.length,items.length,unitsize);\n\t\tif (unitsize===1) var func=dbuf.writeUInt8;\n\t\telse if (unitsize===4)var func=dbuf.writeInt32BE;\n\t\telse throw 'unsupported integer size';\n\t\tif (!value.length) {\n\t\t\tthrow \"empty fixed array \"+key_writing;\n\t\t}\n\t\tfor (var i = 0; i < value.length ; i++) {\n\t\t\tfunc.apply(dbuf,[value[i],i*unitsize+pos])\n\t\t}\n\t\tvar len=unitsize*value.length;\n\t\tif (pos+len>cur) cur=pos+len;\n\t\treturn len;\n\t}\n\n\tthis.writeI32=writeI32;\n\tthis.writeBool=writeBool;\n\tthis.writeBlob=writeBlob;\n\tthis.writeUI8=writeUI8;\n\tthis.writeString=writeString;\n\tthis.writeSignature=writeSignature;\n\tthis.writeOffset=writeOffset; //5 bytes offset\n\tthis.writeStringArray=writeStringArray;\n\tthis.writeFixedArray=writeFixedArray;\n\tObject.defineProperty(this, \"buf\", {get : function(){ return dbuf; }});\n\t\n\treturn this;\n}\n\nvar Create=function(path,opts) {\n\topts=opts||{};\n\tvar kfs=new Kfs(path,opts);\n\tvar cur=0;\n\n\tvar handle={};\n\t\n\t//no signature\n\tvar writeVInt =function(arr) {\n\t\tvar o=pack_int(arr,false);\n\t\tkfs.writeFixedArray(o,cur,1);\n\t\tcur+=o.length;\n\t}\n\tvar writeVInt1=function(value) {\n\t\twriteVInt([value]);\n\t}\n\t//for postings\n\tvar writePInt =function(arr) {\n\t\tvar o=pack_int(arr,true);\n\t\tkfs.writeFixedArray(o,cur,1);\n\t\tcur+=o.length;\n\t}\n\t\n\tvar saveVInt = function(arr,key) {\n\t\tvar start=cur;\n\t\tkey_writing=key;\n\t\tcur+=kfs.writeSignature(DT.vint,cur);\n\t\twriteVInt(arr);\n\t\tvar written = cur-start;\n\t\tpushitem(key,written);\n\t\treturn written;\t\t\n\t}\n\tvar savePInt = function(arr,key) {\n\t\tvar start=cur;\n\t\tkey_writing=key;\n\t\tcur+=kfs.writeSignature(DT.pint,cur);\n\t\twritePInt(arr);\n\t\tvar written = cur-start;\n\t\tpushitem(key,written);\n\t\treturn written;\t\n\t}\n\n\t\n\tvar saveUI8 = function(value,key) {\n\t\tvar written=kfs.writeUI8(value,cur);\n\t\tcur+=written;\n\t\tpushitem(key,written);\n\t\treturn written;\n\t}\n\tvar saveBool=function(value,key) {\n\t\tvar written=kfs.writeBool(value,cur);\n\t\tcur+=written;\n\t\tpushitem(key,written);\n\t\treturn written;\n\t}\n\tvar saveI32 = function(value,key) {\n\t\tvar written=kfs.writeI32(value,cur);\n\t\tcur+=written;\n\t\tpushitem(key,written);\n\t\treturn written;\n\t}\t\n\tvar saveString = function(value,key,encoding) {\n\t\tencoding=encoding||stringencoding;\n\t\tkey_writing=key;\n\t\tvar written=kfs.writeString(value,cur,encoding);\n\t\tcur+=written;\n\t\tpushitem(key,written);\n\t\treturn written;\n\t}\n\tvar saveStringArray = function(arr,key,encoding) {\n\t\tencoding=encoding||stringencoding;\n\t\tkey_writing=key;\n\t\ttry {\n\t\t\tvar written=kfs.writeStringArray(arr,cur,encoding);\n\t\t} catch(e) {\n\t\t\tthrow e;\n\t\t}\n\t\tcur+=written;\n\t\tpushitem(key,written);\n\t\treturn written;\n\t}\n\t\n\tvar saveBlob = function(value,key) {\n\t\tkey_writing=key;\n\t\tvar written=kfs.writeBlob(value,cur);\n\t\tcur+=written;\n\t\tpushitem(key,written);\n\t\treturn written;\n\t}\n\n\tvar folders=[];\n\tvar pushitem=function(key,written) {\n\t\tvar folder=folders[folders.length-1];\t\n\t\tif (!folder) return ;\n\t\tfolder.itemslength.push(written);\n\t\tif (key) {\n\t\t\tif (!folder.keys) throw 'cannot have key in array';\n\t\t\tfolder.keys.push(key);\n\t\t}\n\t}\t\n\tvar open = function(opt) {\n\t\tvar start=cur;\n\t\tvar key=opt.key || null;\n\t\tvar type=opt.type||DT.array;\n\t\tcur+=kfs.writeSignature(type,cur);\n\t\tcur+=kfs.writeOffset(0x0,cur); // pre-alloc space for offset\n\t\tvar folder={\n\t\t\ttype:type, key:key,\n\t\t\tstart:start,datastart:cur,\n\t\t\titemslength:[] };\n\t\tif (type===DT.object) folder.keys=[];\n\t\tfolders.push(folder);\n\t}\n\tvar openObject = function(key) {\n\t\topen({type:DT.object,key:key});\n\t}\n\tvar openArray = function(key) {\n\t\topen({type:DT.array,key:key});\n\t}\n\tvar saveInts=function(arr,key,func) {\n\t\tfunc.apply(handle,[arr,key]);\n\t}\n\tvar close = function(opt) {\n\t\tif (!folders.length) throw 'empty stack';\n\t\tvar folder=folders.pop();\n\t\t//jump to lengths and keys\n\t\tkfs.writeOffset( cur-folder.datastart, folder.datastart-5);\n\t\tvar itemcount=folder.itemslength.length;\n\t\t//save lengths\n\t\twriteVInt1(itemcount);\n\t\twriteVInt(folder.itemslength);\n\t\t\n\t\tif (folder.type===DT.object) {\n\t\t\t//use utf8 for keys\n\t\t\tcur+=kfs.writeStringArray(folder.keys,cur,'utf8');\n\t\t}\n\t\twritten=cur-folder.start;\n\t\tpushitem(folder.key,written);\n\t\treturn written;\n\t}\n\t\n\t\n\tvar stringencoding='ucs2';\n\tvar stringEncoding=function(newencoding) {\n\t\tif (newencoding) stringencoding=newencoding;\n\t\telse return stringencoding;\n\t}\n\t\n\tvar allnumber_fast=function(arr) {\n\t\tif (arr.length<5) return allnumber(arr);\n\t\tif (typeof arr[0]=='number'\n\t\t    && Math.round(arr[0])==arr[0] && arr[0]>=0)\n\t\t\treturn true;\n\t\treturn false;\n\t}\n\tvar allstring_fast=function(arr) {\n\t\tif (arr.length<5) return allstring(arr);\n\t\tif (typeof arr[0]=='string') return true;\n\t\treturn false;\n\t}\t\n\tvar allnumber=function(arr) {\n\t\tfor (var i=0;i<arr.length;i++) {\n\t\t\tif (typeof arr[i]!=='number') return false;\n\t\t}\n\t\treturn true;\n\t}\n\tvar allstring=function(arr) {\n\t\tfor (var i=0;i<arr.length;i++) {\n\t\t\tif (typeof arr[i]!=='string') return false;\n\t\t}\n\t\treturn true;\n\t}\n\tvar getEncoding=function(key,encs) {\n\t\tvar enc=encs[key];\n\t\tif (!enc) return null;\n\t\tif (enc=='delta' || enc=='posting') {\n\t\t\treturn savePInt;\n\t\t} else if (enc==\"variable\") {\n\t\t\treturn saveVInt;\n\t\t}\n\t\treturn null;\n\t}\n\tvar save=function(J,key,opts) {\n\t\topts=opts||{};\n\t\t\n\t\tif (typeof J==\"null\" || typeof J==\"undefined\") {\n\t\t\tthrow 'cannot save null value of ['+key+'] folders'+JSON.stringify(folders);\n\t\t\treturn;\n\t\t}\n\t\tvar type=J.constructor.name;\n\t\tif (type==='Object') {\n\t\t\topenObject(key);\n\t\t\tfor (var i in J) {\n\t\t\t\tsave(J[i],i,opts);\n\t\t\t\tif (opts.autodelete) delete J[i];\n\t\t\t}\n\t\t\tclose();\n\t\t} else if (type==='Array') {\n\t\t\tif (allnumber_fast(J)) {\n\t\t\t\tif (J.sorted) { //number array is sorted\n\t\t\t\t\tsaveInts(J,key,savePInt);\t//posting delta format\n\t\t\t\t} else {\n\t\t\t\t\tsaveInts(J,key,saveVInt);\t\n\t\t\t\t}\n\t\t\t} else if (allstring_fast(J)) {\n\t\t\t\tsaveStringArray(J,key);\n\t\t\t} else {\n\t\t\t\topenArray(key);\n\t\t\t\tfor (var i=0;i<J.length;i++) {\n\t\t\t\t\tsave(J[i],null,opts);\n\t\t\t\t\tif (opts.autodelete) delete J[i];\n\t\t\t\t}\n\t\t\t\tclose();\n\t\t\t}\n\t\t} else if (type==='String') {\n\t\t\tsaveString(J,key);\n\t\t} else if (type==='Number') {\n\t\t\tif (J>=0&&J<256) saveUI8(J,key);\n\t\t\telse saveI32(J,key);\n\t\t} else if (type==='Boolean') {\n\t\t\tsaveBool(J,key);\n\t\t} else if (type==='Buffer') {\n\t\t\tsaveBlob(J,key);\n\t\t} else {\n\t\t\tthrow 'unsupported type '+type;\n\t\t}\n\t}\n\t\n\tvar free=function() {\n\t\twhile (folders.length) close();\n\t\tkfs.free();\n\t}\n\tvar currentsize=function() {\n\t\treturn cur;\n\t}\n\n\tObject.defineProperty(handle, \"size\", {get : function(){ return cur; }});\n\n\tvar writeFile=function(fn,opts,cb) {\n\t\tif (typeof fs==\"undefined\") {\n\t\t\tvar fs=opts.fs||require('fs');\t\n\t\t}\n\t\tvar totalbyte=handle.currentsize();\n\t\tvar written=0,batch=0;\n\t\t\n\t\tif (typeof cb==\"undefined\" || typeof opts==\"function\") {\n\t\t\tcb=opts;\n\t\t}\n\t\topts=opts||{};\n\t\tbatchsize=opts.batchsize||1024*1024*16; //16 MB\n\n\t\tif (fs.existsSync(fn)) fs.unlinkSync(fn);\n\n\t\tvar writeCb=function(total,written,cb,next) {\n\t\t\treturn function(err) {\n\t\t\t\tif (err) throw \"write error\"+err;\n\t\t\t\tcb(total,written);\n\t\t\t\tbatch++;\n\t\t\t\tnext();\n\t\t\t}\n\t\t}\n\n\t\tvar next=function() {\n\t\t\tif (batch<batches) {\n\t\t\t\tvar bufstart=batchsize*batch;\n\t\t\t\tvar bufend=bufstart+batchsize;\n\t\t\t\tif (bufend>totalbyte) bufend=totalbyte;\n\t\t\t\tvar sliced=kfs.buf.slice(bufstart,bufend);\n\t\t\t\twritten+=sliced.length;\n\t\t\t\tfs.appendFile(fn,sliced,writeCb(totalbyte,written, cb,next));\n\t\t\t}\n\t\t}\n\t\tvar batches=1+Math.floor(handle.size/batchsize);\n\t\tnext();\n\t}\n\thandle.free=free;\n\thandle.saveI32=saveI32;\n\thandle.saveUI8=saveUI8;\n\thandle.saveBool=saveBool;\n\thandle.saveString=saveString;\n\thandle.saveVInt=saveVInt;\n\thandle.savePInt=savePInt;\n\thandle.saveInts=saveInts;\n\thandle.saveBlob=saveBlob;\n\thandle.save=save;\n\thandle.openArray=openArray;\n\thandle.openObject=openObject;\n\thandle.stringEncoding=stringEncoding;\n\t//this.integerEncoding=integerEncoding;\n\thandle.close=close;\n\thandle.writeFile=writeFile;\n\thandle.currentsize=currentsize;\n\treturn handle;\n}\n\nmodule.exports=Create;",
    "/*\n  TODO\n  and not\n\n*/\n\n// http://jsfiddle.net/neoswf/aXzWw/\nvar plist=require('./plist');\nfunction intersect(I, J) {\n  var i = j = 0;\n  var result = [];\n\n  while( i < I.length && j < J.length ){\n     if      (I[i] < J[j]) i++; \n     else if (I[i] > J[j]) j++; \n     else {\n       result[result.length]=l[i];\n       i++;j++;\n     }\n  }\n  return result;\n}\n\n/* return all items in I but not in J */\nfunction subtract(I, J) {\n  var i = j = 0;\n  var result = [];\n\n  while( i < I.length && j < J.length ){\n    if (I[i]==J[j]) {\n      i++;j++;\n    } else if (I[i]<J[j]) {\n      while (I[i]<J[j]) result[result.length]= I[i++];\n    } else {\n      while(J[j]<I[i]) j++;\n    }\n  }\n\n  if (j==J.length) {\n    while (i<I.length) result[result.length]=I[i++];\n  }\n\n  return result;\n}\n\nvar union=function(a,b) {\n\tif (!a || !a.length) return b;\n\tif (!b || !b.length) return a;\n    var result = [];\n    var ai = 0;\n    var bi = 0;\n    while (true) {\n        if ( ai < a.length && bi < b.length) {\n            if (a[ai] < b[bi]) {\n                result[result.length]=a[ai];\n                ai++;\n            } else if (a[ai] > b[bi]) {\n                result[result.length]=b[bi];\n                bi++;\n            } else {\n                result[result.length]=a[ai];\n                result[result.length]=b[bi];\n                ai++;\n                bi++;\n            }\n        } else if (ai < a.length) {\n            result.push.apply(result, a.slice(ai, a.length));\n            break;\n        } else if (bi < b.length) {\n            result.push.apply(result, b.slice(bi, b.length));\n            break;\n        } else {\n            break;\n        }\n    }\n    return result;\n}\nvar OPERATION={'include':intersect, 'union':union, 'exclude':subtract};\n\nvar boolSearch=function(opts) {\n  opts=opts||{};\n  ops=opts.op||this.opts.op;\n  this.docs=[];\n\tif (!this.phrases.length) return;\n\tvar r=this.phrases[0].docs;\n  /* ignore operator of first phrase */\n\tfor (var i=1;i<this.phrases.length;i++) {\n\t\tvar op= ops[i] || 'union';\n\t\tr=OPERATION[op](r,this.phrases[i].docs);\n\t}\n\tthis.docs=plist.unique(r);\n\treturn this;\n}\nmodule.exports={search:boolSearch}",
    "var indexOfSorted = function (array, obj, near) { \n  var low = 0,\n  high = array.length;\n  while (low < high) {\n    var mid = (low + high) >> 1;\n    if (array[mid]==obj) return mid;\n    array[mid] < obj ? low = mid + 1 : high = mid;\n  }\n  if (near) return low;\n  else if (array[low]==obj) return low;else return -1;\n};\nvar indexOfSorted_str = function (array, obj, near) { \n  var low = 0,\n  high = array.length;\n  while (low < high) {\n    var mid = (low + high) >> 1;\n    if (array[mid]==obj) return mid;\n    (array[mid].localeCompare(obj)<0) ? low = mid + 1 : high = mid;\n  }\n  if (near) return low;\n  else if (array[low]==obj) return low;else return -1;\n};\n\n\nvar bsearch=function(array,value,near) {\n\tvar func=indexOfSorted;\n\tif (typeof array[0]==\"string\") func=indexOfSorted_str;\n\treturn func(array,value,near);\n}\nvar bsearchNear=function(array,value) {\n\treturn bsearch(array,value,true);\n}\n\nmodule.exports=bsearch;//{bsearchNear:bsearchNear,bsearch:bsearch};",
    "var plist=require(\"./plist\");\n\nvar getPhraseWidths=function (Q,phraseid,vposs) {\n\tvar res=[];\n\tfor (var i in vposs) {\n\t\tres.push(getPhraseWidth(Q,phraseid,vposs[i]));\n\t}\n\treturn res;\n}\nvar getPhraseWidth=function (Q,phraseid,vpos) {\n\tvar P=Q.phrases[phraseid];\n\tvar width=0,varwidth=false;\n\tif (P.width) return P.width; // no wildcard\n\tif (P.termid.length<2) return P.termlength[0];\n\tvar lasttermposting=Q.terms[P.termid[P.termid.length-1]].posting;\n\n\tfor (var i in P.termid) {\n\t\tvar T=Q.terms[P.termid[i]];\n\t\tif (T.op=='wildcard') {\n\t\t\twidth+=T.width;\n\t\t\tif (T.wildcard=='*') varwidth=true;\n\t\t} else {\n\t\t\twidth+=P.termlength[i];\n\t\t}\n\t}\n\tif (varwidth) { //width might be smaller due to * wildcard\n\t\tvar at=plist.indexOfSorted(lasttermposting,vpos);\n\t\tvar endpos=lasttermposting[at];\n\t\tif (endpos-vpos<width) width=endpos-vpos+1;\n\t}\n\n\treturn width;\n}\n/* return [vpos, phraseid, phrasewidth, optional_tagname] by slot range*/\nvar hitInRange=function(Q,startvpos,endvpos) {\n\tvar res=[];\n\tif (!Q || !Q.rawresult || !Q.rawresult.length) return res;\n\tfor (var i=0;i<Q.phrases.length;i++) {\n\t\tvar P=Q.phrases[i];\n\t\tif (!P.posting) continue;\n\t\tvar s=plist.indexOfSorted(P.posting,startvpos);\n\t\tvar e=plist.indexOfSorted(P.posting,endvpos);\n\t\tvar r=P.posting.slice(s,e+1);\n\t\tvar width=getPhraseWidths(Q,i,r);\n\n\t\tres=res.concat(r.map(function(vpos,idx){ return [vpos,width[idx],i] }));\n\t}\n\t// order by vpos, if vpos is the same, larger width come first.\n\t// so the output will be\n\t// <tag1><tag2>one</tag2>two</tag1>\n\t//TODO, might cause overlap if same vpos and same width\n\t//need to check tag name\n\tres.sort(function(a,b){return a[0]==b[0]? b[1]-a[1] :a[0]-b[0]});\n\n\treturn res;\n}\n\nvar tagsInRange=function(Q,renderTags,startvpos,endvpos) {\n\tvar res=[];\n\tif (typeof renderTags==\"string\") renderTags=[renderTags];\n\n\trenderTags.map(function(tag){\n\t\tvar starts=Q.engine.get([\"fields\",tag+\"_start\"]);\n\t\tvar ends=Q.engine.get([\"fields\",tag+\"_end\"]);\n\t\tif (!starts) return;\n\n\t\tvar s=plist.indexOfSorted(starts,startvpos);\n\t\tvar e=s;\n\t\twhile (e<starts.length && starts[e]<endvpos) e++;\n\t\tvar opentags=starts.slice(s,e);\n\n\t\ts=plist.indexOfSorted(ends,startvpos);\n\t\te=s;\n\t\twhile (e<ends.length && ends[e]<endvpos) e++;\n\t\tvar closetags=ends.slice(s,e);\n\n\t\topentags.map(function(start,idx) {\n\t\t\tres.push([start,closetags[idx]-start,tag]);\n\t\t})\n\t});\n\t// order by vpos, if vpos is the same, larger width come first.\n\tres.sort(function(a,b){return a[0]==b[0]? b[1]-a[1] :a[0]-b[0]});\n\n\treturn res;\n}\n\n/*\ngiven a vpos range start, file, convert to filestart, fileend\n   filestart : starting file\n   start   : vpos start\n   showfile: how many files to display\n   showpage: how many pages to display\n\noutput:\n   array of fileid with hits\n*/\nvar getFileWithHits=function(engine,Q,range) {\n\tvar fileOffsets=engine.get(\"fileoffsets\");\n\tvar out=[],filecount=100;\n\tvar start=0 , end=Q.byFile.length;\n\tQ.excerptOverflow=false;\n\tif (range.start) {\n\t\tvar first=range.start ;\n\t\tvar last=range.end;\n\t\tif (!last) last=Number.MAX_SAFE_INTEGER;\n\t\tfor (var i=0;i<fileOffsets.length;i++) {\n\t\t\t//if (fileOffsets[i]>first) break;\n\t\t\tif (fileOffsets[i]>last) {\n\t\t\t\tend=i;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (fileOffsets[i]<first) start=i;\n\t\t}\t\t\n\t} else {\n\t\tstart=range.filestart || 0;\n\t\tif (range.maxfile) {\n\t\t\tfilecount=range.maxfile;\n\t\t} else if (range.showseg) {\n\t\t\tthrow \"not implement yet\"\n\t\t}\n\t}\n\n\tvar fileWithHits=[],totalhit=0;\n\trange.maxhit=range.maxhit||1000;\n\n\tfor (var i=start;i<end;i++) {\n\t\tif(Q.byFile[i].length>0) {\n\t\t\ttotalhit+=Q.byFile[i].length;\n\t\t\tfileWithHits.push(i);\n\t\t\trange.nextFileStart=i;\n\t\t\tif (fileWithHits.length>=filecount) {\n\t\t\t\tQ.excerptOverflow=true;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (totalhit>range.maxhit) {\n\t\t\t\tQ.excerptOverflow=true;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\tif (i>=end) { //no more file\n\t\tQ.excerptStop=true;\n\t}\n\treturn fileWithHits;\n}\nvar resultlist=function(engine,Q,opts,cb) {\n\tvar output=[];\n\tif (!Q.rawresult || !Q.rawresult.length) {\n\t\tcb(output);\n\t\treturn;\n\t}\n\n\tif (opts.range) {\n\t\tif (opts.range.maxhit && !opts.range.maxfile) {\n\t\t\topts.range.maxfile=opts.range.maxhit;\n\t\t\topts.range.maxseg=opts.range.maxhit;\n\t\t}\n\t\tif (!opts.range.maxseg) opts.range.maxseg=100;\n\t\tif (!opts.range.end) {\n\t\t\topts.range.end=Number.MAX_SAFE_INTEGER;\n\t\t}\n\t}\n\tvar fileWithHits=getFileWithHits(engine,Q,opts.range);\n\tif (!fileWithHits.length) {\n\t\tcb(output);\n\t\treturn;\n\t}\n\n\tvar output=[],files=[];//temporary holder for segnames\n\tfor (var i=0;i<fileWithHits.length;i++) {\n\t\tvar nfile=fileWithHits[i];\n\t\tvar segoffsets=engine.getFileSegOffsets(nfile);\n\t\tvar segnames=engine.getFileSegNames(nfile);\n\t\tfiles[nfile]={segoffsets:segoffsets};\n\t\tvar segwithhit=plist.groupbyposting2(Q.byFile[ nfile ],  segoffsets);\n\t\t//if (segoffsets[0]==1)\n\t\t//segwithhit.shift(); //the first item is not used (0~Q.byFile[0] )\n\n\t\tfor (var j=0; j<segwithhit.length;j++) {\n\t\t\tif (!segwithhit[j].length) continue;\n\t\t\t//var offsets=segwithhit[j].map(function(p){return p- fileOffsets[i]});\n\t\t\tif (segoffsets[j]>opts.range.end) break;\n\t\t\toutput.push(  {file: nfile, seg:j,  segname:segnames[j]});\n\t\t\tif (output.length>opts.range.maxseg) break;\n\t\t}\n\t}\n\n\tvar segpaths=output.map(function(p){\n\t\treturn [\"filecontents\",p.file,p.seg];\n\t});\n\t//prepare the text\n\tengine.get(segpaths,function(segs){\n\t\tvar seq=0;\n\t\tif (segs) for (var i=0;i<segs.length;i++) {\n\t\t\tvar startvpos=files[output[i].file].segoffsets[output[i].seg-1] ||0;\n\t\t\tvar endvpos=files[output[i].file].segoffsets[output[i].seg];\n\t\t\tvar hl={};\n\n\t\t\tif (opts.range && opts.range.start  ) {\n\t\t\t\tif ( startvpos<opts.range.start) startvpos=opts.range.start;\n\t\t\t//\tif (endvpos>opts.range.end) endvpos=opts.range.end;\n\t\t\t}\n\t\t\t\n\t\t\tif (opts.nohighlight) {\n\t\t\t\thl.text=segs[i];\n\t\t\t\thl.hits=hitInRange(Q,startvpos,endvpos);\n\t\t\t} else {\n\t\t\t\tvar o={nocrlf:true,nospan:true,\n\t\t\t\t\ttext:segs[i],startvpos:startvpos, endvpos: endvpos, \n\t\t\t\t\tQ:Q,fulltext:opts.fulltext};\n\t\t\t\thl=highlight(Q,o);\n\t\t\t}\n\t\t\tif (hl.text) {\n\t\t\t\toutput[i].text=hl.text;\n\t\t\t\toutput[i].hits=hl.hits;\n\t\t\t\toutput[i].seq=seq;\n\t\t\t\tseq+=hl.hits.length;\n\n\t\t\t\toutput[i].start=startvpos;\t\t\t\t\n\t\t\t} else {\n\t\t\t\toutput[i]=null; //remove item vpos less than opts.range.start\n\t\t\t}\n\t\t} \n\t\toutput=output.filter(function(o){return o!=null});\n\t\tcb(output);\n\t});\n}\nvar injectTag=function(Q,opts){\n\tvar hits=opts.hits;\n\tvar tags=opts.tags;\n\tif (!tags) tags=[];\n\tvar hitclass=opts.hitclass||'hl';\n\tvar output='',O=[],j=0,k=0;\n\tvar surround=opts.surround||5;\n\n\tvar tokens=Q.tokenize(opts.text).tokens;\n\tvar vpos=opts.vpos;\n\tvar i=0,previnrange=!!opts.fulltext ,inrange=!!opts.fulltext;\n\tvar hitstart=0,hitend=0,tagstart=0,tagend=0,tagclass=\"\";\n\twhile (i<tokens.length) {\n\t\tvar skip=Q.isSkip(tokens[i]);\n\t\tvar hashit=false;\n\t\tinrange=opts.fulltext || (j<hits.length && vpos+surround>=hits[j][0] ||\n\t\t\t\t(j>0 && j<=hits.length &&  hits[j-1][0]+surround*2>=vpos));\t\n\n\t\tif (previnrange!=inrange) {\n\t\t\toutput+=opts.abridge||\"...\";\n\t\t}\n\t\tprevinrange=inrange;\n\t\tvar token=tokens[i];\n\t\tif (opts.nocrlf && token==\"\\n\") token=\"\";\n\n\t\tif (inrange && i<tokens.length) {\n\t\t\tif (skip) {\n\t\t\t\toutput+=token;\n\t\t\t} else {\n\t\t\t\tvar classes=\"\";\t\n\n\t\t\t\t//check hit\n\t\t\t\tif (j<hits.length && vpos==hits[j][0]) {\n\t\t\t\t\tvar nphrase=hits[j][2] % 10, width=hits[j][1];\n\t\t\t\t\thitstart=hits[j][0];\n\t\t\t\t\thitend=hitstart+width;\n\t\t\t\t\tj++;\n\t\t\t\t}\n\n\t\t\t\t//check tag\n\t\t\t\tif (k<tags.length && vpos==tags[k][0]) {\n\t\t\t\t\tvar width=tags[k][1];\n\t\t\t\t\ttagstart=tags[k][0];\n\t\t\t\t\ttagend=tagstart+width;\n\t\t\t\t\ttagclass=tags[k][2];\n\t\t\t\t\tk++;\n\t\t\t\t}\n\n\t\t\t\tif (vpos>=hitstart && vpos<hitend) classes=hitclass+\" \"+hitclass+nphrase;\n\t\t\t\tif (vpos>=tagstart && vpos<tagend) classes+=\" \"+tagclass;\n\n\t\t\t\tif (classes || !opts.nospan) {\n\t\t\t\t\toutput+='<span vpos=\"'+vpos+'\"';\n\t\t\t\t\tif (classes) classes=' class=\"'+classes+'\"';\n\t\t\t\t\toutput+=classes+'>';\n\t\t\t\t\toutput+=token+'</span>';\n\t\t\t\t} else {\n\t\t\t\t\toutput+=token;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (!skip) vpos++;\n\t\ti++; \n\t}\n\n\tO.push(output);\n\toutput=\"\";\n\n\treturn O.join(\"\");\n}\nvar highlight=function(Q,opts) {\n\tif (!opts.text) return {text:\"\",hits:[]};\n\tvar opt={text:opts.text,\n\t\thits:null,abridge:opts.abridge,vpos:opts.startvpos,\n\t\tfulltext:opts.fulltext,renderTags:opts.renderTags,nospan:opts.nospan,nocrlf:opts.nocrlf,\n\t};\n\n\topt.hits=hitInRange(opts.Q,opts.startvpos,opts.endvpos);\n\treturn {text:injectTag(Q,opt),hits:opt.hits};\n}\n\nvar addspan=function(text,startvpos){\n\tengine=this;\n\tvar output=\"\";\n\tvar tokens=engine.analyzer.tokenize(text).tokens;\n\tfor (var i=0;i<tokens.length;i++) {\n\t\toutput+='<span vpos=\"'+(i+startvpos)+'\">'+tokens[i]+\"</span>\";\n\t}\n\treturn output;\n}\nvar getSeg=function(engine,fileid,segid,opts,cb,context) {\n\tif (typeof opts==\"function\") {\n\t\tcontext=cb;\n\t\tcb=opts;\n\t\topts={};\n\t}\n\n\tvar fileOffsets=engine.get(\"fileoffsets\");\n\tvar segpaths=[\"filecontents\",fileid,segid];\n\tvar segnames=engine.getFileSegNames(fileid);\n\tvar vpos=engine.fileSegToVpos(fileid,segid);\n\n\tengine.get(segpaths,function(text){\n\t\tif (opts.span) text=addspan.apply(engine,[text,vpos]);\n\t\tcb.apply(context||engine.context,[{text:text,file:fileid,seg:segid,segname:segnames[segid]}]);\n\t});\n}\n\nvar getSegSync=function(engine,fileid,segid) {\n\tvar fileOffsets=engine.get(\"fileoffsets\");\n\tvar segpaths=[\"filecontents\",fileid,segid];\n\tvar segnames=engine.getFileSegNames(fileid);\n\n\tvar text=engine.get(segpaths);\n\treturn {text:text,file:fileid,seg:segid,segname:segnames[segid]};\n}\n\nvar getRange=function(engine,start,end,cb) {\n\tvar fileoffsets=engine.get(\"fileoffsets\");\n\t//var pagepaths=[\"fileContents\",];\n\t//find first page and last page\n\t//create get paths\n\n}\n\nvar getFile=function(engine,fileid,cb) {\n\tvar filename=engine.get(\"filenames\")[fileid];\n\tvar segnames=engine.getFileSegNames(fileid);\n\tvar filestart=engine.get(\"fileoffsets\")[fileid];\n\tvar offsets=engine.getFileSegOffsets(fileid);\n\tvar pc=0;\n\tengine.get([\"fileContents\",fileid],true,function(data){\n\t\tvar text=data.map(function(t,idx) {\n\t\t\tif (idx==0) return \"\"; \n\t\t\tvar pb='<pb n=\"'+segnames[idx]+'\"></pb>';\n\t\t\treturn pb+t;\n\t\t});\n\t\tcb({texts:data,text:text.join(\"\"),segnames:segnames,filestart:filestart,offsets:offsets,file:fileid,filename:filename}); //force different token\n\t});\n}\n\nvar highlightRange=function(Q,startvpos,endvpos,opts,cb){\n\t//not implement yet\n}\n\nvar highlightFile=function(Q,fileid,opts,cb) {\n\tif (typeof opts==\"function\") {\n\t\tcb=opts;\n\t}\n\n\tif (!Q || !Q.engine) return cb(null);\n\n\tvar segoffsets=Q.engine.getFileSegOffsets(fileid);\n\tvar output=[];\t\n\t//console.log(startvpos,endvpos)\n\tQ.engine.get([\"fileContents\",fileid],true,function(data){\n\t\tif (!data) {\n\t\t\tconsole.error(\"wrong file id\",fileid);\n\t\t} else {\n\t\t\tfor (var i=0;i<data.length-1;i++ ){\n\t\t\t\tvar startvpos=segoffsets[i];\n\t\t\t\tvar endvpos=segoffsets[i+1];\n\t\t\t\tvar segnames=Q.engine.getFileSegNames(fileid);\n\t\t\t\tvar seg=getSegSync(Q.engine, fileid,i+1);\n\t\t\t\t\tvar opt={text:seg.text,hits:null,tag:'hl',vpos:startvpos,\n\t\t\t\t\tfulltext:true,nospan:opts.nospan,nocrlf:opts.nocrlf};\n\t\t\t\tvar segname=segnames[i+1];\n\t\t\t\topt.hits=hitInRange(Q,startvpos,endvpos);\n\t\t\t\tvar pb='<pb n=\"'+segname+'\"></pb>';\n\t\t\t\tvar withtag=injectTag(Q,opt);\n\t\t\t\toutput.push(pb+withtag);\n\t\t\t}\t\t\t\n\t\t}\n\n\t\tcb.apply(Q.engine.context,[{text:output.join(\"\"),file:fileid}]);\n\t})\n}\nvar highlightSeg=function(Q,fileid,segid,opts,cb,context) {\n\tif (typeof opts==\"function\") {\n\t\tcb=opts;\n\t}\n\n\tif (!Q || !Q.engine) return cb.apply(context,[null]);\n\tvar segoffsets=Q.engine.getFileSegOffsets(fileid);\n\tvar startvpos=segoffsets[segid-1];\n\tvar endvpos=segoffsets[segid];\n\tvar segnames=Q.engine.getFileSegNames(fileid);\n\n\tthis.getSeg(Q.engine,fileid,segid,function(res){\n\t\tvar opt={text:res.text,hits:null,vpos:startvpos,fulltext:true,\n\t\t\tnospan:opts.nospan,nocrlf:opts.nocrlf};\n\t\t\topt.hits=hitInRange(Q,startvpos,endvpos);\n\t\t\tif (opts.renderTags) {\n\t\t\t\topt.tags=tagsInRange(Q,opts.renderTags,startvpos,endvpos);\n\t\t\t}\n\n\t\tvar segname=segnames[segid];\n\t\tcb.apply(context||Q.engine.context,[{text:injectTag(Q,opt),seg:segid,file:fileid,hits:opt.hits,segname:segname}]);\n\t});\n}\nmodule.exports={resultlist:resultlist, \n\thitInRange:hitInRange, \n\thighlightSeg:highlightSeg,\n\tgetSeg:getSeg,\n\thighlightFile:highlightFile,\n\tgetFile:getFile\n\t//highlightRange:highlightRange,\n  //getRange:getRange,\n};",
    "/*\n  Ksana Search Engine.\n\n  need a KDE instance to be functional\n  \n*/\nvar bsearch=require(\"./bsearch\");\nvar dosearch=require(\"./search\");\n\nvar prepareEngineForSearch=function(engine,cb){\n\tif (engine.get(\"tokens\") && engine.tokenizer) {\n\t\tcb();\n\t\treturn;\n\t}\n\n\tengine.get([[\"tokens\"],[\"postingslength\"]],function(){\n\t\tif (!engine.analyzer) {\n\t\t\tvar analyzer=require(\"ksana-analyzer\");\n\t\t\tvar config=engine.get(\"meta\").config;\n\t\t\tengine.analyzer=analyzer.getAPI(config);\t\t\t\n\t\t}\n\t\tcb();\n\t});\n}\n\nvar _search=function(engine,q,opts,cb,context) {\n\tif (typeof engine==\"string\") {//browser only\n\t\tvar kde=require(\"ksana-database\");\n\t\tif (typeof opts==\"function\") { //user didn't supply options\n\t\t\tif (typeof cb==\"object\")context=cb;\n\t\t\tcb=opts;\n\t\t\topts={};\n\t\t}\n\t\topts.q=q;\n\t\topts.dbid=engine;\n\t\tkde.open(opts.dbid,function(err,db){\n\t\t\tif (err) {\n\t\t\t\tcb(err);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconsole.log(\"opened\",opts.dbid)\n\t\t\tprepareEngineForSearch(db,function(){\n\t\t\t\treturn dosearch(db,q,opts,cb);\t\n\t\t\t});\n\t\t},context);\n\t} else {\n\t\tprepareEngineForSearch(engine,function(){\n\t\t\treturn dosearch(engine,q,opts,cb);\t\n\t\t});\n\t}\n}\n\nvar _highlightSeg=function(engine,fileid,segid,opts,cb,context){\n\tif (!opts.q) {\n\t\tif (!engine.analyzer) {\n\t\t\tvar analyzer=require(\"ksana-analyzer\");\n\t\t\tvar config=engine.get(\"meta\").config;\n\t\t\tengine.analyzer=analyzer.getAPI(config);\t\t\t\n\t\t}\n\t\tapi.excerpt.getSeg(engine,fileid,segid,opts,cb,context);\n\t} else {\n\t\t_search(engine,opts.q,opts,function(err,Q){\n\t\t\tapi.excerpt.highlightSeg(Q,fileid,segid,opts,cb,context);\n\t\t});\t\t\t\n\t}\n}\nvar _highlightRange=function(engine,start,end,opts,cb,context){\n\n\tif (opts.q) {\n\t\t_search(engine,opts.q,opts,function(Q){\n\t\t\tapi.excerpt.highlightRange(Q,start,end,opts,cb,context);\n\t\t});\n\t} else {\n\t\tprepareEngineForSearch(engine,function(){\n\t\t\tapi.excerpt.getRange(engine,start,end,cb,context);\n\t\t});\n\t}\n}\nvar _highlightFile=function(engine,fileid,opts,cb){\n\tif (!opts.q) opts.q=\"\"; \n\t_search(engine,opts.q,opts,function(Q){\n\t\tapi.excerpt.highlightFile(Q,fileid,opts,cb);\n\t});\n\t/*\n\t} else {\n\t\tapi.excerpt.getFile(engine,fileid,function(data) {\n\t\t\tcb.apply(engine.context,[data]);\n\t\t});\n\t}\n\t*/\n}\n\nvar api={\n\tsearch:_search\n//\t,concordance:require(\"./concordance\")\n//\t,regex:require(\"./regex\")\n\t,highlightSeg:_highlightSeg\n\t,highlightFile:_highlightFile\n//\t,highlightRange:_highlightRange\n\t,excerpt:require(\"./excerpt\")\n\t//,vpos2fileseg:vpos2fileseg\n}\nmodule.exports=api;",
    "\nvar unpack = function (ar) { // unpack variable length integer list\n  var r = [],\n  i = 0,\n  v = 0;\n  do {\n\tvar shift = 0;\n\tdo {\n\t  v += ((ar[i] & 0x7F) << shift);\n\t  shift += 7;\n\t} while (ar[++i] & 0x80);\n\tr[r.length]=v;\n  } while (i < ar.length);\n  return r;\n}\n\n/*\n   arr:  [1,1,1,1,1,1,1,1,1]\n   levels: [0,1,1,2,2,0,1,2]\n   output: [5,1,3,1,1,3,1,1]\n*/\n\nvar groupsum=function(arr,levels) {\n  if (arr.length!=levels.length+1) return null;\n  var stack=[];\n  var output=new Array(levels.length);\n  for (var i=0;i<levels.length;i++) output[i]=0;\n  for (var i=1;i<arr.length;i++) { //first one out of toc scope, ignored\n    if (stack.length>levels[i-1]) {\n      while (stack.length>levels[i-1]) stack.pop();\n    }\n    stack.push(i-1);\n    for (var j=0;j<stack.length;j++) {\n      output[stack[j]]+=arr[i];\n    }\n  }\n  return output;\n}\n/* arr= 1 , 2 , 3 ,4 ,5,6,7 //token posting\n  posting= 3 , 5  //tag posting\n  out = 3 , 2, 2\n*/\nvar countbyposting = function (arr, posting) {\n  if (!posting.length) return [arr.length];\n  var out=[];\n  for (var i=0;i<posting.length;i++) out[i]=0;\n  out[posting.length]=0;\n  var p=0,i=0,lasti=0;\n  while (i<arr.length && p<posting.length) {\n    if (arr[i]<=posting[p]) {\n      while (p<posting.length && i<arr.length && arr[i]<=posting[p]) {\n        out[p]++;\n        i++;\n      }      \n    } \n    p++;\n  }\n  out[posting.length] = arr.length-i; //remaining\n  return out;\n}\n\nvar groupbyposting=function(arr,gposting) { //relative vpos\n  if (!gposting.length) return [arr.length];\n  var out=[];\n  for (var i=0;i<=gposting.length;i++) out[i]=[];\n  \n  var p=0,i=0,lasti=0;\n  while (i<arr.length && p<gposting.length) {\n    if (arr[i]<gposting[p]) {\n      while (p<gposting.length && i<arr.length && arr[i]<gposting[p]) {\n        var start=0;\n        if (p>0) start=gposting[p-1];\n        out[p].push(arr[i++]-start);  // relative\n      }      \n    } \n    p++;\n  }\n  //remaining\n  while(i<arr.length) out[out.length-1].push(arr[i++]-gposting[gposting.length-1]);\n  return out;\n}\nvar groupbyposting2=function(arr,gposting) { //absolute vpos\n  if (!arr || !arr.length) return [];\n  if (!gposting.length) return [arr.length];\n  var out=[];\n  for (var i=0;i<=gposting.length;i++) out[i]=[];\n  \n  var p=0,i=0,lasti=0;\n  while (i<arr.length && p<gposting.length) {\n    if (arr[i]<gposting[p]) {\n      while (p<gposting.length && i<arr.length && arr[i]<gposting[p]) {\n        var start=0;\n        if (p>0) start=gposting[p-1]; //absolute\n        out[p].push(arr[i++]);\n      }      \n    } \n    p++;\n  }\n  //remaining\n  while(i<arr.length) out[out.length-1].push(arr[i++]-gposting[gposting.length-1]);\n  return out;\n}\nvar groupbyblock2 = function(ar, ntoken,slotshift,opts) {\n  if (!ar.length) return [{},{}];\n  \n  slotshift = slotshift || 16;\n  var g = Math.pow(2,slotshift);\n  var i = 0;\n  var r = {}, ntokens={};\n  var groupcount=0;\n  do {\n    var group = Math.floor(ar[i] / g) ;\n    if (!r[group]) {\n      r[group] = [];\n      ntokens[group]=[];\n      groupcount++;\n    }\n    r[group].push(ar[i] % g);\n    ntokens[group].push(ntoken[i]);\n    i++;\n  } while (i < ar.length);\n  if (opts) opts.groupcount=groupcount;\n  return [r,ntokens];\n}\nvar groupbyslot = function (ar, slotshift, opts) {\n  if (!ar.length)\n\treturn {};\n  \n  slotshift = slotshift || 16;\n  var g = Math.pow(2,slotshift);\n  var i = 0;\n  var r = {};\n  var groupcount=0;\n  do {\n\tvar group = Math.floor(ar[i] / g) ;\n\tif (!r[group]) {\n\t  r[group] = [];\n\t  groupcount++;\n\t}\n\tr[group].push(ar[i] % g);\n\ti++;\n  } while (i < ar.length);\n  if (opts) opts.groupcount=groupcount;\n  return r;\n}\n/*\nvar identity = function (value) {\n  return value;\n};\nvar sortedIndex = function (array, obj, iterator) { //taken from underscore\n  iterator || (iterator = identity);\n  var low = 0,\n  high = array.length;\n  while (low < high) {\n\tvar mid = (low + high) >> 1;\n\titerator(array[mid]) < iterator(obj) ? low = mid + 1 : high = mid;\n  }\n  return low;\n};*/\n\nvar indexOfSorted = function (array, obj) { \n  var low = 0,\n  high = array.length-1;\n  while (low < high) {\n    var mid = (low + high) >> 1;\n    array[mid] < obj ? low = mid + 1 : high = mid;\n  }\n  return low;\n};\nvar plhead=function(pl, pltag, opts) {\n  opts=opts||{};\n  opts.max=opts.max||1;\n  var out=[];\n  if (pltag.length<pl.length) {\n    for (var i=0;i<pltag.length;i++) {\n       k = indexOfSorted(pl, pltag[i]);\n       if (k>-1 && k<pl.length) {\n        if (pl[k]==pltag[i]) {\n          out[out.length]=pltag[i];\n          if (out.length>=opts.max) break;\n        }\n      }\n    }\n  } else {\n    for (var i=0;i<pl.length;i++) {\n       k = indexOfSorted(pltag, pl[i]);\n       if (k>-1 && k<pltag.length) {\n        if (pltag[k]==pl[i]) {\n          out[out.length]=pltag[k];\n          if (out.length>=opts.max) break;\n        }\n      }\n    }\n  }\n  return out;\n}\n/*\n pl2 occur after pl1, \n pl2>=pl1+mindis\n pl2<=pl1+maxdis\n*/\nvar plfollow2 = function (pl1, pl2, mindis, maxdis) {\n  var r = [],i=0;\n  var swap = 0;\n  \n  while (i<pl1.length){\n    var k = indexOfSorted(pl2, pl1[i] + mindis);\n    var t = (pl2[k] >= (pl1[i] +mindis) && pl2[k]<=(pl1[i]+maxdis)) ? k : -1;\n    if (t > -1) {\n      r[r.length]=pl1[i];\n      i++;\n    } else {\n      if (k>=pl2.length) break;\n      var k2=indexOfSorted (pl1,pl2[k]-maxdis);\n      if (k2>i) {\n        var t = (pl2[k] >= (pl1[i] +mindis) && pl2[k]<=(pl1[i]+maxdis)) ? k : -1;\n        if (t>-1) r[r.length]=pl1[k2];\n        i=k2;\n      } else break;\n    }\n  }\n  return r;\n}\n\nvar plnotfollow2 = function (pl1, pl2, mindis, maxdis) {\n  var r = [],i=0;\n  \n  while (i<pl1.length){\n    var k = indexOfSorted(pl2, pl1[i] + mindis);\n    var t = (pl2[k] >= (pl1[i] +mindis) && pl2[k]<=(pl1[i]+maxdis)) ? k : -1;\n    if (t > -1) {\n      i++;\n    } else {\n      if (k>=pl2.length) {\n        r=r.concat(pl1.slice(i));\n        break;\n      } else {\n        var k2=indexOfSorted (pl1,pl2[k]-maxdis);\n        if (k2>i) {\n          r=r.concat(pl1.slice(i,k2));\n          i=k2;\n        } else break;\n      }\n    }\n  }\n  return r;\n}\n/* this is incorrect */\nvar plfollow = function (pl1, pl2, distance) {\n  var r = [],i=0;\n\n  while (i<pl1.length){\n    var k = indexOfSorted(pl2, pl1[i] + distance);\n    var t = (pl2[k] === (pl1[i] + distance)) ? k : -1;\n    if (t > -1) {\n      r.push(pl1[i]);\n      i++;\n    } else {\n      if (k>=pl2.length) break;\n      var k2=indexOfSorted (pl1,pl2[k]-distance);\n      if (k2>i) {\n        t = (pl2[k] === (pl1[k2] + distance)) ? k : -1;\n        if (t>-1) {\n           r.push(pl1[k2]);\n           k2++;\n        }\n        i=k2;\n      } else break;\n    }\n  }\n  return r;\n}\nvar plnotfollow = function (pl1, pl2, distance) {\n  var r = [];\n  var r = [],i=0;\n  var swap = 0;\n  \n  while (i<pl1.length){\n    var k = indexOfSorted(pl2, pl1[i] + distance);\n    var t = (pl2[k] === (pl1[i] + distance)) ? k : -1;\n    if (t > -1) { \n      i++;\n    } else {\n      if (k>=pl2.length) {\n        r=r.concat(pl1.slice(i));\n        break;\n      } else {\n        var k2=indexOfSorted (pl1,pl2[k]-distance);\n        if (k2>i) {\n          r=r.concat(pl1.slice(i,k2));\n          i=k2;\n        } else break;\n      }\n    }\n  }\n  return r;\n}\nvar pland = function (pl1, pl2, distance) {\n  var r = [];\n  var swap = 0;\n  \n  if (pl1.length > pl2.length) { //swap for faster compare\n    var t = pl2;\n    pl2 = pl1;\n    pl1 = t;\n    swap = distance;\n    distance = -distance;\n  }\n  for (var i = 0; i < pl1.length; i++) {\n    var k = indexOfSorted(pl2, pl1[i] + distance);\n    var t = (pl2[k] === (pl1[i] + distance)) ? k : -1;\n    if (t > -1) {\n      r.push(pl1[i] - swap);\n    }\n  }\n  return r;\n}\nvar combine=function (postings) {\n  var out=[];\n  for (var i in postings) {\n    out=out.concat(postings[i]);\n  }\n  out.sort(function(a,b){return a-b});\n  return out;\n}\n\nvar unique = function(ar){\n   if (!ar || !ar.length) return [];\n   var u = {}, a = [];\n   for(var i = 0, l = ar.length; i < l; ++i){\n    if(u.hasOwnProperty(ar[i])) continue;\n    a.push(ar[i]);\n    u[ar[i]] = 1;\n   }\n   return a;\n}\n\n\n\nvar plphrase = function (postings,ops) {\n  var r = [];\n  for (var i=0;i<postings.length;i++) {\n  \tif (!postings[i])  return [];\n  \tif (0 === i) {\n  \t  r = postings[0];\n  \t} else {\n      if (ops[i]=='andnot') {\n        r = plnotfollow(r, postings[i], i);  \n      }else {\n        r = pland(r, postings[i], i);  \n      }\n  \t}\n  }\n  \n  return r;\n}\n//return an array of group having any of pl item\nvar matchPosting=function(pl,gupl,start,end) {\n  start=start||0;\n  end=end||-1;\n  if (end==-1) end=Math.pow(2, 53); // max integer value\n\n  var count=0, i = j= 0,  result = [] ,v=0;\n  var docs=[], freq=[];\n  if (!pl) return {docs:[],freq:[]};\n  while( i < pl.length && j < gupl.length ){\n     if (pl[i] < gupl[j] ){ \n       count++;\n       v=pl[i];\n       i++; \n     } else {\n       if (count) {\n        if (v>=start && v<end) {\n          docs.push(j);\n          freq.push(count);          \n        }\n       }\n       j++;\n       count=0;\n     }\n  }\n  if (count && j<gupl.length && v>=start && v<end) {\n    docs.push(j);\n    freq.push(count);\n    count=0;\n  }\n  else {\n    while (j==gupl.length && i<pl.length && pl[i] >= gupl[gupl.length-1]) {\n      i++;\n      count++;\n    }\n    if (v>=start && v<end) {\n      docs.push(j);\n      freq.push(count);      \n    }\n  } \n  return {docs:docs,freq:freq};\n}\n\nvar trim=function(arr,start,end) {\n  var s=indexOfSorted(arr,start);\n  var e=indexOfSorted(arr,end);\n  return arr.slice(s,e+1);\n}\nvar plist={};\nplist.unpack=unpack;\nplist.plphrase=plphrase;\nplist.plhead=plhead;\nplist.plfollow2=plfollow2;\nplist.plnotfollow2=plnotfollow2;\nplist.plfollow=plfollow;\nplist.plnotfollow=plnotfollow;\nplist.unique=unique;\nplist.indexOfSorted=indexOfSorted;\nplist.matchPosting=matchPosting;\nplist.trim=trim;\n\nplist.groupbyslot=groupbyslot;\nplist.groupbyblock2=groupbyblock2;\nplist.countbyposting=countbyposting;\nplist.groupbyposting=groupbyposting;\nplist.groupbyposting2=groupbyposting2;\nplist.groupsum=groupsum;\nplist.combine=combine;\nmodule.exports=plist;",
    "/*\nvar dosearch2=function(engine,opts,cb,context) {\n\topts\n\t\tnfile,npage  //return a highlighted page\n\t\tnfile,[pages] //return highlighted pages \n\t\tnfile        //return entire highlighted file\n\t\tabs_npage\n\t\t[abs_pages]  //return set of highlighted pages (may cross file)\n\n\t\tfilename, pagename\n\t\tfilename,[pagenames]\n\n\t\texcerpt      //\n\t    sortBy       //default natural, sortby by vsm ranking\n\n\t//return err,array_of_string ,Q  (Q contains low level search result)\n}\n\n*/\n/* TODO sorted tokens */\nvar plist=require(\"./plist\");\nvar boolsearch=require(\"./boolsearch\");\nvar excerpt=require(\"./excerpt\");\nvar parseTerm = function(engine,raw,opts) {\n\tif (!raw) return;\n\tvar res={raw:raw,variants:[],term:'',op:''};\n\tvar term=raw, op=0;\n\tvar firstchar=term[0];\n\tvar termregex=\"\";\n\tif (firstchar=='-') {\n\t\tterm=term.substring(1);\n\t\tfirstchar=term[0];\n\t\tres.exclude=true; //exclude\n\t}\n\tterm=term.trim();\n\tvar lastchar=term[term.length-1];\n\tterm=engine.analyzer.normalize(term);\n\t\n\tif (term.indexOf(\"%\")>-1) {\n\t\tvar termregex=\"^\"+term.replace(/%+/g,\".+\")+\"$\";\n\t\tif (firstchar==\"%\") \ttermregex=\".+\"+termregex.substr(1);\n\t\tif (lastchar==\"%\") \ttermregex=termregex.substr(0,termregex.length-1)+\".+\";\n\t}\n\n\tif (termregex) {\n\t\tres.variants=expandTerm(engine,termregex);\n\t}\n\n\tres.key=term;\n\treturn res;\n}\nvar expandTerm=function(engine,regex) {\n\tvar r=new RegExp(regex);\n\tvar tokens=engine.get(\"tokens\");\n\tvar postingsLength=engine.get(\"postingslength\");\n\tif (!postingsLength) postingsLength=[];\n\tvar out=[];\n\tfor (var i=0;i<tokens.length;i++) {\n\t\tvar m=tokens[i].match(r);\n\t\tif (m) {\n\t\t\tout.push([m[0],postingsLength[i]||1]);\n\t\t}\n\t}\n\tout.sort(function(a,b){return b[1]-a[1]});\n\treturn out;\n}\nvar isWildcard=function(raw) {\n\treturn !!raw.match(/[\\*\\?]/);\n}\n\nvar isOrTerm=function(term) {\n\tterm=term.trim();\n\treturn (term[term.length-1]===',');\n}\nvar orterm=function(engine,term,key) {\n\t\tvar t={text:key};\n\t\tif (engine.analyzer.simplifiedToken) {\n\t\t\tt.simplified=engine.analyzer.simplifiedToken(key);\n\t\t}\n\t\tterm.variants.push(t);\n}\nvar orTerms=function(engine,tokens,now) {\n\tvar raw=tokens[now];\n\tvar term=parseTerm(engine,raw);\n\tif (!term) return;\n\torterm(engine,term,term.key);\n\twhile (isOrTerm(raw))  {\n\t\traw=tokens[++now];\n\t\tvar term2=parseTerm(engine,raw);\n\t\torterm(engine,term,term2.key);\n\t\tfor (var i in term2.variants){\n\t\t\tterm.variants[i]=term2.variants[i];\n\t\t}\n\t\tterm.key+=','+term2.key;\n\t}\n\treturn term;\n}\n\nvar getOperator=function(raw) {\n\tvar op='';\n\tif (raw[0]=='+') op='include';\n\tif (raw[0]=='-') op='exclude';\n\treturn op;\n}\nvar parsePhrase=function(q) {\n\tvar match=q.match(/(\".+?\"|'.+?'|\\S+)/g)\n\tmatch=match.map(function(str){\n\t\tvar n=str.length, h=str.charAt(0), t=str.charAt(n-1)\n\t\tif (h===t&&(h==='\"'|h===\"'\")) str=str.substr(1,n-2)\n\t\treturn str;\n\t})\n\treturn match;\n}\nvar tibetanNumber={\n\t\"\\u0f20\":\"0\",\"\\u0f21\":\"1\",\"\\u0f22\":\"2\",\t\"\\u0f23\":\"3\",\t\"\\u0f24\":\"4\",\n\t\"\\u0f25\":\"5\",\"\\u0f26\":\"6\",\"\\u0f27\":\"7\",\"\\u0f28\":\"8\",\"\\u0f29\":\"9\"\n}\nvar parseNumber=function(raw) {\n\tvar n=parseInt(raw,10);\n\tif (isNaN(n)){\n\t\tvar converted=[];\n\t\tfor (var i=0;i<raw.length;i++) {\n\t\t\tvar nn=tibetanNumber[raw[i]];\n\t\t\tif (typeof nn !=\"undefined\") converted[i]=nn;\n\t\t\telse break;\n\t\t}\n\t\treturn parseInt(converted,10);\n\t} else {\n\t\treturn n;\n\t}\n}\nvar parseWildcard=function(raw) {\n\tvar n=parseNumber(raw) || 1;\n\tvar qcount=raw.split('?').length-1;\n\tvar scount=raw.split('*').length-1;\n\tvar type='';\n\tif (qcount) type='?';\n\telse if (scount) type='*';\n\treturn {wildcard:type, width: n , op:'wildcard'};\n}\n\nvar newPhrase=function() {\n\treturn {termid:[],posting:[],raw:'',termlength:[]};\n} \nvar parseQuery=function(q,sep) {\n\tif (sep && q.indexOf(sep)>-1) {\n\t\tvar match=q.split(sep);\n\t} else {\n\t\tvar match=q.match(/(\".+?\"|'.+?'|\\S+)/g)\n\t\tmatch=match.map(function(str){\n\t\t\tvar n=str.length, h=str.charAt(0), t=str.charAt(n-1)\n\t\t\tif (h===t&&(h==='\"'|h===\"'\")) str=str.substr(1,n-2)\n\t\t\treturn str\n\t\t})\n\t\t//console.log(input,'==>',match)\t\t\n\t}\n\treturn match;\n}\nvar loadPhrase=function(phrase) {\n\t/* remove leading and ending wildcard */\n\tvar Q=this;\n\tvar cache=Q.engine.postingCache;\n\tif (cache[phrase.key]) {\n\t\tphrase.posting=cache[phrase.key];\n\t\treturn Q;\n\t}\n\tif (phrase.termid.length==1) {\n\t\tif (!Q.terms.length){\n\t\t\tphrase.posting=[];\n\t\t} else {\n\t\t\tcache[phrase.key]=phrase.posting=Q.terms[phrase.termid[0]].posting;\t\n\t\t}\n\t\treturn Q;\n\t}\n\n\tvar i=0, r=[],dis=0;\n\twhile(i<phrase.termid.length) {\n\t  var T=Q.terms[phrase.termid[i]];\n\t\tif (0 === i) {\n\t\t\tr = T.posting;\n\t\t} else {\n\t\t    if (T.op=='wildcard') {\n\t\t    \tT=Q.terms[phrase.termid[i++]];\n\t\t    \tvar width=T.width;\n\t\t    \tvar wildcard=T.wildcard;\n\t\t    \tT=Q.terms[phrase.termid[i]];\n\t\t    \tvar mindis=dis;\n\t\t    \tif (wildcard=='?') mindis=dis+width;\n\t\t    \tif (T.exclude) r = plist.plnotfollow2(r, T.posting, mindis, dis+width);\n\t\t    \telse r = plist.plfollow2(r, T.posting, mindis, dis+width);\t\t    \t\n\t\t    \tdis+=(width-1);\n\t\t    }else {\n\t\t    \tif (T.posting) {\n\t\t    \t\tif (T.exclude) r = plist.plnotfollow(r, T.posting, dis);\n\t\t    \t\telse r = plist.plfollow(r, T.posting, dis);\n\t\t    \t}\n\t\t    }\n\t\t}\n\t\tdis += phrase.termlength[i];\n\t\ti++;\n\t\tif (!r) return Q;\n  }\n  phrase.posting=r;\n  cache[phrase.key]=r;\n  return Q;\n}\nvar trimSpace=function(engine,query) {\n\tif (!query) return \"\";\n\tvar i=0;\n\tvar isSkip=engine.analyzer.isSkip;\n\twhile (i<query.length && isSkip(query[i])) i++;\n\treturn query.substring(i);\n}\nvar getSegWithHit=function(fileid,offsets) {\n\tvar Q=this,engine=Q.engine;\n\tvar segWithHit=plist.groupbyposting2(Q.byFile[fileid ], offsets);\n\tif (segWithHit.length) segWithHit.shift(); //the first item is not used (0~Q.byFile[0] )\n\tvar out=[];\n\tsegWithHit.map(function(p,idx){if (p.length) out.push(idx)});\n\treturn out;\n}\nvar segWithHit=function(fileid) {\n\tvar Q=this,engine=Q.engine;\n\tvar offsets=engine.getFileSegOffsets(fileid);\n\treturn getSegWithHit.apply(this,[fileid,offsets]);\n}\nvar isSimplePhrase=function(phrase) {\n\tvar m=phrase.match(/[\\?%^]/);\n\treturn !m;\n}\n\n// 發菩提心   ==> 發菩  提心       2 2   \n// 菩提心     ==> 菩提  提心       1 2\n// 劫劫       ==> 劫    劫         1 1   // invalid\n// 因緣所生道  ==> 因緣  所生   道   2 2 1\nvar splitPhrase=function(engine,simplephrase,bigram) {\n\tvar bigram=bigram||engine.get(\"meta\").bigram||[];\n\tvar tokens=engine.analyzer.tokenize(simplephrase).tokens;\n\tvar loadtokens=[],lengths=[],j=0,lastbigrampos=-1;\n\twhile (j+1<tokens.length) {\n\t\tvar token=engine.analyzer.normalize(tokens[j]);\n\t\tvar nexttoken=engine.analyzer.normalize(tokens[j+1]);\n\t\tvar bi=token+nexttoken;\n\t\tvar i=plist.indexOfSorted(bigram,bi);\n\t\tif (bigram[i]==bi) {\n\t\t\tloadtokens.push(bi);\n\t\t\tif (j+3<tokens.length) {\n\t\t\t\tlastbigrampos=j;\n\t\t\t\tj++;\n\t\t\t} else {\n\t\t\t\tif (j+2==tokens.length){ \n\t\t\t\t\tif (lastbigrampos+1==j ) {\n\t\t\t\t\t\tlengths[lengths.length-1]--;\n\t\t\t\t\t}\n\t\t\t\t\tlastbigrampos=j;\n\t\t\t\t\tj++;\n\t\t\t\t}else {\n\t\t\t\t\tlastbigrampos=j;\t\n\t\t\t\t}\n\t\t\t}\n\t\t\tlengths.push(2);\n\t\t} else {\n\t\t\tif (!bigram || lastbigrampos==-1 || lastbigrampos+1!=j) {\n\t\t\t\tloadtokens.push(token);\n\t\t\t\tlengths.push(1);\t\t\t\t\n\t\t\t}\n\t\t}\n\t\tj++;\n\t}\n\n\twhile (j<tokens.length) {\n\t\tvar token=engine.analyzer.normalize(tokens[j]);\n\t\tloadtokens.push(token);\n\t\tlengths.push(1);\n\t\tj++;\n\t}\n\n\treturn {tokens:loadtokens, lengths: lengths , tokenlength: tokens.length};\n}\n/* host has fast native function */\nvar fastPhrase=function(engine,phrase) {\n\tvar phrase_term=newPhrase();\n\t//var tokens=engine.analyzer.tokenize(phrase).tokens;\n\tvar splitted=splitPhrase(engine,phrase);\n\n\tvar paths=postingPathFromTokens(engine,splitted.tokens);\n//create wildcard\n\n\tphrase_term.width=splitted.tokenlength; //for excerpt.js to getPhraseWidth\n\n\tengine.get(paths,{address:true},function(postingAddress){ //this is sync\n\t\tphrase_term.key=phrase;\n\t\tvar postingAddressWithWildcard=[];\n\t\tfor (var i=0;i<postingAddress.length;i++) {\n\t\t\tpostingAddressWithWildcard.push(postingAddress[i]);\n\t\t\tif (splitted.lengths[i]>1) {\n\t\t\t\tpostingAddressWithWildcard.push([splitted.lengths[i],0]); //wildcard has blocksize==0 \n\t\t\t}\n\t\t}\n\t\tengine.postingCache[phrase]=engine.mergePostings(postingAddressWithWildcard);\n\t});\n\treturn phrase_term;\n\t// put posting into cache[phrase.key]\n}\nvar slowPhrase=function(engine,terms,phrase) {\n\tvar j=0,tokens=engine.analyzer.tokenize(phrase).tokens;\n\tvar phrase_term=newPhrase();\n\tvar termid=0;\n\twhile (j<tokens.length) {\n\t\tvar raw=tokens[j], termlength=1;\n\t\tif (isWildcard(raw)) {\n\t\t\tif (phrase_term.termid.length==0)  { //skip leading wild card\n\t\t\t\tj++\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tterms.push(parseWildcard(raw));\n\t\t\ttermid=terms.length-1;\n\t\t\tphrase_term.termid.push(termid);\n\t\t\tphrase_term.termlength.push(termlength);\n\t\t} else if (isOrTerm(raw)){\n\t\t\tvar term=orTerms.apply(this,[tokens,j]);\n\t\t\tif (term) {\n\t\t\t\tterms.push(term);\n\t\t\t\ttermid=terms.length-1;\n\t\t\t\tj+=term.key.split(',').length-1;\t\t\t\t\t\n\t\t\t}\n\t\t\tj++;\n\t\t\tphrase_term.termid.push(termid);\n\t\t\tphrase_term.termlength.push(termlength);\n\t\t} else {\n\t\t\tvar phrase=\"\";\n\t\t\twhile (j<tokens.length) {\n\t\t\t\tif (!(isWildcard(tokens[j]) || isOrTerm(tokens[j]))) {\n\t\t\t\t\tphrase+=tokens[j];\n\t\t\t\t\tj++;\n\t\t\t\t} else break;\n\t\t\t}\n\n\t\t\tvar splitted=splitPhrase(engine,phrase);\n\t\t\tfor (var i=0;i<splitted.tokens.length;i++) {\n\n\t\t\t\tvar term=parseTerm(engine,splitted.tokens[i]);\n\t\t\t\tvar termidx=terms.map(function(a){return a.key}).indexOf(term.key);\n\t\t\t\tif (termidx==-1) {\n\t\t\t\t\tterms.push(term);\n\t\t\t\t\ttermid=terms.length-1;\n\t\t\t\t} else {\n\t\t\t\t\ttermid=termidx;\n\t\t\t\t}\t\t\t\t\n\t\t\t\tphrase_term.termid.push(termid);\n\t\t\t\tphrase_term.termlength.push(splitted.lengths[i]);\n\t\t\t}\n\t\t}\n\t\tj++;\n\t}\n\tphrase_term.key=phrase;\n\t//remove ending wildcard\n\tvar P=phrase_term , T=null;\n\tdo {\n\t\tT=terms[P.termid[P.termid.length-1]];\n\t\tif (!T) break;\n\t\tif (T.wildcard) P.termid.pop(); else break;\n\t} while(T);\t\t\n\treturn phrase_term;\n}\nvar newQuery =function(engine,query,opts) {\n\t//if (!query) return;\n\topts=opts||{};\n\tquery=trimSpace(engine,query);\n\n\tvar phrases=query,phrases=[];\n\tif (typeof query=='string' && query) {\n\t\tphrases=parseQuery(query,opts.phrase_sep || \"\");\n\t}\n\t\n\tvar phrase_terms=[], terms=[],variants=[],operators=[];\n\tvar pc=0;//phrase count\n\tfor  (var i=0;i<phrases.length;i++) {\n\t\tvar op=getOperator(phrases[pc]);\n\t\tif (op) phrases[pc]=phrases[pc].substring(1);\n\n\t\t/* auto add + for natural order ?*/\n\t\t//if (!opts.rank && op!='exclude' &&i) op='include';\n\t\toperators.push(op);\n\n\t\tif (isSimplePhrase(phrases[pc]) && engine.mergePostings ) {\n\t\t\tvar phrase_term=fastPhrase(engine,phrases[pc]);\n\t\t} else {\n\t\t\tvar phrase_term=slowPhrase(engine,terms,phrases[pc]);\n\t\t}\n\t\tphrase_terms.push(phrase_term);\n\n\t\tif (!engine.mergePostings && phrase_terms[pc].termid.length==0) {\n\t\t\tphrase_terms.pop();\n\t\t} else pc++;\n\t}\n\topts.op=operators;\n\n\tvar Q={dbname:engine.dbname,engine:engine,opts:opts,query:query,\n\t\tphrases:phrase_terms,terms:terms\n\t};\n\tQ.tokenize=function() {return engine.analyzer.tokenize.apply(engine,arguments);}\n\tQ.isSkip=function() {return engine.analyzer.isSkip.apply(engine,arguments);}\n\tQ.normalize=function() {return engine.analyzer.normalize.apply(engine,arguments);}\n\tQ.segWithHit=segWithHit;\n\n\t//Q.getRange=function() {return that.getRange.apply(that,arguments)};\n\t//API.queryid='Q'+(Math.floor(Math.random()*10000000)).toString(16);\n\treturn Q;\n}\nvar postingPathFromTokens=function(engine,tokens) {\n\tvar alltokens=engine.get(\"tokens\");\n\n\tvar tokenIds=tokens.map(function(t){ return 1+alltokens.indexOf(t)});\n\tvar postingid=[];\n\tfor (var i=0;i<tokenIds.length;i++) {\n\t\tpostingid.push( tokenIds[i]); // tokenId==0 , empty token\n\t}\n\treturn postingid.map(function(t){return [\"postings\",t]});\n}\nvar loadPostings=function(engine,tokens,cb) {\n\tvar toloadtokens=tokens.filter(function(t){\n\t\treturn !engine.postingCache[t.key]; //already in cache\n\t});\n\tif (toloadtokens.length==0) {\n\t\tcb();\n\t\treturn;\n\t}\n\tvar postingPaths=postingPathFromTokens(engine,tokens.map(function(t){return t.key}));\n\tengine.get(postingPaths,function(postings){\n\t\tpostings.map(function(p,i) { tokens[i].posting=p });\n\t\tif (cb) cb();\n\t});\n}\nvar groupBy=function(Q,posting) {\n\tphrases.forEach(function(P){\n\t\tvar key=P.key;\n\t\tvar docfreq=docfreqcache[key];\n\t\tif (!docfreq) docfreq=docfreqcache[key]={};\n\t\tif (!docfreq[that.groupunit]) {\n\t\t\tdocfreq[that.groupunit]={doclist:null,freq:null};\n\t\t}\t\t\n\t\tif (P.posting) {\n\t\t\tvar res=matchPosting(engine,P.posting);\n\t\t\tP.freq=res.freq;\n\t\t\tP.docs=res.docs;\n\t\t} else {\n\t\t\tP.docs=[];\n\t\t\tP.freq=[];\n\t\t}\n\t\tdocfreq[that.groupunit]={doclist:P.docs,freq:P.freq};\n\t});\n\treturn this;\n}\nvar groupByFolder=function(engine,filehits) {\n\tvar files=engine.get(\"filenames\");\n\tvar prevfolder=\"\",hits=0,out=[];\n\tfor (var i=0;i<filehits.length;i++) {\n\t\tvar fn=files[i];\n\t\tvar folder=fn.substring(0,fn.indexOf('/'));\n\t\tif (prevfolder && prevfolder!=folder) {\n\t\t\tout.push(hits);\n\t\t\thits=0;\n\t\t}\n\t\thits+=filehits[i].length;\n\t\tprevfolder=folder;\n\t}\n\tout.push(hits);\n\treturn out;\n}\nvar phrase_intersect=function(engine,Q) {\n\tvar intersected=null;\n\tvar fileoffsets=Q.engine.get(\"fileoffsets\");\n\tvar empty=[],emptycount=0,hashit=0;\n\tfor (var i=0;i<Q.phrases.length;i++) {\n\t\tvar byfile=plist.groupbyposting2(Q.phrases[i].posting,fileoffsets);\n\t\tif (byfile.length) byfile.shift();\n\t\tif (byfile.length) byfile.pop();\n\t\tbyfile.pop();\n\t\tif (intersected==null) {\n\t\t\tintersected=byfile;\n\t\t} else {\n\t\t\tfor (var j=0;j<byfile.length;j++) {\n\t\t\t\tif (!(byfile[j].length && intersected[j].length)) {\n\t\t\t\t\tintersected[j]=empty; //reuse empty array\n\t\t\t\t\temptycount++;\n\t\t\t\t} else hashit++;\n\t\t\t}\n\t\t}\n\t}\n\n\tQ.byFile=intersected;\n\tQ.byFolder=groupByFolder(engine,Q.byFile);\n\tvar out=[];\n\t//calculate new rawposting\n\tfor (var i=0;i<Q.byFile.length;i++) {\n\t\tif (Q.byFile[i].length) out=out.concat(Q.byFile[i]);\n\t}\n\tQ.rawresult=out;\n\tcountFolderFile(Q);\n}\nvar countFolderFile=function(Q) {\n\tQ.fileWithHitCount=0;\n\tQ.byFile.map(function(f){if (f.length) Q.fileWithHitCount++});\n\t\t\t\n\tQ.folderWithHitCount=0;\n\tQ.byFolder.map(function(f){if (f) Q.folderWithHitCount++});\n}\n\nvar main=function(engine,q,opts,cb){\n\n\tvar starttime=new Date();\n\tvar meta=engine.get(\"meta\");\n\tif (meta.normalize && engine.analyzer.setNormalizeTable) {\n\t\tmeta.normalizeObj=engine.analyzer.setNormalizeTable(meta.normalize,meta.normalizeObj);\n\t}\n\tif (typeof opts==\"function\") cb=opts;\n\topts=opts||{};\n\tvar Q=engine.queryCache[q];\n\tif (!Q) Q=newQuery(engine,q,opts); \n\tif (!Q) {\n\t\tengine.searchtime=new Date()-starttime;\n\t\tengine.totaltime=engine.searchtime;\n\t\tif (engine.context) cb.apply(engine.context,[\"empty result\",{rawresult:[]}]);\n\t\telse cb(\"empty result\",{rawresult:[]});\n\t\treturn;\n\t};\n\tengine.queryCache[q]=Q;\n\tif (Q.phrases.length) {\n\t\t\n\t\tloadPostings(engine,Q.terms,function(){\n\t\t\tif (!Q.phrases[0].posting) {\n\t\t\t\tengine.searchtime=new Date()-starttime;\n\t\t\t\tengine.totaltime=engine.searchtime;\n\t\t\t\tcb.apply(engine.context,[\"no such posting\",{rawresult:[]}]);\n\t\t\t\treturn;\t\t\t\n\t\t\t}\n\t\t\t\n\t\t\tif (!Q.phrases[0].posting.length) { //\n\t\t\t\tQ.phrases.forEach(loadPhrase.bind(Q));\n\t\t\t}\n\t\t\tif (Q.phrases.length==1) {\n\t\t\t\tQ.rawresult=Q.phrases[0].posting;\n\t\t\t} else {\n\t\t\t\tphrase_intersect(engine,Q);\n\t\t\t}\n\t\t\tvar fileoffsets=Q.engine.get(\"fileoffsets\");\n\t\t\t//console.log(\"search opts \"+JSON.stringify(opts));\n\n\t\t\tif (!Q.byFile && Q.rawresult && !opts.nogroup) {\n\t\t\t\tQ.byFile=plist.groupbyposting2(Q.rawresult, fileoffsets);\n\t\t\t\tQ.byFile.shift();Q.byFile.pop();\n\t\t\t\tQ.byFolder=groupByFolder(engine,Q.byFile);\n\n\t\t\t\tcountFolderFile(Q);\n\t\t\t}\n\n\t\t\tif (opts.range) {\n\t\t\t\tengine.searchtime=new Date()-starttime;\n\t\t\t\texcerpt.resultlist(engine,Q,opts,function(data) { \n\t\t\t\t\t//console.log(\"excerpt ok\");\n\t\t\t\t\tQ.excerpt=data;\n\t\t\t\t\tengine.totaltime=new Date()-starttime;\n\t\t\t\t\tcb.apply(engine.context,[0,Q]);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tengine.searchtime=new Date()-starttime;\n\t\t\t\tengine.totaltime=new Date()-starttime;\n\t\t\t\tcb.apply(engine.context,[0,Q]);\n\t\t\t}\n\t\t});\n\t} else { //empty search\n\t\tengine.searchtime=new Date()-starttime;\n\t\tengine.totaltime=new Date()-starttime;\n\t\tcb.apply(engine.context,[0,Q]);\n\t};\n}\n\nmain.splitPhrase=splitPhrase; //just for debug\nmodule.exports=main;",
    "/** @jsx React.DOM */\n/*\nconvert to pure js\nsave -g reactify\n*/\nvar E=React.createElement;\n\nvar hasksanagap=(typeof ksanagap!=\"undefined\");\nif (hasksanagap && (typeof console==\"undefined\" || typeof console.log==\"undefined\")) {\n\t\twindow.console={log:ksanagap.log,error:ksanagap.error,debug:ksanagap.debug,warn:ksanagap.warn};\n\t\tconsole.log(\"install console output funciton\");\n}\n\nvar checkfs=function() {\n\treturn (navigator && navigator.webkitPersistentStorage) || hasksanagap;\n}\nvar featurechecks={\n\t\"fs\":checkfs\n}\nvar checkbrowser = React.createClass({\n\tgetInitialState:function() {\n\n\t\tvar missingFeatures=this.getMissingFeatures();\n\t\treturn {ready:false, missing:missingFeatures};\n\t},\n\tgetMissingFeatures:function() {\n\t\tvar feature=this.props.feature.split(\",\");\n\t\tvar status=[];\n\t\tfeature.map(function(f){\n\t\t\tvar checker=featurechecks[f];\n\t\t\tif (checker) checker=checker();\n\t\t\tstatus.push([f,checker]);\n\t\t});\n\t\treturn status.filter(function(f){return !f[1]});\n\t},\n\tdownloadbrowser:function() {\n\t\twindow.location=\"https://www.google.com/chrome/\"\n\t},\n\trenderMissing:function() {\n\t\tvar showMissing=function(m) {\n\t\t\treturn E(\"div\", null, m);\n\t\t}\n\t\treturn (\n\t\t E(\"div\", {ref: \"dialog1\", className: \"modal fade\", \"data-backdrop\": \"static\"}, \n\t\t    E(\"div\", {className: \"modal-dialog\"}, \n\t\t      E(\"div\", {className: \"modal-content\"}, \n\t\t        E(\"div\", {className: \"modal-header\"}, \n\t\t          E(\"button\", {type: \"button\", className: \"close\", \"data-dismiss\": \"modal\", \"aria-hidden\": \"true\"}, \"×\"), \n\t\t          E(\"h4\", {className: \"modal-title\"}, \"Browser Check\")\n\t\t        ), \n\t\t        E(\"div\", {className: \"modal-body\"}, \n\t\t          E(\"p\", null, \"Sorry but the following feature is missing\"), \n\t\t          this.state.missing.map(showMissing)\n\t\t        ), \n\t\t        E(\"div\", {className: \"modal-footer\"}, \n\t\t          E(\"button\", {onClick: this.downloadbrowser, type: \"button\", className: \"btn btn-primary\"}, \"Download Google Chrome\")\n\t\t        )\n\t\t      )\n\t\t    )\n\t\t  )\n\t\t );\n\t},\n\trenderReady:function() {\n\t\treturn E(\"span\", null, \"browser ok\")\n\t},\n\trender:function(){\n\t\treturn  (this.state.missing.length)?this.renderMissing():this.renderReady();\n\t},\n\tcomponentDidMount:function() {\n\t\tif (!this.state.missing.length) {\n\t\t\tthis.props.onReady();\n\t\t} else {\n\t\t\t$(this.refs.dialog1.getDOMNode()).modal('show');\n\t\t}\n\t}\n});\n\nmodule.exports=checkbrowser;",
    "\nvar userCancel=false;\nvar files=[];\nvar totalDownloadByte=0;\nvar targetPath=\"\";\nvar tempPath=\"\";\nvar nfile=0;\nvar baseurl=\"\";\nvar result=\"\";\nvar downloading=false;\nvar startDownload=function(dbid,_baseurl,_files) { //return download id\n\tvar fs     = require(\"fs\");\n\tvar path   = require(\"path\");\n\n\t\n\tfiles=_files.split(\"\\uffff\");\n\tif (downloading) return false; //only one session\n\tuserCancel=false;\n\ttotalDownloadByte=0;\n\tnextFile();\n\tdownloading=true;\n\tbaseurl=_baseurl;\n\tif (baseurl[baseurl.length-1]!='/')baseurl+='/';\n\ttargetPath=ksanagap.rootPath+dbid+'/';\n\ttempPath=ksanagap.rootPath+\".tmp/\";\n\tresult=\"\";\n\treturn true;\n}\n\nvar nextFile=function() {\n\tsetTimeout(function(){\n\t\tif (nfile==files.length) {\n\t\t\tnfile++;\n\t\t\tendDownload();\n\t\t} else {\n\t\t\tdownloadFile(nfile++);\t\n\t\t}\n\t},100);\n}\n\nvar downloadFile=function(nfile) {\n\tvar url=baseurl+files[nfile];\n\tvar tmpfilename=tempPath+files[nfile];\n\tvar mkdirp = require(\"./mkdirp\");\n\tvar fs     = require(\"fs\");\n\tvar http   = require(\"http\");\n\n\tmkdirp.sync(path.dirname(tmpfilename));\n\tvar writeStream = fs.createWriteStream(tmpfilename);\n\tvar datalength=0;\n\tvar request = http.get(url, function(response) {\n\t\tresponse.on('data',function(chunk){\n\t\t\twriteStream.write(chunk);\n\t\t\ttotalDownloadByte+=chunk.length;\n\t\t\tif (userCancel) {\n\t\t\t\twriteStream.end();\n\t\t\t\tsetTimeout(function(){nextFile();},100);\n\t\t\t}\n\t\t});\n\t\tresponse.on(\"end\",function() {\n\t\t\twriteStream.end();\n\t\t\tsetTimeout(function(){nextFile();},100);\n\t\t});\n\t});\n}\n\nvar cancelDownload=function() {\n\tuserCancel=true;\n\tendDownload();\n}\nvar verify=function() {\n\treturn true;\n}\nvar endDownload=function() {\n\tnfile=files.length+1;//stop\n\tresult=\"cancelled\";\n\tdownloading=false;\n\tif (userCancel) return;\n\tvar fs     = require(\"fs\");\n\tvar mkdirp = require(\"./mkdirp\");\n\n\tfor (var i=0;i<files.length;i++) {\n\t\tvar targetfilename=targetPath+files[i];\n\t\tvar tmpfilename   =tempPath+files[i];\n\t\tmkdirp.sync(path.dirname(targetfilename));\n\t\tfs.renameSync(tmpfilename,targetfilename);\n\t}\n\tif (verify()) {\n\t\tresult=\"success\";\n\t} else {\n\t\tresult=\"error\";\n\t}\n}\n\nvar downloadedByte=function() {\n\treturn totalDownloadByte;\n}\nvar doneDownload=function() {\n\tif (nfile>files.length) return result;\n\telse return \"\";\n}\nvar downloadingFile=function() {\n\treturn nfile-1;\n}\n\nvar downloader={startDownload:startDownload, downloadedByte:downloadedByte,\n\tdownloadingFile:downloadingFile, cancelDownload:cancelDownload,doneDownload:doneDownload};\nmodule.exports=downloader;",
    "/** @jsx React.DOM */\n\n/* todo , optional kdb */\n\nvar HtmlFS=require(\"./htmlfs\");\nvar html5fs=require(\"./html5fs\");\nvar CheckBrowser=require(\"./checkbrowser\");\nvar E=React.createElement;\n  \n\nvar FileList = React.createClass({\n\tgetInitialState:function() {\n\t\treturn {downloading:false,progress:0};\n\t},\n\tupdatable:function(f) {\n        var classes=\"btn btn-warning\";\n        if (this.state.downloading) classes+=\" disabled\";\n\t\tif (f.hasUpdate) return   E(\"button\", {className: classes, \n\t\t\t\"data-filename\": f.filename, \"data-url\": f.url, \n\t            onClick: this.download\n\t       }, \"Update\")\n\t\telse return null;\n\t},\n\tshowLocal:function(f) {\n        var classes=\"btn btn-danger\";\n        if (this.state.downloading) classes+=\" disabled\";\n\t  return E(\"tr\", null, E(\"td\", null, f.filename), \n\t      E(\"td\", null), \n\t      E(\"td\", {className: \"pull-right\"}, \n\t      this.updatable(f), E(\"button\", {className: classes, \n\t               onClick: this.deleteFile, \"data-filename\": f.filename}, \"Delete\")\n\t        \n\t      )\n\t  )\n\t},  \n\tshowRemote:function(f) { \n\t  var classes=\"btn btn-warning\";\n\t  if (this.state.downloading) classes+=\" disabled\";\n\t  return (E(\"tr\", {\"data-id\": f.filename}, E(\"td\", null, \n\t      f.filename), \n\t      E(\"td\", null, f.desc), \n\t      E(\"td\", null, \n\t      E(\"span\", {\"data-filename\": f.filename, \"data-url\": f.url, \n\t            className: classes, \n\t            onClick: this.download}, \"Download\")\n\t      )\n\t  ));\n\t},\n\tshowFile:function(f) {\n\t//\treturn <span data-id={f.filename}>{f.url}</span>\n\t\treturn (f.ready)?this.showLocal(f):this.showRemote(f);\n\t},\n\treloadDir:function() {\n\t\tthis.props.action(\"reload\");\n\t},\n\tdownload:function(e) {\n\t\tvar url=e.target.dataset[\"url\"];\n\t\tvar filename=e.target.dataset[\"filename\"];\n\t\tthis.setState({downloading:true,progress:0,url:url});\n\t\tthis.userbreak=false;\n\t\thtml5fs.download(url,filename,function(){\n\t\t\tthis.reloadDir();\n\t\t\tthis.setState({downloading:false,progress:1});\n\t\t\t},function(progress,total){\n\t\t\t\tif (progress==0) {\n\t\t\t\t\tthis.setState({message:\"total \"+total})\n\t\t\t \t}\n\t\t\t \tthis.setState({progress:progress});\n\t\t\t \t//if user press abort return true\n\t\t\t \treturn this.userbreak;\n\t\t\t}\n\t\t,this);\n\t},\n\tdeleteFile:function( e) {\n\t\tvar filename=e.target.attributes[\"data-filename\"].value;\n\t\tthis.props.action(\"delete\",filename);\n\t},\n\tallFilesReady:function(e) {\n\t\treturn this.props.files.every(function(f){ return f.ready});\n\t},\n\tdismiss:function() {\n\t\t$(this.refs.dialog1.getDOMNode()).modal('hide');\n\t\tthis.props.action(\"dismiss\");\n\t},\n\tabortdownload:function() {\n\t\tthis.userbreak=true;\n\t},\n\tshowProgress:function() {\n\t     if (this.state.downloading) {\n\t      var progress=Math.round(this.state.progress*100);\n\t      return (\n\t      \tE(\"div\", null, \n\t      \t\"Downloading from \", this.state.url, \n\t      E(\"div\", {key: \"progress\", className: \"progress col-md-8\"}, \n\t          E(\"div\", {className: \"progress-bar\", role: \"progressbar\", \n\t              \"aria-valuenow\": progress, \"aria-valuemin\": \"0\", \n\t              \"aria-valuemax\": \"100\", style: {width: progress+\"%\"}}, \n\t            progress, \"%\"\n\t          )\n\t        ), \n\t        E(\"button\", {onClick: this.abortdownload, \n\t        \tclassName: \"btn btn-danger col-md-4\"}, \"Abort\")\n\t        )\n\t        );\n\t      } else {\n\t      \t\tif ( this.allFilesReady() ) {\n\t      \t\t\treturn E(\"button\", {onClick: this.dismiss, className: \"btn btn-success\"}, \"Ok\")\n\t      \t\t} else return null;\n\t      \t\t\n\t      }\n\t},\n\tshowUsage:function() {\n\t\tvar percent=this.props.remainPercent;\n           return (E(\"div\", null, E(\"span\", {className: \"pull-left\"}, \"Usage:\"), E(\"div\", {className: \"progress\"}, \n\t\t  E(\"div\", {className: \"progress-bar progress-bar-success progress-bar-striped\", role: \"progressbar\", style: {width: percent+\"%\"}}, \n\t\t    \tpercent+\"%\"\n\t\t  )\n\t\t)));\n\t},\n\trender:function() {\n\t  \treturn (\n\t\tE(\"div\", {ref: \"dialog1\", className: \"modal fade\", \"data-backdrop\": \"static\"}, \n\t\t    E(\"div\", {className: \"modal-dialog\"}, \n\t\t      E(\"div\", {className: \"modal-content\"}, \n\t\t        E(\"div\", {className: \"modal-header\"}, \n\t\t          E(\"h4\", {className: \"modal-title\"}, \"File Installer\")\n\t\t        ), \n\t\t        E(\"div\", {className: \"modal-body\"}, \n\t\t        \tE(\"table\", {className: \"table\"}, \n\t\t        \tE(\"tbody\", null, \n\t\t          \tthis.props.files.map(this.showFile)\n\t\t          \t)\n\t\t          )\n\t\t        ), \n\t\t        E(\"div\", {className: \"modal-footer\"}, \n\t\t        \tthis.showUsage(), \n\t\t           this.showProgress()\n\t\t        )\n\t\t      )\n\t\t    )\n\t\t  )\n\t\t);\n\t},\t\n\tcomponentDidMount:function() {\n\t\t$(this.refs.dialog1.getDOMNode()).modal('show');\n\t}\n});\n/*TODO kdb check version*/\nvar Filemanager = React.createClass({\n\tgetInitialState:function() {\n\t\tvar quota=this.getQuota();\n\t\treturn {browserReady:false,noupdate:true,\trequestQuota:quota,remain:0};\n\t},\n\tgetQuota:function() {\n\t\tvar q=this.props.quota||\"128M\";\n\t\tvar unit=q[q.length-1];\n\t\tvar times=1;\n\t\tif (unit==\"M\") times=1024*1024;\n\t\telse if (unit=\"K\") times=1024;\n\t\treturn parseInt(q) * times;\n\t},\n\tmissingKdb:function() {\n\t\tif (ksanagap.platform!=\"chrome\") return [];\n\t\tvar missing=this.props.needed.filter(function(kdb){\n\t\t\tfor (var i in html5fs.files) {\n\t\t\t\tif (html5fs.files[i][0]==kdb.filename) return false;\n\t\t\t}\n\t\t\treturn true;\n\t\t},this);\n\t\treturn missing;\n\t},\n\tgetRemoteUrl:function(fn) {\n\t\tvar f=this.props.needed.filter(function(f){return f.filename==fn});\n\t\tif (f.length ) return f[0].url;\n\t},\n\tgenFileList:function(existing,missing){\n\t\tvar out=[];\n\t\tfor (var i in existing) {\n\t\t\tvar url=this.getRemoteUrl(existing[i][0]);\n\t\t\tout.push({filename:existing[i][0], url :url, ready:true });\n\t\t}\n\t\tfor (var i in missing) {\n\t\t\tout.push(missing[i]);\n\t\t}\n\t\treturn out;\n\t},\n\treload:function() {\n\t\thtml5fs.readdir(function(files){\n  \t\t\tthis.setState({files:this.genFileList(files,this.missingKdb())});\n  \t\t},this);\n\t },\n\tdeleteFile:function(fn) {\n\t  html5fs.rm(fn,function(){\n\t  \tthis.reload();\n\t  },this);\n\t},\n\tonQuoteOk:function(quota,usage) {\n\t\tif (ksanagap.platform!=\"chrome\") {\n\t\t\t//console.log(\"onquoteok\");\n\t\t\tthis.setState({noupdate:true,missing:[],files:[],autoclose:true\n\t\t\t\t,quota:quota,remain:quota-usage,usage:usage});\n\t\t\treturn;\n\t\t}\n\t\t//console.log(\"quote ok\");\n\t\tvar files=this.genFileList(html5fs.files,this.missingKdb());\n\t\tvar that=this;\n\t\tthat.checkIfUpdate(files,function(hasupdate) {\n\t\t\tvar missing=this.missingKdb();\n\t\t\tvar autoclose=this.props.autoclose;\n\t\t\tif (missing.length) autoclose=false;\n\t\t\tthat.setState({autoclose:autoclose,\n\t\t\t\tquota:quota,usage:usage,files:files,\n\t\t\t\tmissing:missing,\n\t\t\t\tnoupdate:!hasupdate,\n\t\t\t\tremain:quota-usage});\n\t\t});\n\t},  \n\tonBrowserOk:function() {\n\t  this.totalDownloadSize();\n\t}, \n\tdismiss:function() {\n\t\tthis.props.onReady(this.state.usage,this.state.quota);\n\t\tsetTimeout(function(){\n\t\t\tvar modalin=$(\".modal.in\");\n\t\t\tif (modalin.modal) modalin.modal('hide');\n\t\t},500);\n\t}, \n\ttotalDownloadSize:function() {\n\t\tvar files=this.missingKdb();\n\t\tvar taskqueue=[],totalsize=0;\n\t\tfor (var i=0;i<files.length;i++) {\n\t\t\ttaskqueue.push(\n\t\t\t\t(function(idx){\n\t\t\t\t\treturn (function(data){\n\t\t\t\t\t\tif (!(typeof data=='object' && data.__empty)) totalsize+=data;\n\t\t\t\t\t\thtml5fs.getDownloadSize(files[idx].url,taskqueue.shift());\n\t\t\t\t\t});\n\t\t\t\t})(i)\n\t\t\t);\n\t\t}\n\t\tvar that=this;\n\t\ttaskqueue.push(function(data){\t\n\t\t\ttotalsize+=data;\n\t\t\tsetTimeout(function(){that.setState({requireSpace:totalsize,browserReady:true})},0);\n\t\t});\n\t\ttaskqueue.shift()({__empty:true});\n\t},\n\tcheckIfUpdate:function(files,cb) {\n\t\tvar taskqueue=[];\n\t\tfor (var i=0;i<files.length;i++) {\n\t\t\ttaskqueue.push(\n\t\t\t\t(function(idx){\n\t\t\t\t\treturn (function(data){\n\t\t\t\t\t\tif (!(typeof data=='object' && data.__empty)) files[idx-1].hasUpdate=data;\n\t\t\t\t\t\thtml5fs.checkUpdate(files[idx].url,files[idx].filename,taskqueue.shift());\n\t\t\t\t\t});\n\t\t\t\t})(i)\n\t\t\t);\n\t\t}\n\t\tvar that=this;\n\t\ttaskqueue.push(function(data){\t\n\t\t\tfiles[files.length-1].hasUpdate=data;\n\t\t\tvar hasupdate=files.some(function(f){return f.hasUpdate});\n\t\t\tif (cb) cb.apply(that,[hasupdate]);\n\t\t});\n\t\ttaskqueue.shift()({__empty:true});\n\t},\n\trender:function(){\n    \t\tif (!this.state.browserReady) {   \n      \t\t\treturn E(CheckBrowser, {feature: \"fs\", onReady: this.onBrowserOk})\n    \t\t} if (!this.state.quota || this.state.remain<this.state.requireSpace) {  \n    \t\t\tvar quota=this.state.requestQuota;\n    \t\t\tif (this.state.usage+this.state.requireSpace>quota) {\n    \t\t\t\tquota=(this.state.usage+this.state.requireSpace)*1.5;\n    \t\t\t}\n      \t\t\treturn E(HtmlFS, {quota: quota, autoclose: \"true\", onReady: this.onQuoteOk})\n      \t\t} else {\n\t\t\tif (!this.state.noupdate || this.missingKdb().length || !this.state.autoclose) {\n\t\t\t\tvar remain=Math.round((this.state.usage/this.state.quota)*100);\t\t\t\t\n\t\t\t\treturn E(FileList, {action: this.action, files: this.state.files, remainPercent: remain})\n\t\t\t} else {\n\t\t\t\tsetTimeout( this.dismiss ,0);\n\t\t\t\treturn E(\"span\", null, \"Success\");\n\t\t\t}\n      \t\t}\n\t},\n\taction:function() {\n\t  var args = Array.prototype.slice.call(arguments);\n\t  var type=args.shift();\n\t  var res=null, that=this;\n\t  if (type==\"delete\") {\n\t    this.deleteFile(args[0]);\n\t  }  else if (type==\"reload\") {\n\t  \tthis.reload();\n\t  } else if (type==\"dismiss\") {\n\t  \tthis.dismiss();\n\t  }\n\t}\n});\n\nmodule.exports=Filemanager;",
    "/* emulate filesystem on html5 browser */\nvar get_head=function(url,field,cb){\n\tvar xhr = new XMLHttpRequest();\n\txhr.open(\"HEAD\", url, true);\n\txhr.onreadystatechange = function() {\n\t\t\tif (this.readyState == this.DONE) {\n\t\t\t\tcb(xhr.getResponseHeader(field));\n\t\t\t} else {\n\t\t\t\tif (this.status!==200&&this.status!==206) {\n\t\t\t\t\tcb(\"\");\n\t\t\t\t}\n\t\t\t} \n\t};\n\txhr.send();\t\n}\nvar get_date=function(url,cb) {\n\tget_head(url,\"Last-Modified\",function(value){\n\t\tcb(value);\n\t});\n}\nvar get_size=function(url, cb) {\n\tget_head(url,\"Content-Length\",function(value){\n\t\tcb(parseInt(value));\n\t});\n};\nvar checkUpdate=function(url,fn,cb) {\n\tif (!url) {\n\t\tcb(false);\n\t\treturn;\n\t}\n\tget_date(url,function(d){\n\t\tAPI.fs.root.getFile(fn, {create: false, exclusive: false}, function(fileEntry) {\n\t\t\tfileEntry.getMetadata(function(metadata){\n\t\t\t\tvar localDate=Date.parse(metadata.modificationTime);\n\t\t\t\tvar urlDate=Date.parse(d);\n\t\t\t\tcb(urlDate>localDate);\n\t\t\t});\n\t\t},function(){\n\t\t\tcb(false);\n\t\t});\n\t});\n}\nvar download=function(url,fn,cb,statuscb,context) {\n\t var totalsize=0,batches=null,written=0;\n\t var fileEntry=0, fileWriter=0;\n\t var createBatches=function(size) {\n\t\tvar bytes=1024*1024, out=[];\n\t\tvar b=Math.floor(size / bytes);\n\t\tvar last=size %bytes;\n\t\tfor (var i=0;i<=b;i++) {\n\t\t\tout.push(i*bytes);\n\t\t}\n\t\tout.push(b*bytes+last);\n\t\treturn out;\n\t }\n\t var finish=function() {\n\t\t rm(fn,function(){\n\t\t\t\tfileEntry.moveTo(fileEntry.filesystem.root, fn,function(){\n\t\t\t\t\tsetTimeout( cb.bind(context,false) , 0) ; \n\t\t\t\t},function(e){\n\t\t\t\t\tconsole.log(\"failed\",e)\n\t\t\t\t});\n\t\t },this); \n\t };\n\t\tvar tempfn=\"temp.kdb\";\n\t\tvar batch=function(b) {\n\t\tvar abort=false;\n\t\tvar xhr = new XMLHttpRequest();\n\t\tvar requesturl=url+\"?\"+Math.random();\n\t\txhr.open('get', requesturl, true);\n\t\txhr.setRequestHeader('Range', 'bytes='+batches[b]+'-'+(batches[b+1]-1));\n\t\txhr.responseType = 'blob';    \n\t\txhr.addEventListener('load', function() {\n\t\t\tvar blob=this.response;\n\t\t\tfileEntry.createWriter(function(fileWriter) {\n\t\t\t\tfileWriter.seek(fileWriter.length);\n\t\t\t\tfileWriter.write(blob);\n\t\t\t\twritten+=blob.size;\n\t\t\t\tfileWriter.onwriteend = function(e) {\n\t\t\t\t\tif (statuscb) {\n\t\t\t\t\t\tabort=statuscb.apply(context,[ fileWriter.length / totalsize,totalsize ]);\n\t\t\t\t\t\tif (abort) setTimeout( cb.bind(context,false) , 0) ;\n\t\t\t\t \t}\n\t\t\t\t\tb++;\n\t\t\t\t\tif (!abort) {\n\t\t\t\t\t\tif (b<batches.length-1) setTimeout(batch.bind(context,b),0);\n\t\t\t\t\t\telse                    finish();\n\t\t\t\t \t}\n\t\t\t \t};\n\t\t\t}, console.error);\n\t\t},false);\n\t\txhr.send();\n\t}\n\n\tget_size(url,function(size){\n\t\ttotalsize=size;\n\t\tif (!size) {\n\t\t\tif (cb) cb.apply(context,[false]);\n\t\t} else {//ready to download\n\t\t\trm(tempfn,function(){\n\t\t\t\t batches=createBatches(size);\n\t\t\t\t if (statuscb) statuscb.apply(context,[ 0, totalsize ]);\n\t\t\t\t API.fs.root.getFile(tempfn, {create: 1, exclusive: false}, function(_fileEntry) {\n\t\t\t\t\t\t\tfileEntry=_fileEntry;\n\t\t\t\t\t\tbatch(0);\n\t\t\t\t });\n\t\t\t},this);\n\t\t}\n\t});\n}\n\nvar readFile=function(filename,cb,context) {\n\tAPI.fs.root.getFile(filename, function(fileEntry) {\n\t\t\tvar reader = new FileReader();\n\t\t\treader.onloadend = function(e) {\n\t\t\t\t\tif (cb) cb.apply(cb,[this.result]);\n\t\t\t\t};            \n\t}, console.error);\n}\nvar writeFile=function(filename,buf,cb,context){\n\tAPI.fs.root.getFile(filename, {create: true, exclusive: true}, function(fileEntry) {\n\t\t\tfileEntry.createWriter(function(fileWriter) {\n\t\t\t\tfileWriter.write(buf);\n\t\t\t\tfileWriter.onwriteend = function(e) {\n\t\t\t\t\tif (cb) cb.apply(cb,[buf.byteLength]);\n\t\t\t\t};            \n\t\t\t}, console.error);\n\t}, console.error);\n}\n\nvar readdir=function(cb,context) {\n\tvar dirReader = API.fs.root.createReader();\n\tvar out=[],that=this;\n\tdirReader.readEntries(function(entries) {\n\t\tif (entries.length) {\n\t\t\tfor (var i = 0, entry; entry = entries[i]; ++i) {\n\t\t\t\tif (entry.isFile) {\n\t\t\t\t\tout.push([entry.name,entry.toURL ? entry.toURL() : entry.toURI()]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tAPI.files=out;\n\t\tif (cb) cb.apply(context,[out]);\n\t}, function(){\n\t\tif (cb) cb.apply(context,[null]);\n\t});\n}\nvar getFileURL=function(filename) {\n\tif (!API.files ) return null;\n\tvar file= API.files.filter(function(f){return f[0]==filename});\n\tif (file.length) return file[0][1];\n}\nvar rm=function(filename,cb,context) {\n\tvar url=getFileURL(filename);\n\tif (url) rmURL(url,cb,context);\n\telse if (cb) cb.apply(context,[false]);\n}\n\nvar rmURL=function(filename,cb,context) {\n\twebkitResolveLocalFileSystemURL(filename, function(fileEntry) {\n\t\tfileEntry.remove(function() {\n\t\t\tif (cb) cb.apply(context,[true]);\n\t\t}, console.error);\n\t},  function(e){\n\t\tif (cb) cb.apply(context,[false]);//no such file\n\t});\n}\nfunction errorHandler(e) {\n\tconsole.error('Error: ' +e.name+ \" \"+e.message);\n}\nvar initfs=function(grantedBytes,cb,context) {\n\twebkitRequestFileSystem(PERSISTENT, grantedBytes,  function(fs) {\n\t\tAPI.fs=fs;\n\t\tAPI.quota=grantedBytes;\n\t\treaddir(function(){\n\t\t\tAPI.initialized=true;\n\t\t\tcb.apply(context,[grantedBytes,fs]);\n\t\t},context);\n\t}, errorHandler);\n}\nvar init=function(quota,cb,context) {\n\tnavigator.webkitPersistentStorage.requestQuota(quota, \n\t\t\tfunction(grantedBytes) {\n\t\t\t\tinitfs(grantedBytes,cb,context);\n\t\t}, errorHandler\n\t);\n}\nvar queryQuota=function(cb,context) {\n\tvar that=this;\n\tnavigator.webkitPersistentStorage.queryUsageAndQuota( \n\t function(usage,quota){\n\t\t\tinitfs(quota,function(){\n\t\t\t\tcb.apply(context,[usage,quota]);\n\t\t\t},context);\n\t});\n}\nvar API={\n\tinit:init\n\t,readdir:readdir\n\t,checkUpdate:checkUpdate\n\t,rm:rm\n\t,rmURL:rmURL\n\t,getFileURL:getFileURL\n\t,writeFile:writeFile\n\t,readFile:readFile\n\t,download:download\n\t,get_head:get_head\n\t,get_date:get_date\n\t,get_size:get_size\n\t,getDownloadSize:get_size\n\t,queryQuota:queryQuota\n}\nmodule.exports=API;",
    "var html5fs=require(\"./html5fs\");\nvar E=React.createElement;\n\nvar htmlfs = React.createClass({\n\tgetInitialState:function() { \n\t\treturn {ready:false, quota:0,usage:0,Initialized:false,autoclose:this.props.autoclose};\n\t},\n\tinitFilesystem:function() {\n\t\tvar quota=this.props.quota||1024*1024*128; // default 128MB\n\t\tquota=parseInt(quota);\n\t\thtml5fs.init(quota,function(q){\n\t\t\tthis.dialog=false;\n\t\t\t$(this.refs.dialog1.getDOMNode()).modal('hide');\n\t\t\tthis.setState({quota:q,autoclose:true});\n\t\t},this);\n\t},\n\twelcome:function() {\n\t\treturn (\n\t\tE(\"div\", {ref: \"dialog1\", className: \"modal fade\", id: \"myModal\", \"data-backdrop\": \"static\"}, \n\t\t    E(\"div\", {className: \"modal-dialog\"}, \n\t\t      E(\"div\", {className: \"modal-content\"}, \n\t\t        E(\"div\", {className: \"modal-header\"}, \n\t\t          E(\"h4\", {className: \"modal-title\"}, \"Welcome\")\n\t\t        ), \n\t\t        E(\"div\", {className: \"modal-body\"}, \n\t\t          \"Browser will ask for your confirmation.\"\n\t\t        ), \n\t\t        E(\"div\", {className: \"modal-footer\"}, \n\t\t          E(\"button\", {onClick: this.initFilesystem, type: \"button\", \n\t\t            className: \"btn btn-primary\"}, \"Initialize File System\")\n\t\t        )\n\t\t      )\n\t\t    )\n\t\t  )\n\t\t );\n\t},\n\trenderDefault:function(){\n\t\tvar used=Math.floor(this.state.usage/this.state.quota *100);\n\t\tvar more=function() {\n\t\t\tif (used>50) return E(\"button\", {type: \"button\", className: \"btn btn-primary\"}, \"Allocate More\");\n\t\t\telse null;\n\t\t}\n\t\treturn (\n\t\tE(\"div\", {ref: \"dialog1\", className: \"modal fade\", id: \"myModal\", \"data-backdrop\": \"static\"}, \n\t\t    E(\"div\", {className: \"modal-dialog\"}, \n\t\t      E(\"div\", {className: \"modal-content\"}, \n\t\t        E(\"div\", {className: \"modal-header\"}, \n\t\t          E(\"h4\", {className: \"modal-title\"}, \"Sandbox File System\")\n\t\t        ), \n\t\t        E(\"div\", {className: \"modal-body\"}, \n\t\t          E(\"div\", {className: \"progress\"}, \n\t\t            E(\"div\", {className: \"progress-bar\", role: \"progressbar\", style: {width: used+\"%\"}}, \n\t\t               used, \"%\"\n\t\t            )\n\t\t          ), \n\t\t          E(\"span\", null, this.state.quota, \" total , \", this.state.usage, \" in used\")\n\t\t        ), \n\t\t        E(\"div\", {className: \"modal-footer\"}, \n\t\t          E(\"button\", {onClick: this.dismiss, type: \"button\", className: \"btn btn-default\", \"data-dismiss\": \"modal\"}, \"Close\"), \n\t\t          more()\n\t\t        )\n\t\t      )\n\t\t    )\n\t\t  )\n\t\t  );\n\t},\n\tdismiss:function() {\n\t\tvar that=this;\n\t\tsetTimeout(function(){\n\t\t\tthat.props.onReady(that.state.quota,that.state.usage);\t\n\t\t},0);\n\t},\n\tqueryQuota:function() {\n\t\tif (ksanagap.platform==\"chrome\") {\n\t\t\thtml5fs.queryQuota(function(usage,quota){\n\t\t\t\tthis.setState({usage:usage,quota:quota,initialized:true});\n\t\t\t},this);\t\t\t\n\t\t} else {\n\t\t\tthis.setState({usage:333,quota:1000*1000*1024,initialized:true,autoclose:true});\n\t\t}\n\t},\n\trender:function() {\n\t\tvar that=this;\n\t\tif (!this.state.quota || this.state.quota<this.props.quota) {\n\t\t\tif (this.state.initialized) {\n\t\t\t\tthis.dialog=true;\n\t\t\t\treturn this.welcome();\t\n\t\t\t} else {\n\t\t\t\treturn E(\"span\", null, \"checking quota\");\n\t\t\t}\t\t\t\n\t\t} else {\n\t\t\tif (!this.state.autoclose) {\n\t\t\t\tthis.dialog=true;\n\t\t\t\treturn this.renderDefault(); \n\t\t\t}\n\t\t\tthis.dismiss();\n\t\t\tthis.dialog=false;\n\t\t\treturn null;\n\t\t}\n\t},\n\tcomponentDidMount:function() {\n\t\tif (!this.state.quota) {\n\t\t\tthis.queryQuota();\n\n\t\t};\n\t},\n\tcomponentDidUpdate:function() {\n\t\tif (this.dialog) $(this.refs.dialog1.getDOMNode()).modal('show');\n\t}\n});\n\nmodule.exports=htmlfs;",
    "var ksana={\"platform\":\"remote\"};\nif (typeof window!=\"undefined\") {\n\twindow.ksana=ksana;\n\tif (typeof ksanagap==\"undefined\") {\n\t\twindow.ksanagap=require(\"./ksanagap\"); //compatible layer with mobile\n\t}\n}\nif (typeof process !=\"undefined\") {\n\tif (process.versions && process.versions[\"node-webkit\"]) {\n  \t\tif (typeof nodeRequire!=\"undefined\") ksana.require=nodeRequire;\n  \t\tksana.platform=\"node-webkit\";\n  \t\twindow.ksanagap.platform=\"node-webkit\";\n\t\tvar ksanajs=require(\"fs\").readFileSync(\"ksana.js\",\"utf8\").trim();\n\t\tksana.js=JSON.parse(ksanajs.substring(14,ksanajs.length-1));\n\t\twindow.kfs=require(\"./kfs\");\n  \t}\n} else if (typeof chrome!=\"undefined\"){//} && chrome.fileSystem){\n//\twindow.ksanagap=require(\"./ksanagap\"); //compatible layer with mobile\n\twindow.ksanagap.platform=\"chrome\";\n\twindow.kfs=require(\"./kfs_html5\");\n\tif(window.location.origin.indexOf(\"//127.0.0.1\")>-1) {\n\t\trequire(\"./livereload\")();\n\t}\n\tksana.platform=\"chrome\";\n} else {\n\tif (typeof ksanagap!=\"undefined\" && typeof fs!=\"undefined\") {//mobile\n\t\tvar ksanajs=fs.readFileSync(\"ksana.js\",\"utf8\").trim(); //android extra \\n at the end\n\t\tksana.js=JSON.parse(ksanajs.substring(14,ksanajs.length-1));\n\t\tksana.platform=ksanagap.platform;\n\t\tif (typeof ksanagap.android !=\"undefined\") {\n\t\t\tksana.platform=\"android\";\n\t\t}\n\t}\n}\nvar timer=null;\nvar boot=function(appId,cb) {\n\tif (typeof React!=\"undefined\") {\n\t\tReact.initializeTouchEvents(true);\n\t}\n\tksana.appId=appId;\n\tif (ksanagap.platform==\"chrome\") { //need to wait for jsonp ksana.js\n\t\ttimer=setInterval(function(){\n\t\t\tif (ksana.ready){\n\t\t\t\tclearInterval(timer);\n\t\t\t\tif (ksana.js && ksana.js.files && ksana.js.files.length) {\n\t\t\t\t\trequire(\"./installkdb\")(ksana.js,cb);\n\t\t\t\t} else {\n\t\t\t\t\tcb();\t\t\n\t\t\t\t}\n\t\t\t}\n\t\t},300);\n\t} else {\n\t\tcb();\n\t}\n}\n\nmodule.exports={boot:boot\n\t,htmlfs:require(\"./htmlfs\")\n\t,html5fs:require(\"./html5fs\")\n\t,liveupdate:require(\"./liveupdate\")\n\t,fileinstaller:require(\"./fileinstaller\")\n\t,downloader:require(\"./downloader\")\n\t,installkdb:require(\"./installkdb\")\n};",
    "var Fileinstaller=require(\"./fileinstaller\");\n\nvar getRequire_kdb=function() {\n    var required=[];\n    ksana.js.files.map(function(f){\n      if (f.indexOf(\".kdb\")==f.length-4) {\n        var slash=f.lastIndexOf(\"/\");\n        if (slash>-1) {\n          var dbid=f.substring(slash+1,f.length-4);\n          required.push({url:f,dbid:dbid,filename:dbid+\".kdb\"});\n        } else {\n          var dbid=f.substring(0,f.length-4);\n          required.push({url:ksana.js.baseurl+f,dbid:dbid,filename:f});\n        }        \n      }\n    });\n    return required;\n}\nvar callback=null;\nvar onReady=function() {\n\tcallback();\n}\nvar openFileinstaller=function(keep) {\n\tvar require_kdb=getRequire_kdb().map(function(db){\n\t  return {\n\t    url:window.location.origin+window.location.pathname+db.dbid+\".kdb\",\n\t    dbdb:db.dbid,\n\t    filename:db.filename\n\t  }\n\t})\n\treturn React.createElement(Fileinstaller, {quota: \"512M\", autoclose: !keep, needed: require_kdb, \n\t                 onReady: onReady});\n}\nvar installkdb=function(ksanajs,cb,context) {\n\tReact.render(openFileinstaller(),document.getElementById(\"main\"));\n\tcallback=cb;\n}\nmodule.exports=installkdb;",
    "//Simulate feature in ksanagap\n/* \n  runs on node-webkit only\n*/\n\nvar readDir=function(path) { //simulate Ksanagap function\n\tvar fs=nodeRequire(\"fs\");\n\tpath=path||\"..\";\n\tvar dirs=[];\n\tif (path[0]==\".\") {\n\t\tif (path==\".\") dirs=fs.readdirSync(\".\");\n\t\telse {\n\t\t\tdirs=fs.readdirSync(\"..\");\n\t\t}\n\t} else {\n\t\tdirs=fs.readdirSync(path);\n\t}\n\n\treturn dirs.join(\"\\uffff\");\n}\nvar listApps=function() {\n\tvar fs=nodeRequire(\"fs\");\n\tvar ksanajsfile=function(d) {return \"../\"+d+\"/ksana.js\"};\n\tvar dirs=fs.readdirSync(\"..\").filter(function(d){\n\t\t\t\treturn fs.statSync(\"../\"+d).isDirectory() && d[0]!=\".\"\n\t\t\t\t   && fs.existsSync(ksanajsfile(d));\n\t});\n\t\n\tvar out=dirs.map(function(d){\n\t\tvar content=fs.readFileSync(ksanajsfile(d),\"utf8\");\n  \t\tcontent=content.replace(\"})\",\"}\");\n  \t\tcontent=content.replace(\"jsonp_handler(\",\"\");\n  \t\ttry{\n  \t\t\tvar obj= JSON.parse(content);\n\t\t\tobj.dbid=d;\n\t\t\tobj.path=d;\n\t\t\treturn obj;\n  \t\t} catch(e) {\n  \t\t\tconsole.log(e);\n  \t\t\treturn null;\n  \t\t}\n\t});\n\n\tout=out.filter(function(o){return !!o});\n\treturn JSON.stringify(out);\n}\n\n\n\nvar kfs={readDir:readDir,listApps:listApps};\n\nmodule.exports=kfs;",
    "var readDir=function(){\n\treturn \"[]\";\n}\nvar listApps=function(){\n\treturn \"[]\";\n}\nmodule.exports={readDir:readDir,listApps:listApps};",
    "var appname=\"installer\";\nvar switchApp=function(path) {\n\tvar fs=require(\"fs\");\n\tpath=\"../\"+path;\n\tappname=path;\n\tdocument.location.href= path+\"/index.html\"; \n\tprocess.chdir(path);\n}\nvar downloader={};\nvar rootPath=\"\";\n\nvar deleteApp=function(app) {\n\tconsole.error(\"not allow on PC, do it in File Explorer/ Finder\");\n}\nvar username=function() {\n\treturn \"\";\n}\nvar useremail=function() {\n\treturn \"\"\n}\nvar runtime_version=function() {\n\treturn \"1.4\";\n}\n\n//copy from liveupdate\nvar jsonp=function(url,dbid,callback,context) {\n  var script=document.getElementById(\"jsonp2\");\n  if (script) {\n    script.parentNode.removeChild(script);\n  }\n  window.jsonp_handler=function(data) {\n    if (typeof data==\"object\") {\n      data.dbid=dbid;\n      callback.apply(context,[data]);    \n    }  \n  }\n  window.jsonp_error_handler=function() {\n    console.error(\"url unreachable\",url);\n    callback.apply(context,[null]);\n  }\n  script=document.createElement('script');\n  script.setAttribute('id', \"jsonp2\");\n  script.setAttribute('onerror', \"jsonp_error_handler()\");\n  url=url+'?'+(new Date().getTime());\n  script.setAttribute('src', url);\n  document.getElementsByTagName('head')[0].appendChild(script); \n}\n\nvar ksanagap={\n\tplatform:\"node-webkit\",\n\tstartDownload:downloader.startDownload,\n\tdownloadedByte:downloader.downloadedByte,\n\tdownloadingFile:downloader.downloadingFile,\n\tcancelDownload:downloader.cancelDownload,\n\tdoneDownload:downloader.doneDownload,\n\tswitchApp:switchApp,\n\trootPath:rootPath,\n\tdeleteApp: deleteApp,\n\tusername:username, //not support on PC\n\tuseremail:username,\n\truntime_version:runtime_version,\n\t\n}\n\nif (typeof process!=\"undefined\" && !process.browser) {\n\tvar ksanajs=require(\"fs\").readFileSync(\"./ksana.js\",\"utf8\").trim();\n\tdownloader=require(\"./downloader\");\n\t//ksana.js=JSON.parse(ksanajs.substring(14,ksanajs.length-1));\n\trootPath=process.cwd();\n\trootPath=require(\"path\").resolve(rootPath,\"..\").replace(/\\\\/g,\"/\")+'/';\n\tksana.ready=true;\n} else{\n\tvar url=window.location.origin+window.location.pathname.replace(\"index.html\",\"\")+\"ksana.js\";\n\tjsonp(url,appname,function(data){\n\t\tksana.js=data;\n\t\tksana.ready=true;\n\t});\n}\nmodule.exports=ksanagap;",
    "var started=false;\nvar timer=null;\nvar bundledate=null;\nvar get_date=require(\"./html5fs\").get_date;\nvar checkIfBundleUpdated=function() {\n\tget_date(\"bundle.js\",function(date){\n\t\tif (bundledate &&bundledate!=date){\n\t\t\tlocation.reload();\n\t\t}\n\t\tbundledate=date;\n\t});\n}\nvar livereload=function() {\n\tif (started) return;\n\n\ttimer1=setInterval(function(){\n\t\tcheckIfBundleUpdated();\n\t},2000);\n\tstarted=true;\n}\n\nmodule.exports=livereload;",
    "\nvar jsonp=function(url,dbid,callback,context) {\n  var script=document.getElementById(\"jsonp\");\n  if (script) {\n    script.parentNode.removeChild(script);\n  }\n  if (typeof dbid==\"function\") {\n    context=callback;\n    callback=dbid;\n    dbid=\"\";\n  }\n  window.jsonp_handler=function(data) {\n    //console.log(\"receive from ksana.js\",data);\n    if (typeof data==\"object\" && dbid) {\n      if (typeof data.dbid==\"undefined\") {\n        data.dbid=dbid;\n      }\n    }\n    callback.apply(context,[data]);\n  }\n\n  window.jsonp_error_handler=function() {\n    console.error(\"url unreachable\",url);\n    callback.apply(context,[null]);\n  }\n\n  script=document.createElement('script');\n  script.setAttribute('id', \"jsonp\");\n  script.setAttribute('onerror', \"jsonp_error_handler()\");\n  url=url+'?'+(new Date().getTime());\n  script.setAttribute('src', url);\n  document.getElementsByTagName('head')[0].appendChild(script); \n}\nvar runtime_version_ok=function(minruntime) {\n  if (!minruntime) return true;//not mentioned.\n  var min=parseFloat(minruntime);\n  var runtime=parseFloat( ksanagap.runtime_version()||\"1.0\");\n  if (min>runtime) return false;\n  return true;\n}\n\nvar needToUpdate=function(fromjson,tojson) {\n  var needUpdates=[];\n  for (var i=0;i<fromjson.length;i++) { \n    var to=tojson[i];\n    var from=fromjson[i];\n    var newfiles=[],newfilesizes=[],removed=[];\n    \n    if (!to) continue; //cannot reach host\n    if (!runtime_version_ok(to.minruntime)) {\n      console.warn(\"runtime too old, need \"+to.minruntime);\n      continue; \n    }\n    if (!from.filedates) {\n      console.warn(\"missing filedates in ksana.js of \"+from.dbid);\n      continue;\n    }\n    from.filedates.map(function(f,idx){\n      var newidx=to.files.indexOf( from.files[idx]);\n      if (newidx==-1) {\n        //file removed in new version\n        removed.push(from.files[idx]);\n      } else {\n        var fromdate=Date.parse(f);\n        var todate=Date.parse(to.filedates[newidx]);\n        if (fromdate<todate) {\n          newfiles.push( to.files[newidx] );\n          newfilesizes.push(to.filesizes[newidx]);\n        }        \n      }\n    });\n    if (newfiles.length) {\n      from.newfiles=newfiles;\n      from.newfilesizes=newfilesizes;\n      from.removed=removed;\n      needUpdates.push(from);\n    }\n  }\n  return needUpdates;\n}\nvar getUpdatables=function(apps,cb,context) {\n  getRemoteJson(apps,function(jsons){\n    var hasUpdates=needToUpdate(apps,jsons);\n    cb.apply(context,[hasUpdates]);\n  },context);\n}\nvar getRemoteJson=function(apps,cb,context) {\n  var taskqueue=[],output=[];\n  var makecb=function(app){\n    return function(data){\n        if (!(data && typeof data =='object' && data.__empty)) output.push(data);\n        if (!app.baseurl) {\n          taskqueue.shift({__empty:true});\n        } else {\n          var url=app.baseurl+\"/ksana.js\";    \n          console.log(url);\n          jsonp( url ,app.dbid,taskqueue.shift(), context);           \n        }\n    };\n  };\n  apps.forEach(function(app){taskqueue.push(makecb(app))});\n\n  taskqueue.push(function(data){\n    output.push(data);\n    cb.apply(context,[output]);\n  });\n\n  taskqueue.shift()({__empty:true}); //run the task\n}\nvar humanFileSize=function(bytes, si) {\n    var thresh = si ? 1000 : 1024;\n    if(bytes < thresh) return bytes + ' B';\n    var units = si ? ['kB','MB','GB','TB','PB','EB','ZB','YB'] : ['KiB','MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];\n    var u = -1;\n    do {\n        bytes /= thresh;\n        ++u;\n    } while(bytes >= thresh);\n    return bytes.toFixed(1)+' '+units[u];\n};\nvar humanDate=function(datestring) {\n    var d=Date.parse(datestring);\n    if (isNaN(d)) {\n      return \"invalid date\";\n    } else {\n      return new Date(d).toLocaleString();\n    }\n}\nvar start=function(ksanajs,cb,context){\n  var files=ksanajs.newfiles||ksanajs.files;\n  var baseurl=ksanajs.baseurl|| \"http://127.0.0.1:8080/\"+ksanajs.dbid+\"/\";\n  var started=ksanagap.startDownload(ksanajs.dbid,baseurl,files.join(\"\\uffff\"));\n  cb.apply(context,[started]);\n}\nvar status=function(){\n  var nfile=ksanagap.downloadingFile();\n  var downloadedByte=ksanagap.downloadedByte();\n  var done=ksanagap.doneDownload();\n  return {nfile:nfile,downloadedByte:downloadedByte, done:done};\n}\n\nvar cancel=function(){\n  return ksanagap.cancelDownload();\n}\n\nvar liveupdate={ humanFileSize: humanFileSize, humanDate:humanDate,\n  needToUpdate: needToUpdate , jsonp:jsonp, \n  getUpdatables:getUpdatables,\n  start:start,\n  cancel:cancel,\n  status:status\n  };\nmodule.exports=liveupdate;",
    "function mkdirP (p, mode, f, made) {\n     var path = nodeRequire('path');\n     var fs = nodeRequire('fs');\n\t\n    if (typeof mode === 'function' || mode === undefined) {\n        f = mode;\n        mode = 0x1FF & (~process.umask());\n    }\n    if (!made) made = null;\n\n    var cb = f || function () {};\n    if (typeof mode === 'string') mode = parseInt(mode, 8);\n    p = path.resolve(p);\n\n    fs.mkdir(p, mode, function (er) {\n        if (!er) {\n            made = made || p;\n            return cb(null, made);\n        }\n        switch (er.code) {\n            case 'ENOENT':\n                mkdirP(path.dirname(p), mode, function (er, made) {\n                    if (er) cb(er, made);\n                    else mkdirP(p, mode, cb, made);\n                });\n                break;\n\n            // In the case of any other error, just see if there's a dir\n            // there already.  If so, then hooray!  If not, then something\n            // is borked.\n            default:\n                fs.stat(p, function (er2, stat) {\n                    // if the stat fails, then that's super weird.\n                    // let the original error be the failure reason.\n                    if (er2 || !stat.isDirectory()) cb(er, made)\n                    else cb(null, made);\n                });\n                break;\n        }\n    });\n}\n\nmkdirP.sync = function sync (p, mode, made) {\n    var path = nodeRequire('path');\n    var fs = nodeRequire('fs');\n    if (mode === undefined) {\n        mode = 0x1FF & (~process.umask());\n    }\n    if (!made) made = null;\n\n    if (typeof mode === 'string') mode = parseInt(mode, 8);\n    p = path.resolve(p);\n\n    try {\n        fs.mkdirSync(p, mode);\n        made = made || p;\n    }\n    catch (err0) {\n        switch (err0.code) {\n            case 'ENOENT' :\n                made = sync(path.dirname(p), mode, made);\n                sync(p, mode, made);\n                break;\n\n            // In the case of any other error, just see if there's a dir\n            // there already.  If so, then hooray!  If not, then something\n            // is borked.\n            default:\n                var stat;\n                try {\n                    stat = fs.statSync(p);\n                }\n                catch (err1) {\n                    throw err0;\n                }\n                if (!stat.isDirectory()) throw err0;\n                break;\n        }\n    }\n\n    return made;\n};\n\nmodule.exports = mkdirP.mkdirp = mkdirP.mkdirP = mkdirP;\n"
  ]
}